{
    "search_index": {
        "description_for_embedding": "Fix macOS DMG bundle build failures on CI by patching dmgbuild to run hdiutil detach with sudo, preventing disk detach from hanging or corrupting the CI VM disk state.",
        "keywords": [
            "macOS bundle",
            "DMG build",
            "dmgbuild",
            "hdiutil detach",
            "sudo",
            "CI pipeline",
            "GitHub Actions",
            "Appveyor",
            "disk unmount hang",
            "patch_dmgbuild"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, macOS application bundle creation using dmgbuild was failing on CI environments (GitHub Actions, Appveyor). The DMG/disk detach step behaved erratically: the VM's disk manager would hang, terminal tab-completion against the mounted volume would freeze and crash, and the CI builds could not complete. The suspicion was that the DMG volume detach (via hdiutil) was misbehaving in these virtualized CI environments.\n\nTo investigate, the contributor used Appveyor's feature to pause the macOS build VM and connect via VNC, then manually inspected the system. They confirmed that tools interacting with the DMG volume (disk utility, lsof, shell autocompletion) would hang after the detach operation. Manually re-running the dmgbuild core commands revealed a critical detail: when the hdiutil detach command was run with sudo, the operation completed cleanly and did not destabilize the VM; without sudo, the system ended up in a broken state.\n\nThe project already had a runtime patch function, patch_dmgbuild(), that modified dmgbuild.core (originally to change max(total_size / 1024) to max(total_size / 1000)). The fix extended this patch: it now also replaces the line\n\n  all_args = ['/usr/bin/hdiutil', cmd]\n\nwith\n\n  all_args = ['sudo', '/usr/bin/hdiutil', cmd]\n\ninside dmgbuild.core. The patch only runs if the expected substrings are present, ensuring it targets the right dmgbuild version and isn't applied multiple times. This forces dmgbuild to run hdiutil via sudo for disk operations in the CI environment, which stabilizes the detach process and prevents the VM from hanging.\n\nThis change is recognized as a localized workaround: it's applied via a project-specific patch function rather than upstreaming directly to dmgbuild, because globally adding sudo in dmgbuild may not be appropriate for all users or environments. The team also discussed contributing the discovery upstream as an optional feature or configuration in dmgbuild so the local patch could eventually be removed.",
        "semantic_memory": "This case illustrates several generalizable lessons about dealing with build tooling, system utilities, and CI environments:\n\n1. **System utilities behave differently under virtualization and restricted environments**: Commands such as hdiutil (for mounting/unmounting DMGs on macOS) can behave differently in CI VMs than on a local developer machine, especially around permissions and device management. An operation that \"works\" locally may hang or corrupt state on CI.\n\n2. **Permissions can silently affect system-level operations**: Sometimes a command does not fail with a clear permission error; instead, it partially executes, leaving devices or volumes in a bad state. Running the same operation with elevated privileges (sudo) may resolve issues, but it's important to understand why and to limit elevation to where it is strictly necessary.\n\n3. **Runtime patching of third-party libraries can be a pragmatic workaround**: When a library (here, dmgbuild) does not yet support needed behavior (e.g., using sudo for specific system calls), a project can temporarily patch the library code at runtime to unblock CI. This should be done carefully, with explicit string checks to avoid double-patching or breaking new versions, and ideally accompanied by an upstream issue/PR.\n\n4. **Deep debugging in CI via remote access can be invaluable**: CI providers that allow pausing a job and connecting to the VM (e.g., via VNC or SSH) enable more thorough debugging than log inspection alone. This can reveal odd behaviors (like shell autocompletion freezing on specific paths) that hint at lower-level system problems.\n\n5. **Guarding patches with string checks/version assumptions**: When patching vendor code via text replacement, always guard the patch by checking for the exact substrings you expect. This ensures the patch only applies to known versions and is resistant to upstream changes, and makes the patch idempotent.\n\n6. **Plan to upstream and remove local hacks**: Local patches are technical debt. Whenever a workaround is discovered, consider how to upstream it (e.g., as configurable behavior) so the project can later rely on an official release rather than modifying library internals.",
        "procedural_memory": [
            "How to diagnose and fix hanging DMG detach in macOS CI builds using dmgbuild:",
            "Step 1: Confirm the symptom in CI",
            "Check your CI logs for steps around DMG creation and volume detach (typically hdiutil detach). Look for:\n- Steps that hang indefinitely or time out\n- Errors around volume unmount or device busy\n- Subsequent operations that fail without clear errors.",
            "Step 2: Reproduce interactively on the CI VM",
            "If your CI provider supports it (e.g., Appveyor's interactive VMs, GitHub Actions runner with SSH/VNC workarounds), pause or re-run the build in a mode that lets you connect to the macOS VM.\nOn the VM:\n- Run Disk Utility and inspect mounted volumes.\n- Use `mount`, `diskutil list`, and `lsof` to examine the DMG volume before and after the build step.",
            "Step 3: Manually run the dmgbuild / hdiutil commands",
            "Locate the commands that dmgbuild is executing for detach. You can:\n- Add logging or print statements around dmgbuild's core code, or\n- Look at dmgbuild's source (core.py) to see how it builds its hdiutil calls.\nThen, in the VM terminal, manually run:\n- The mount/create commands as dmgbuild runs them.\n- The detach commands both **with** and **without** sudo.\nObserve whether the system behaves differently (e.g., hang vs clean detach).",
            "Step 4: Determine whether permissions are the root cause",
            "If `hdiutil detach ...` without sudo leads to hangs, broken Disk Utility, or crashy shell behavior, but `sudo hdiutil detach ...` works cleanly, conclude that permission handling in the CI environment is problematic for non-sudo detach calls.",
            "Step 5: Implement a targeted runtime patch for dmgbuild",
            "In your project, create a function that patches dmgbuild.core after import, but before use:\n- Import dmgbuild.core.\n- Read the source file: `src = open(core.__file__).read()`.\n- Guard the patch by checking for expected substrings, e.g., `'max(total_size / 1024'` or `\"all_args = ['/usr/bin/hdiutil', cmd]\"`, to ensure you're modifying the right version.",
            "Step 6: Modify the hdiutil command to use sudo",
            "Apply a string replacement that wraps the hdiutil call in sudo. For example:\n- Replace:\n  `\"all_args = ['/usr/bin/hdiutil', cmd]\"`\n- With:\n  `\"all_args = ['sudo', '/usr/bin/hdiutil', cmd]\"`\nAlso keep any existing patches needed for your project (e.g., total_size / 1024 â†’ total_size / 1000). Write the modified contents back to core.__file__.",
            "Step 7: Ensure the patch is idempotent and version-safe",
            "Structure the patch to return early if the expected substrings are not present or already patched. For example:\n- If both `'max(total_size / 1024'` and `\"all_args = ['/usr/bin/hdiutil', cmd]\"` are not found, skip patching.\nThis avoids corrupting future dmgbuild versions or applying the patch more than once.",
            "Step 8: Re-run CI and verify stability",
            "Trigger your CI build again and confirm:\n- DMG creation completes successfully.\n- No hangs occur at detach.\n- Disk utility and shell behave normally afterwards.\nCheck logs to confirm that the patched dmgbuild is in use (e.g., print a message like `patched dmgbuild.core`).",
            "Step 9: Document and consider upstream contribution",
            "Document the workaround clearly in your repository (why sudo is used, which environments require it, and how it's patched). Then consider:\n- Opening an issue or PR in dmgbuild to make sudo usage configurable (e.g., via a flag or context-specific behavior),\n- Planning to remove your runtime patch once an upstream fix is released and your dependency is updated."
        ]
    }
}