{
    "search_index": {
        "description_for_embedding": "Home Assistant emulated_hue: lock entities exposed via emulated Hue could not be controlled because generic turn_on/turn_off services were not translated to lock/unlock. The fix adds domain-specific handling in hue_api.py to map Hue on/off commands to lock.unlock and lock.lock services, and imports the lock domain correctly.",
        "keywords": [
            "Home Assistant",
            "emulated_hue",
            "Hue API",
            "lock domain",
            "SERVICE_TURN_ON",
            "SERVICE_TURN_OFF",
            "SERVICE_LOCK",
            "SERVICE_UNLOCK",
            "domain-specific service mapping",
            "integration bug"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, Home Assistant's emulated_hue integration allowed `lock` entities to be exposed by setting `emulated_hue_hidden: false`, but when a Hue client (e.g., Alexa/Google Home via emulated Hue) tried to control these locks, nothing meaningful happened. The emulated_hue API layer translated Hue on/off commands into Home Assistant's generic `homeassistant.turn_on`/`homeassistant.turn_off` semantics for some domains (lights, media_player, cover, etc.), but there was no branch to handle the `lock` domain. As a result, the system received 'turn_on'/'turn_off' for a lock entity, which the lock domain doesn't interpret as lock/unlock actions.\n\nThe fix was implemented in `homeassistant/components/emulated_hue/hue_api.py`. The developer imported the `lock` component module and the `SERVICE_LOCK` and `SERVICE_UNLOCK` constants. Inside the `put` handler (which processes state changes from the Hue API), they added a new conditional branch: when `entity.domain == lock.DOMAIN`, the code sets `domain = entity.domain` and translates `SERVICE_TURN_ON` into `SERVICE_UNLOCK` and any other service (i.e., effectively `SERVICE_TURN_OFF`) into `SERVICE_LOCK`. This mirrors how covers are handled (mapping on/off to open/close) but for locks.\n\nInitially, the patch also imported several unused lock-related constants (`ATTR_CODE`, `ATTR_CODE_FORMAT`, `STATE_LOCKED`, `STATE_UNLOCKED`, `SERVICE_OPEN`), which triggered linting issues. After feedback, the developer removed the unused imports and relied solely on the needed constants (`SERVICE_LOCK`, `SERVICE_UNLOCK`) and imported the `lock` module for `lock.DOMAIN`. The change ensures that when a Hue device sends an on/off command for a lock entity, emulated_hue correctly calls `lock.unlock` or `lock.lock` in Home Assistant.",
        "semantic_memory": "This case illustrates a common integration pattern and pitfall when bridging between a generic control API and domain-specific services in a home automation or microservice architecture.\n\n1. **Domain-specific mapping from generic actions**: Many external APIs (like Hue's on/off semantics) expose generic commands that must be translated into domain-specific actions. For example:\n   - Light: on/off → light.turn_on / light.turn_off\n   - Media player: on/off → media_player.turn_on / media_player.turn_off, or play/pause\n   - Cover: on/off → cover.open_cover / cover.close_cover\n   - Lock: on/off → lock.unlock / lock.lock\n\n   Failing to implement this mapping for a domain leads to silent no-op behavior even when entities are visible and apparently \"supported\".\n\n2. **Visibility vs. operability**: Exposing an entity (via configuration flags like `emulated_hue_hidden: false`) doesn't guarantee that actions on that entity are handled. Both discovery/exposure and action-handling paths must be implemented. Bugs can occur when a new domain is made exposable without adding the corresponding control logic.\n\n3. **Centralized translation layer**: Systems often have one central translation layer (here, `hue_api.py`) that routes requests from an external protocol to internal service calls. Extending support to new domains requires updating this central router with domain checks and mapping logic.\n\n4. **Using domain constants instead of magic strings**: The fix properly uses `lock.DOMAIN`, `SERVICE_LOCK`, and `SERVICE_UNLOCK` instead of hard-coded strings. This improves maintainability and avoids subtle typos.\n\n5. **Linting/formatting feedback loop**: Adding imports and not using them triggered lint errors. The resolution was to keep imports minimal and run automatic formatters like `black` from the project root. This demonstrates the importance of aligning with repository tooling and style to get CI checks passing.\n\nMore generally, whenever an integration says \"entity type X is supported\" but commands don't work, it's often because there's no domain-specific service mapping in the translation layer.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce and characterize the behavior.\n- Expose the target entity type (e.g., a lock) through the integration (e.g., emulated_hue).\n- From an external client (e.g., a Hue-compatible app, voice assistant), send basic on/off commands.\n- Observe whether the entity appears in discovery but fails to respond to commands, or if logs show unhandled or generic service calls.",
            "Step 2: Inspect the translation/router layer.\n- Identify the module responsible for translating external API calls into internal actions (here, `hue_api.py`).\n- Look for the main request handler (e.g., `put` or `handle_*` methods) that processes state changes or commands.\n- Review any existing domain-specific branches (e.g., `if entity.domain == cover.DOMAIN:`) to understand how other domains are handled.",
            "Step 3: Check domain-specific mappings.\n- Confirm whether the domain of the problematic entity (e.g., `lock`) is checked anywhere in the translation logic.\n- If not present, determine the desired mapping from generic commands (on/off, open/close) to domain-specific services:\n  - For locks: SERVICE_TURN_ON → SERVICE_UNLOCK, SERVICE_TURN_OFF → SERVICE_LOCK.\n  - For covers: SERVICE_TURN_ON → open_cover, SERVICE_TURN_OFF → close_cover, etc.\n- Identify the correct service constants and domain constants from the relevant component module (e.g., `homeassistant.components.lock`).",
            "Step 4: Implement the new domain mapping.\n- Import the component/module for the domain and any necessary service constants, using existing patterns as a guide:\n  - `from homeassistant.components import lock`\n  - `from homeassistant.components.lock import SERVICE_LOCK, SERVICE_UNLOCK`\n- In the main handler, add a conditional branch for the new domain, for example:\n  - `elif entity.domain == lock.DOMAIN:`\n    - `domain = entity.domain`\n    - `if service == SERVICE_TURN_ON: service = SERVICE_UNLOCK`\n    - `else: service = SERVICE_LOCK`\n- Ensure that you use constants (e.g., `lock.DOMAIN`, `SERVICE_LOCK`) instead of hard-coded strings.",
            "Step 5: Clean up imports and run linters/formatters.\n- Remove any unused imports (e.g., attributes or state constants that you ended up not using) to avoid lint errors.\n- Run the project's formatting and linting tools locally (e.g., `black --fast homeassistant tests`, plus any configured linters like flake8 or pylint).\n- Fix any reported issues until local checks pass cleanly.",
            "Step 6: Test end-to-end.\n- Restart the application/integration and retest from the external client.\n- Verify that:\n  - The entity is still discovered and visible.\n  - On commands result in the correct domain-specific action (e.g., lock is unlocked).\n  - Off commands result in the opposite action (e.g., lock is locked).\n- Monitor logs for errors or unhandled services.",
            "Step 7: Add or update tests (if applicable).\n- If the project has tests for the translation layer, add unit tests to cover the new domain mapping.\n- For example, simulate a Hue on/off request against a mock lock entity and assert that `lock.unlock`/`lock.lock` get called.\n- Run the full test suite and verify that all tests pass.",
            "Step 8: Document or note the supported behavior.\n- If the integration has user-facing documentation, update it to mention that lock entities exposed via emulated Hue are now controllable.\n- Internally, note the pattern so that future domain additions follow the same mapping approach."
        ]
    }
}