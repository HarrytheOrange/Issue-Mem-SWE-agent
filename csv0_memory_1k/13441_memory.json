{
    "search_index": {
        "description_for_embedding": "Home Assistant Mastodon notify platform: initial implementation validated Mastodon credentials in get_service and returned None on authentication failure so the platform was not created. A refactor moved login into the service class constructor, which swallowed authentication errors and always returned a service object, even with invalid credentials. The fix reverted the refactor and restored credential validation in get_service, returning None when auth fails.",
        "keywords": [
            "Home Assistant",
            "notify",
            "mastodon",
            "Mastodon.py",
            "authentication failure",
            "account_verify_credentials",
            "get_service",
            "return None on error",
            "integration setup",
            "BaseNotificationService"
        ]
    },
    "agent_memory": {
        "episodic_memory": "A new notification platform for Home Assistant was added to send messages via Mastodon using the Mastodon.py library. The initial implementation in mastodon.py defined REQUIREMENTS, configuration keys (access_token, client_id, client_secret, base_url), and a MastodonNotificationService that used Mastodon.toot to send messages. In get_service, the integration instantiated Mastodon with the provided credentials, called account_verify_credentials, and if a MastodonUnauthorizedError was raised, logged 'Authentication failed' and returned None. This pattern ensured that the notify.mastodon platform would not be created when credentials were invalid.\n\nA subsequent commit ('Move login') attempted to move the login logic into the MastodonNotificationService constructor. get_service was simplified to always instantiate MastodonNotificationService with the raw credentials (client_id, client_secret, access_token, base_url), and the service's __init__ created a Mastodon client and called account_verify_credentials inside a try/except. On MastodonUnauthorizedError it only logged 'Authentication failed' but did not indicate failure to get_service. As a result, get_service always returned a service instance, even when authentication failed. This violated Home Assistant's expectation that get_service should return None if the platform cannot be initialized, and a reviewer (pvizeli) pointed out that before it failed on wrong auth data, but now it always returns an object.\n\nTo fix this behavioral regression, the 'Move login' commit was fully reverted. The final code again performs authentication in get_service, catching MastodonUnauthorizedError and returning None so the platform is not set up with invalid credentials. MastodonNotificationService reverted to a thin wrapper that takes an already-authenticated Mastodon API object and uses it in send_message. This restored the correct failure behavior on bad auth while keeping the new Mastodon notify functionality.",
        "semantic_memory": "When implementing service integrations (like notification platforms, components, or clients) that depend on external authentication, the factory or setup function responsible for creating the service should explicitly fail and return a sentinel (e.g., None) when authentication or configuration is invalid. This allows the surrounding framework to treat the integration as not set up, rather than leaving a partially initialized or non-functional object in place.\n\nMoving authentication logic into an object's constructor without propagating failures can cause the factory to always return an instance, even when credentials are wrong or the connection cannot be established. If the constructor only logs errors and does not raise or signal failure, callers cannot detect the failure and may falsely assume that the service is working. In systems like Home Assistant, the contract for get_service/get_component is: return a valid, functional service object or None if setup failed. Violating this contract leads to confusing behavior where configuration errors appear as silent runtime failures.\n\nA robust pattern is:\n- Validate configuration and perform basic connectivity/auth checks in the setup/factory function (or ensure the constructor raises on failure and the factory propagates that failure).\n- If validation fails, return None and log a clear error or warning.\n- Only create and expose service instances that have passed authentication/verification.\n- In service methods (e.g., send_message), catch and log transient API errors (e.g., MastodonAPIError), but do not hide fundamental setup/auth problems.\n\nThis case exemplifies the importance of honoring framework contracts (like Home Assistant's get_service) and not turning hard setup failures into soft, logged-only errors inside constructors.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Understand the framework contract. For a platform or integration factory (e.g., Home Assistant's get_service or setup_platform), confirm what it should return on success vs. failure. Typically it must return a fully functional service object or None on failure.",
            "Step 2: Reproduce the issue with invalid credentials. Configure the integration with known-bad auth data (wrong token, client_id, or client_secret) and observe whether the framework still registers the service. If the service appears available despite bad credentials, you likely have a setup/factory contract violation.",
            "Step 3: Inspect where authentication is performed. Check whether auth/login and credential verification are done in the factory/setup function or inside the service class constructor/methods. Look for code paths that catch authentication exceptions but do not signal the failure back to the caller.",
            "Step 4: Check error handling behavior. Verify if authentication exceptions (e.g., MastodonUnauthorizedError, 401/403 errors) are only logged and then swallowed. If the factory or constructor catches these errors but still returns an object, that is a red flag.",
            "Step 5: Move or restore auth validation to setup/factory. Ensure that credential verification happens in the factory/setup function (or that the constructor raises on failure and the factory handles that). In Home Assistant-style integrations, instantiate the external client, call a verification method (e.g., account_verify_credentials), and wrap this in a try/except block there.",
            "Step 6: Return None on authentication failure. In the exception handler for auth failures, log a clear warning or error (e.g., 'Authentication failed') and return None from get_service/setup_platform so the integration is not created when credentials are invalid.",
            "Step 7: Keep service classes thin and assume valid clients. Have the service class (e.g., MastodonNotificationService) accept an already-authenticated API/client object. Its methods (like send_message) should handle operational errors (e.g., MastodonAPIError) with try/except, logging failures but not masking fundamental setup issues.",
            "Step 8: Re-run tests with both valid and invalid credentials. Verify that with valid credentials, the service is created and works; with invalid credentials, the factory returns None, the integration is not registered, and the log contains a clear auth error.",
            "Step 9: Review future refactors carefully. When refactoring login or initialization code (e.g., moving logic into __init__), ensure that you preserve the behavior that failed setups do not yield active service instances. Add tests that assert the factory returns None on invalid configuration to prevent regressions."
        ]
    }
}