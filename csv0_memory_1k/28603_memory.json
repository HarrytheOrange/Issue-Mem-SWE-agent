{
    "search_index": {
        "description_for_embedding": "Home Assistant Almond integration now auto-configures Almond Web to connect back to Home Assistant when a remote/external URL is available. Introduces a network helper to determine an external URL (preferring cloud remote UI or public base_url, ignoring local IPs), delays Almond configuration until after startup when cloud URLs are ready, and skips configuration for hass.io-managed Almond.",
        "keywords": [
            "Almond integration",
            "Almond Web",
            "Home Assistant",
            "async_get_external_url",
            "network helper",
            "remote URL",
            "external URL",
            "cloud.async_remote_ui_url",
            "EVENT_HOMEASSISTANT_START",
            "CoreState.not_running",
            "config_entry",
            "OAuth2 integration",
            "hassio",
            "long-lived access token",
            "io.home-assistant device",
            "startup delay",
            "is_local IP detection"
        ]
    },
    "agent_memory": {
        "episodic_memory": "This change enhances the Home Assistant Almond integration so that Almond Web can automatically connect back to the Home Assistant instance, but only when the instance is accessible via a remote URL. Previously, Almond's configuration did not distinguish between local-only and externally reachable URLs, and it could attempt to set up the connection at startup before the cloud remote UI URL was available.\n\nThe fix introduces a new helper, homeassistant.helpers.network.async_get_external_url, which determines a suitable external URL for Home Assistant. It first checks whether the cloud component is loaded and, if so, tries cloud.async_remote_ui_url(). If cloud is not available or raises CloudNotAvailable, the helper falls back to hass.config.api.base_url, but only if it is not a local IP (detected via homeassistant.util.network.is_local on the host part of the URL). If the URL is local or no API/base_url exists, the helper returns None.\n\nIn homeassistant/components/almond/__init__.py, async_setup_entry is updated to:\n- Create a WebAlmondAPI and an AlmondAgent as before.\n- Skip auto-configuration if the entry is marked as is_hassio, because Hass.io handles Almond configuration itself.\n- For non-hassio entries:\n  - If Home Assistant is already running or the Almond config entry type is TYPE_LOCAL, immediately call _configure_almond_for_ha.\n  - If Home Assistant is still starting (CoreState.not_running) and the type is not local (i.e., OAuth2-based), delay configuration: listen to EVENT_HOMEASSISTANT_START, then schedule _configure_almond_for_ha to run 30 seconds later via event.async_call_later. This accounts for the known delay before cloud.async_remote_ui_url becomes available after boot.\n\nThe new _configure_almond_for_ha function:\n- For TYPE_OAUTH2 entries, obtains hass_url via network.async_get_external_url(hass). If this returns None (not externally accessible), it exits without configuring Almond to connect to HA.\n- For local-type entries, uses hass.config.api.base_url directly as hass_url.\n- If hass_url is available, it prepares a long-lived access token for Almond, persists the mapping in storage (STORAGE_KEY 'almond'), and calls WebAlmondAPI.async_create_device with a 'io.home-assistant' device configuration that includes hassUrl, the access token, and a far-future expiration timestamp. The timeout for this request is increased from 10 seconds to 30 seconds to handle slower remote calls.\n\nThe change also ensures that only one long-lived access token is kept per Almond entry: if a new token is created, any old token stored in the config entry is removed. The AlmondAgent class is updated with explicit type annotations for its config entry parameter.\n\nComplementary tests were added:\n- tests/helpers/test_network.py verifies async_get_external_url behavior with local IP base_url, non-local hostname, and cloud remote URL (including CloudNotAvailable handling and override by nabu.casa URL).\n- tests/components/almond/test_init.py covers several scenarios:\n  * OAuth2 with an external URL: after EVENT_HOMEASSISTANT_START and the configured delay, async_create_device is called once.\n  * OAuth2 with no external URL: Almond is set up as a conversation agent but async_create_device is never called.\n  * Hass.io entry: no creation of the Home Assistant device in Almond.\n  * Local Almond: async_create_device is called immediately because local connections don't rely on an external URL.\n\nAdditionally, strings.json gained a missing user-facing title for the 'pick_implementation' configuration step (\"Pick Authentication Method\"), and the AlmondAgent constructor now declares the config entry type explicitly.",
        "semantic_memory": "Key lessons and patterns from this change center around safe and reliable configuration of integrations that depend on an externally reachable URL and/or cloud services:\n\n1. **External URL resolution should be centralized and context-aware**:\n   - When deciding what URL to expose to third-party services, use a dedicated helper that encapsulates logic about local vs public addresses and cloud-based remote URLs.\n   - External URLs should not be local IPs (e.g., 192.168.x.x, 10.x.x.x). A helper like async_get_external_url can check if an IP is local and reject it, returning None when no suitable external URL exists.\n   - Prefer a cloud-provided remote URL (e.g., nabu.casa) when available, and fall back to a configured public base_url otherwise.\n\n2. **Startup timing matters when depending on cloud/remote URLs**:\n   - Some runtime information (like a cloud remote UI URL) may not be available immediately when the core is starting up; it can appear only after a certain delay or after specific events.\n   - Integrations that depend on such URLs should delay their configuration logic until both the core is running and any cloud components have initialized. This can be done by listening to lifecycle events such as EVENT_HOMEASSISTANT_START and then scheduling setup after a small delay.\n\n3. **Different deployment modes require different setup behavior**:\n   - The same integration can behave differently in Hass.io (managed environment) vs a standard install. In managed environments, certain configuration should be skipped because an external orchestrator handles it.\n   - OAuth2 or cloud-based integrations may require external URLs, whereas purely local configurations can use an internal base_url directly.\n\n4. **Use long-lived tokens carefully for external integrations**:\n   - When granting integrations an access token, use long-lived tokens and store their IDs to manage lifecycle.\n   - When creating a new token for a given integration instance, clean up any previously associated tokens to avoid accumulating stale credentials.\n\n5. **Tests should cover timing, environment, and URL conditions**:\n   - For behavior that depends on core state (running vs starting), time delays, and presence/absence of components like cloud, tests should explicitly simulate these conditions.\n   - Mocking cloud.async_remote_ui_url, config_entry implementations, and system time (for delayed callbacks) allows deterministic validation of startup and configuration behavior.\n\nOverall, the pattern is: use a dedicated network helper to choose a safe external URL, gate setup logic on environment and runtime state, and encapsulate remote integration setup (token creation, device registration) in a well-defined helper function that can be invoked immediately or scheduled later.",
        "procedural_memory": [
            "How to safely configure an integration that needs an external URL and may depend on cloud services at startup:",
            "Step 1: Introduce a URL resolution helper",
            "Create a helper function (e.g., async_get_external_url(hass)) that encapsulates the logic for selecting an external URL:\n- Check if the cloud component is loaded; if yes, try cloud.async_remote_ui_url(). Handle CloudNotAvailable exceptions gracefully.\n- If cloud is unavailable or fails, fall back to hass.config.api.base_url if it exists.\n- Parse the host portion of the URL and treat it as invalid for external use if it is a local IP (use ipaddress.ip_address + a local-check helper, such as is_local). In that case, return None.\nThis ensures that anything using this helper only gets a valid external URL or None.",
            "Step 2: Separate local and remote configuration paths",
            "Within your integration's setup (async_setup_entry), determine the integration mode (e.g., local vs OAuth2/cloud):\n- For local setups, use hass.config.api.base_url directly to configure the remote service, because external reachability is not needed.\n- For OAuth2/cloud-based setups that must be reachable from the internet, use the external URL helper; if it returns None, skip external configuration instead of failing setup.",
            "Step 3: Respect managed environments like Hass.io",
            "If your integration can be managed by an external orchestrator (e.g., Hass.io), mark such entries (e.g., data['is_hassio'] = True) and avoid running your own auto-configuration logic. Only set up local agents/services, and leave device registration or URL configuration to the orchestrator.",
            "Step 4: Handle core startup state and delayed availability",
            "Check the Home Assistant core state in async_setup_entry:\n- If hass.state is not CoreState.not_running (core already running) or your integration does not depend on cloud URLs, perform configuration immediately.\n- If hass.state is CoreState.not_running and you depend on values that appear later (e.g., cloud remote URLs), delay your configuration:\n  * Listen for EVENT_HOMEASSISTANT_START.\n  * In the event handler, schedule your configuration helper via event.async_call_later(hass, delay_seconds, callback), where delay_seconds (e.g., 30) is enough for the cloud component to initialize.",
            "Step 5: Encapsulate remote service configuration in a helper",
            "Implement a dedicated function (e.g., _configure_almond_for_ha) which:\n- Determines the appropriate URL (external or local) as per the integration type.\n- Returns early if no suitable URL exists.\n- Handles creation or retrieval of access tokens (e.g., long-lived tokens), stores mapping data (e.g., in storage.Store), and cleans up old tokens.\n- Calls the remote API (e.g., async_create_device) with a generous timeout appropriate for network calls (e.g., 30 seconds instead of 10).",
            "Step 6: Manage long-lived access tokens lifecycle",
            "When granting external services access to Home Assistant:\n- Use hass.auth.async_create_long_lived_access_token(user, comment) and store both token string and refresh token id somewhere persistent (e.g., in a config entry or storage).\n- On reconfiguration, create a new long-lived token if needed and, if an old token id exists and differs, call hass.auth.async_remove_refresh_token(old_token) to avoid stale tokens.\nThis creates a clean mapping between integration instance and token.",
            "Step 7: Add tests covering URL types, startup timing, and modes",
            "Write tests to confirm behavior in various scenarios:\n- Local IP base_url returns None from async_get_external_url; public hostname returns the URL.\n- When cloud is loaded but raises CloudNotAvailable, the helper falls back to base_url.\n- When cloud provides a remote URL, it overrides the base_url.\n- OAuth2-based entries with an external URL cause async_create_device (or equivalent) to be called once after EVENT_HOMEASSISTANT_START and the configured delay.\n- OAuth2-based entries with no external URL lead to no external device registration but still load the config entry.\n- Entries marked as hassio skip external configuration.\n- Local entries trigger immediate remote device configuration without waiting for startup events.",
            "Step 8: Keep types and user-facing strings consistent",
            "Ensure constructors and function signatures have accurate type annotations (e.g., AlmondAgent receives a config_entries.ConfigEntry) and that configuration flows have complete localization strings for all steps (e.g., titles like \"Pick Authentication Method\")."
        ]
    }
}