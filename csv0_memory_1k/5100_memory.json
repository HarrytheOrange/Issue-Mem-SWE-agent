{
    "search_index": {
        "description_for_embedding": "StackStorm migration to Python 3-only: removed the functional --python3 pack install option and all Python-3-specific virtualenv/config paths, while keeping the CLI flag as a backward-compatible no-op that emits a deprecation warning. Simplified pack download/installation code to assume a single Python runtime.",
        "keywords": [
            "StackStorm",
            "pack install",
            "--python3 flag",
            "Python 2 deprecation",
            "Python 3 migration",
            "virtualenvs",
            "pack_management",
            "sandboxing",
            "API schema change",
            "backward compatibility",
            "deprecation warning"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this change set, StackStorm completed its migration to a Python 3-only runtime and cleaned up legacy support for dual Python 2/3 pack environments.\n\nPreviously, packs could be installed with a `--python3` flag (and `use_python3` parameters internally) to explicitly create Python 3 virtualenvs while the core platform was still Python 2. There were corresponding configuration options (`actionrunner.python3_binary`, `actionrunner.python3_prefix`), Python 3 base requirements (`BASE_PACK_PYTHON3_REQUIREMENTS`), logic to detect whether a pack virtualenv used Python 3 (`is_pack_virtualenv_using_python3`), and special handling in sensor process spawning to forbid Python 3 virtualenvs under a Python 2 sensor runner.\n\nOnce the platform became Python 3-only, this dual-runtime path became unnecessary and potentially misleading. The intent of the issue was to remove the `--python3` option and all associated config/behavior. However, discussion surfaced a compatibility concern: many users, trying to proactively adopt Python 3, had baked `st2 pack install ... --python3` into their deployment scripts. Completely removing the CLI flag would cause those scripts to fail with an unknown-argument error.\n\nThe implemented fix balanced cleanup with backward compatibility:\n\n1. **Server-side & internal cleanup**\n   - Removed `python3` and `use-python3` flags from actions and internal commands:\n     - `contrib/packs/actions/download.yaml`, `install.meta.yaml`, `setup_virtualenv.yaml`, workflow `install.yaml` no longer accept a `python3` parameter.\n     - `pack_mgmt.download.DownloadGitRepoAction.run()` and `pack_mgmt.setup_virtualenv.run()` dropped the `python3` argument and no longer pass `use_python3` through.\n     - CLI utilities `st2common/cmd/download_pack.py`, `st2common/cmd/install_pack.py`, and `st2common/cmd/setup_pack_virtualenv.py` removed their `--use-python3` / `--python3` CLI options and stopped passing `use_python3` to underlying functions.\n   - Configuration cleanup:\n     - Removed `actionrunner.python3_binary` and `actionrunner.python3_prefix` from `st2common/config.py`, `st2.conf.sample`, and `tools/config_gen.py`. The platform now uses a single `python_binary` (Python 3) for all pack virtualenvs.\n   - Pack management simplification:\n     - `download_pack()` no longer accepts a `use_python3` parameter and removed the guard that required a configured Python 3 binary.\n     - `verify_pack_version()` no longer takes `use_python3` and now only checks the currently running Python version versus `python_versions` in pack metadata. It removed special logic that allowed overriding Python 3 requirements with `--python3` under Python 2, or error messaging around using `--python3` with a Python 2-only pack.\n   - Virtualenv management simplification:\n     - `setup_pack_virtualenv()` and `create_virtualenv()` no longer take `use_python3`. They always use `cfg.CONF.actionrunner.python_binary` (now Python 3) when invoking `virtualenv -p`.\n     - Removed Python-3-specific base requirements (`BASE_PACK_PYTHON3_REQUIREMENTS`) and their installation step.\n   - Sandboxing and sensor behavior:\n     - Removed `is_pack_virtualenv_using_python3()` and all related logic from `sandboxing.py`. The Python path construction for Python runner actions now assumes a single runtime and no longer inspects the venv for `python3.*` directories or consults `python3_prefix`.\n     - In `st2reactor/container/process_container.py`, removed the error path that would reject sensors whose packs used Python 3 virtualenvs when the platform itself was Python 2. With the platform now Python 3-only, this branch is obsolete.\n   - API schema updates:\n     - `PackInstallRequest` in `openapi.yaml` and `openapi.yaml.j2` no longer includes the `python3` boolean field.\n   - Error message cleanup:\n     - Removed `PACK_VIRTUALENV_USES_PYTHON3` from `st2common/constants/error_messages.py` and its use in the reactor container.\n\n2. **Client-side backward compatibility**\n   - The CLI command `st2 pack install` originally had its `--python3` option removed, but was reintroduced as a no-op flag to avoid breaking existing scripts.\n   - In `st2client/st2client/commands/pack.py`:\n     - The parser again accepts `--python3` as a boolean flag, but the `PackResourceManager.install()` method no longer accepts or forwards any `python3` argument to the API.\n     - When `--python3` is provided, the CLI now emits a deprecation warning using `warnings.warn`: `DEPRECATION WARNING: --python3 flag is ignored and will be removed in v3.5.0 as StackStorm now runs with python3 only`.\n     - The warning is emitted after pack content counts are displayed but before the install call is made, so it is visible in typical CLI usage and tests, but the install semantics are unchanged.\n\n3. **Tests and documentation**\n   - Unit tests were updated to match the simplified behavior:\n     - `contrib/packs/tests/test_action_download.py` was restored and updated; tests that depended on `python3=True` pack install behavior were removed or simplified so that Python version compatibility is now only determined by the running interpreter and pack metadata, not by a flag.\n     - `st2common/tests/unit/test_util_sandboxing.py` removed tests that verified Python 3-aware PYTHONPATH construction; remaining tests validate basic sandbox path behavior under a single runtime.\n     - `st2common/tests/unit/test_virtualenvs.py` removed tests around selecting Python 2 vs Python 3 binaries and installing Python-3-only base requirements.\n   - The change log was updated to document removal of the `--python3` option (functionally), with attribution to the contributor.\n\nOverall, the incident was that a hard removal of `--python3` and Python 3-specific infra would break users who were already using `--python3` correctly in automation. The resolution was to remove all internal dual-runtime support while keeping the `--python3` CLI flag as a harmless no-op with a clear deprecation warning and a planned removal version (v3.5.0).",
        "semantic_memory": "This change illustrates several generalizable patterns for platform migrations and interface deprecations:\n\n1. **One runtime becomes the default, dual-support can be removed**\n   - When a platform standardizes on a single runtime (e.g., Python 3), dual-path logic (Python 2 vs Python 3 virtualenvs) becomes technical debt.\n   - It is beneficial to remove configuration keys and code branches that exist solely to support an obsolete runtime (e.g., `python3_binary`, `python3_prefix`, `use_python3`). This reduces complexity, potential bugs, and cognitive overhead.\n   - Virtualenv creation is simplified to always target the single supported interpreter, and pack metadata compatibility checks only need to consider the running interpreter version, not a requested override.\n\n2. **Maintain backward compatibility for CLI flags even when they become no-ops**\n   - Users often encode CLI flags in scripts and deployment pipelines. Removing a CLI flag outright (e.g., `--python3`) causes immediate failures even if the flag is conceptually redundant in the new architecture.\n   - A better approach is to:\n     - Keep the flag in the CLI parser.\n     - Make it a no-op in behavior.\n     - Emit a clear deprecation warning explaining that it is ignored and specifying when it will be removed.\n   - This pattern respects existing automation and gives users a controlled window to update their scripts.\n\n3. **Decouple API schema from deprecated client flags**\n   - The server-side API should not accept parameters that no longer have semantic meaning. Removing the `python3` field from the pack install API schema ensures the server has a clear, simplified contract: all packs are installed for the single runtime.\n   - The client can still accept legacy flags locally and map them to a behavior (like warning), without polluting the server contract.\n\n4. **Avoid runtime-dependent behavior in long-lived processes when the runtime is fixed**\n   - Prior logic prevented sensors from running if their pack virtualenv used Python 3 and the platform was Python 2. Once the platform is Python 3-only, such checks are obsolete and should be removed. Keeping them would introduce dead code and confusion.\n\n5. **Test suite evolution**\n   - When removing a feature (like Python 3-specific virtualenv logic in a mixed-runtime environment), tests that assert that behavior must be removed or adapted.\n   - Retaining outdated tests can mislead future maintainers into thinking old behavior is still supported.\n\n6. **Communicating deprecation with specific versions**\n   - Including a concrete removal version in the warning (`will be removed in v3.5.0`) gives users a clear timeline and anchors internal planning.\n\n7. **Error messages aligned with current architecture**\n   - With a single Python runtime, compatibility errors are expressed in terms of the current interpreter version vs. pack metadata, without referencing now-defunct override flags (e.g., `--python3`) or mixed-runtime setups.\n\nIn general, this PR demonstrates a best practice for evolving a public CLI/API: internally simplify aggressively when architecture changes (e.g., single runtime), but preserve client-facing compatibility with clear, time-bound deprecations.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues involving deprecating runtime-specific flags and dual-runtime support while maintaining backward compatibility.",
            "Step 1: Identify obsolete runtime paths and config\n- Audit code for flags, configuration options, and branches that exist solely to support a now-obsolete runtime (e.g., Python 2 vs Python 3 options).\n- Search for flags like `--python3`, config keys like `python3_binary`, and functions that detect or switch behavior based on multiple runtimes.\n- Note where these are part of the public API (REST schema, CLI interfaces) vs internal implementation.",
            "Step 2: Decide on the compatibility strategy for public interfaces\n- For REST APIs: prefer to remove obsolete fields from the schema, especially if they no longer affect behavior. Clearly document this in API changelogs.\n- For CLI flags: if you believe users may have automated scripts that use a now-redundant flag, keep the flag in the CLI parser but:\n  - Stop passing it through to backend APIs.\n  - Emit a deprecation warning explaining that the flag is ignored and giving a target removal version.\n- If you have strong evidence the flag is unused, you may consider outright removal, but understand it is a breaking change.",
            "Step 3: Simplify internal logic and configuration\n- Remove internal parameters that toggle between runtimes (e.g., `use_python3`) from functions such as `download_pack()`, `setup_pack_virtualenv()`, and `create_virtualenv()`.\n- Ensure that virtualenv creation always uses the single supported runtime's binary (`python_binary`) and that you do not depend on `python3_binary` or similar.\n- Remove runtime-specific base requirements lists and installation steps that were only needed to support a second interpreter.\n- Clean up configuration modules and sample configs to remove obsolete options, and adjust any tools that generate config files.",
            "Step 4: Update runtime compatibility checks\n- In any place where you validate pack or plugin compatibility (e.g., based on `python_versions` in metadata):\n  - Simplify checks to compare the currently running interpreter (e.g., `CURRENT_PYTHON_VERSION`, `six.PY2/PY3`) to the metadata.\n  - Remove logic that attempts to \"override\" these checks based on a user-specified runtime flag (`--python3`).\n  - Ensure error messages reflect the current architecture: they should mention only the actual running runtime, not deprecated flags.",
            "Step 5: Remove behavior branches that are no longer possible\n- Identify long-lived processes (e.g., sensor containers, runners) that had special cases for mixed-runtime setups.\n- Remove branches that are now impossible under the new architecture (e.g., 'if virtualenv is Python 3 but platform is Python 2').\n- Delete associated error messages and constants to avoid dead code.",
            "Step 6: Adjust and prune tests\n- Update unit and integration tests to align with the new single-runtime behavior:\n  - Remove tests that assert behavior for a deprecated flag (e.g., `python3=True` causing specific virtualenv behavior) or dual-runtime combinations.\n  - Keep tests that verify pure runtime compatibility based on metadata and the current interpreter.\n- Add tests that ensure the CLI still accepts the deprecated flag but simply emits a warning and behaves identically otherwise.\n- Run the full test suite and ensure no tests rely on removed config keys or functions.",
            "Step 7: Implement and verify CLI deprecation warning behavior\n- In the CLI command implementation, after parsing arguments but before executing the main logic:\n  - Check if the deprecated flag is set.\n  - Call `warnings.warn()` with a concise, actionable message, including the target removal version.\n- Test the CLI manually or via automation to confirm the warning is visible and the command still succeeds when that flag is provided.",
            "Step 8: Update documentation and changelog\n- Document the change in the project's changelog, including:\n  - The fact that internal Python 2/3 dual-runtime support and Python 3-specific options were removed.\n  - That the CLI `--python3` flag is now a deprecated no-op and will be removed in a future version.\n- Update any user-facing docs that mention the removed config options or flags to reflect the new behavior.",
            "Step 9: Communicate timeline and follow-through\n- In warnings and docs, specify the version in which the deprecated flag will be removed (e.g., v3.5.0).\n- When that version is reached:\n  - Remove the CLI flag from the parser.\n  - Remove the warning and any remaining compatibility hooks.\n  - Update tests to ensure use of the old flag fails fast with a clear error, if desired."
        ]
    }
}