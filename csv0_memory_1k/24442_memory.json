{
    "search_index": {
        "description_for_embedding": "Fix for Home Assistant Axis integration zeroconf discovery accepting non-Axis devices. The config flow now validates the device MAC address against a whitelist of Axis OUIs and aborts the flow with a specific reason if the device is not truly an Axis camera. Tests and user-facing abort messages updated accordingly.",
        "keywords": [
            "Home Assistant",
            "Axis integration",
            "config_flow",
            "zeroconf discovery",
            "MAC OUI filter",
            "device auto-discovery bug",
            "link_local_address",
            "not_axis_device",
            "integration mis-detection",
            "network device identification"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Axis integration in Home Assistant was incorrectly attempting to configure devices discovered via zeroconf that were not actually Axis devices. The config flow only rejected devices with link-local IP addresses (169.254.x.x) but did not validate that the multicast-discovered device belonged to Axis. As a result, unrelated devices advertising similar zeroconf services could trigger the Axis config flow and confuse users.\n\nThe fix introduces a MAC OUI whitelist in `homeassistant/components/axis/config_flow.py`:\n\n- A constant `AXIS_OUI = {'00408C', 'ACCC8E', 'B8A44F'}` is defined, containing the known Axis Organizationally Unique Identifiers (OUIs).\n- In `async_step_zeroconf`, the code now reads `serialnumber = discovery_info['properties']['macaddress']` and checks `serialnumber[:6] not in AXIS_OUI`.\n- If the OUI is not recognized as Axis, the flow aborts with the new reason `'not_axis_device'` instead of proceeding.\n- The existing link-local IP check remains: if `CONF_HOST` starts with `169.254`, the flow aborts with `'link_local_address'`.\n\nUser-facing strings were updated in `homeassistant/components/axis/strings.json` to add a clear abort message: `\"not_axis_device\": \"Discovered device not an Axis device\"` (with corrected grammar). The unit tests in `tests/components/axis/test_config_flow.py` were adjusted to:\n\n- Use valid Axis MAC addresses (`00408C...`) in tests that expect successful flows or known devices.\n- Add a new test `test_zeroconf_flow_ignore_non_axis_device` to assert that a non-Axis MAC (`01234567890`) results in an abort with reason `'not_axis_device'`.\n- Ensure the link-local address test includes a valid Axis MAC while still aborting for `'link_local_address'`.\n- Update tests referencing legacy config file data to use the new MAC format.\n\nThis change ensures that zeroconf discovery for the Axis integration is restricted to genuine Axis devices, preventing spurious configuration flows and aligning with the intended integration behavior (issues #24411 and #19837).",
        "semantic_memory": "Generalizable lessons from this fix:\n\n1. **Validate discovered devices beyond protocol-level discovery:**\n   Zeroconf, SSDP, or mDNS discovery can sometimes match multiple unrelated devices. Relying solely on service type or host information can cause incorrect matches. Adding a vendor-specific validation step (e.g., checking the MAC address OUI, a manufacturer ID, or a device-specific property) helps ensure that the integration only handles its intended devices.\n\n2. **Use MAC OUI as a lightweight vendor verification mechanism:**\n   The first 3 bytes (OUI) of a MAC address are assigned to specific vendors. Introducing a whitelist of known OUIs offers a fast and simple way to filter out devices that are definitely not from the target manufacturer. This can be particularly effective in home automation environments with many heterogeneous devices.\n\n3. **Abort early in configuration flows with clear reasons:**\n   When a discovered device is not supported (wrong vendor, wrong IP range, invalid configuration), the configuration flow should abort early and provide a clear, user-friendly reason. This improves user experience and makes logs and UI interactions more understandable.\n\n4. **Keep tests aligned with stricter validation logic:**\n   When discovery logic is tightened (e.g., introducing new validation or filters), existing tests that use dummy or generic values may start failing because they no longer pass validation. Tests should be updated to use realistic data (like valid OUIs or valid discovery properties) and new tests should cover the negative cases (e.g., non-matching OUIs) to ensure the behavior is enforced.\n\n5. **Separate concerns: vendor validation vs. network constraints:**\n   This fix preserves the link-local IP check while introducing a separate vendor check. Treat vendor identity (is this our device?) and network suitability (is the IP valid for integration?) as distinct concerns, each with their own abort reason and test coverage.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Identify symptoms of mis-detected devices.\n- Look for user reports or logs indicating that your integration is trying to configure devices that are not actually supported (e.g., wrong brand, wrong model).\n- Check discovery logs (zeroconf/mDNS/SSDP) to see what devices are being discovered and which ones are incorrectly triggering your config flow.",
            "Step 2: Determine a reliable vendor/device identifier.\n- Inspect the discovery payloads for stable identifiers: MAC address, OUI, vendor-specific properties, manufacturer strings, or model identifiers.\n- Confirm with vendor documentation or known device samples which identifiers can safely distinguish your target devices from others.",
            "Step 3: Implement a validation filter in the discovery/config flow.\n- In the config flow method that handles discovery (e.g., `async_step_zeroconf`), extract the candidate identifier (e.g., `macaddress` from `discovery_info['properties']`).\n- For MAC-based filtering, define a constant whitelist of known OUIs, e.g., `VENDOR_OUI = {'00408C', 'ACCC8E', 'B8A44F'}`.\n- Add a conditional check early in the flow: if the identifier does not match your expected values, abort the flow with a specific `reason` (e.g., `'not_vendor_device'`).",
            "Step 4: Maintain existing network or context checks.\n- Keep or add checks for unsuitable addresses (such as link-local `169.254.x.x`, loopback, or other invalid ranges) and abort with a distinct `reason` (e.g., `'link_local_address'`).\n- Ensure these checks are logically separate from vendor verification so you can distinguish their causes in logs and UI.",
            "Step 5: Add or update user-facing error messages.\n- Update any localization or strings files (e.g., `strings.json`) to include descriptive abort messages for the new reason codes.\n- Use clear, grammatically correct messages that explain why the flow aborted (e.g., \"Discovered device not an Axis device\").",
            "Step 6: Update and extend tests.\n- Adjust existing tests to use realistic data that passes the new validations (e.g., valid OUIs for positive cases).\n- Add negative tests to cover the new abort path, such as a discovery flow using a non-whitelisted MAC OUI and asserting the abort `reason` is `'not_axis_device'`.\n- Ensure tests still cover other abort reasons (such as link-local addresses) and that they include all required discovery fields.",
            "Step 7: Run the full test suite and validate behavior in a real environment.\n- Run unit tests and integration tests (e.g., via `tox` or the project’s test runner) to confirm no regressions.\n- Optionally test in a live environment with both supported devices and other network devices to confirm that only valid devices trigger the integration’s config flow.",
            "Step 8: Document the behavior if needed.\n- If this is a visible behavioral change (e.g., some previously discovered devices are now ignored), update integration documentation and release notes to mention that discovery is now limited to validated devices based on MAC OUI or other identifiers."
        ]
    }
}