{
    "search_index": {
        "description_for_embedding": "Fix for StackStorm st2client CLI where the --api-token/-t and other CLI options were only applied to the first API call in multi-step pack commands (install, remove, config, async). The patch ensures all internal manager calls correctly propagate **kwargs with auth token and other options, standardizes the decorator usage, and updates changelog.",
        "keywords": [
            "StackStorm",
            "st2client",
            "CLI auth token",
            "--api-token",
            "-t",
            "kwargs propagation",
            "PackInstallCommand",
            "PackRemoveCommand",
            "pack config",
            "PackAsyncCommand",
            "add_auth_token_to_kwargs_from_cli",
            "multi-call CLI command",
            "authentication bug",
            "X-Auth-Token",
            "LiveAction manager"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, StackStorm's st2client had a bug where the CLI arguments such as --api-token/-t were not correctly propagated to all API calls made by certain multi-step pack commands: `st2 pack install`, `st2 pack remove`, and `st2 pack config` (including the async path handled by PackAsyncCommand). Users observed that when invoking these commands with `-t` and `--debug`, only the first API request contained the `X-Auth-Token` header (or token query parameter), while subsequent requests failed authentication because the token was missing. The root cause was that the CLI-to-kwargs decorator was not placed on the correct methods, and several internal client manager calls (e.g., `Pack.get_by_ref_or_id`, `Pack.get_all`, `LiveAction.get_by_id`, and `Config.update`) were invoked without passing through the `**kwargs` that contained the auth token and other CLI-derived options. Some calls also created new model instances (`Config(pack, values)`) and then called `.update()` without any kwargs, dropping the auth context. The fix involved several changes: (1) repositioning the `add_auth_token_to_kwargs_from_cli` decorator so it wraps the correct `run`/`run_and_print` methods that fan out into multiple API calls; (2) importing the decorator directly as `add_auth_token_to_kwargs_from_cli` and using it consistently across pack commands for easier discovery; (3) ensuring every internal manager call in these commands passes through `**kwargs`, including `Pack.get_by_ref_or_id(..., **kwargs)`, `Pack.get_all(**kwargs)` in both install and remove flows, `LiveAction.get_by_id(parent_id, **kwargs)` in PackAsyncCommand, and `Config.update(config_item, **kwargs)` in pack config. This ensures the token and other CLI args are available to every HTTP request. The changelog was updated to document that the bug affected `st2 pack install`, `st2 pack remove`, and `st2 pack config`. After the fix, running `st2 --debug pack install ... -t <TOKEN>` shows `X-Auth-Token` correctly present on all underlying API calls and the commands complete successfully.",
        "semantic_memory": "This fix highlights a recurring pattern in CLI and client library design: when commands perform multiple internal API calls, all of those calls must consistently receive the same contextual parameters (such as auth tokens, debug flags, or other configuration) derived from the CLI. Relying on `**kwargs` propagation and decorators can be powerful but error-prone: if a decorator is placed on only one method, or if internal calls drop `**kwargs`, some requests will be sent without the necessary context, causing intermittent or confusing failures (e.g., first call succeeds, subsequent calls are unauthorized). Another generalizable lesson is that multi-step commands should treat the CLI context (auth, base URL, request params) as a first-class object that is passed through every layer, rather than re-creating clients or models without this context. Consistently using a centralized helper/decorator (`add_auth_token_to_kwargs_from_cli`) and enforcing that every manager call accepts and forwards `**kwargs` avoids subtle bugs. It's also useful to standardize decorator usage (import and apply consistently) so it can be easily searched and audited. Finally, debug modes that log HTTP headers and query parameters are critical for diagnosing these kinds of propagation issues: by inspecting outgoing requests, one can see exactly where the token or other important fields stop appearing.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce with verbose/debug output. Run the affected CLI command(s) with a known-good token and maximum debug, e.g. `st2 --debug pack install <pack> -t <TOKEN>`. Observe the outgoing HTTP requests in the logs, paying attention to whether the `X-Auth-Token` header or token query parameter appears on every request or only some.",
            "Step 2: Identify all internal API calls in the command. In the CLI implementation, locate the command class (e.g., PackInstallCommand, PackRemoveCommand, config commands) and list every place where it calls client manager methods (e.g., `manager.install`, `manager.remove`, `get_by_ref_or_id`, `get_all`, `update`, `get_by_id`). Pay special attention to code paths after the initial call, such as follow-up queries or status checks.",
            "Step 3: Trace how CLI options are injected. Find the mechanism that injects auth and other CLI options into function calls (e.g., a decorator like `add_auth_token_to_kwargs_from_cli` or a helper that builds `**kwargs`). Verify which methods are decorated and where those decorated methods delegate work.",
            "Step 4: Ensure decorators are placed on the correct entry points. Decorate the methods that are the true entry points from the CLI, typically `run` or `run_and_print`, such that all code paths originating from them receive a `**kwargs` that contains auth token and other options. If the decorator is currently applied to a method that is not always used (or applied to only one of several methods), move or add the decorator accordingly.",
            "Step 5: Propagate `**kwargs` through all internal calls. For every manager or client call in the command, ensure that `**kwargs` is passed through: for example, change `self.app.client.managers['Pack'].get_all()` to `self.app.client.managers['Pack'].get_all(**kwargs)`, and `get_by_ref_or_id(packs[0])` to `get_by_ref_or_id(packs[0], **kwargs)`. Do the same for other resources such as `LiveAction.get_by_id(parent_id, **kwargs)` and `Config.update(config_item, **kwargs)`.",
            "Step 6: Avoid dropping context when constructing model instances. When constructing model objects (e.g., `Config(pack=args.name, values=config)`) and then calling a manager method like `.update()`, ensure the call includes `**kwargs` as well. The model instance itself may not carry auth context; that should be passed via the manager method.",
            "Step 7: Standardize helper usage. If there's a reusable helper or decorator (e.g., `add_auth_token_to_kwargs_from_cli`), import it in a consistent manner and use it uniformly across all commands that require auth propagation. This makes it easier to grep for its usage and audit for missing applications.",
            "Step 8: Re-test under various scenarios. Re-run all affected commands with `--debug` and `-t/--api-token` (and potentially other CLI options) and confirm that every HTTP request, including follow-up queries and async state polling, contains the correct auth header or parameters. Also test success/failure paths (e.g., single pack vs multiple packs, pack removal, configuration, async flows).",
            "Step 9: Document the behavioral change. Update the changelog or release notes to describe that CLI auth/options are now correctly propagated to all API calls for the affected commands. This helps future debugging and sets expectations for users upgrading from versions with the bug.",
            "Step 10: Consider refactoring for robustness. As a longer-term improvement, refactor the client so that it encapsulates auth and configuration at a higher level (e.g., on the client/session object) rather than relying heavily on `**kwargs` propagation, reducing the surface for similar bugs in the future."
        ]
    }
}