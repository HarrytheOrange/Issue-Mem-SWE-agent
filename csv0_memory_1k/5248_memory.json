{
    "search_index": {
        "description_for_embedding": "Security hardening change: add configurable SameSite and Secure attributes for the StackStorm auth-token cookie used by st2web. Introduces api.auth_cookie_same_site (strict, lax, none, unset) and api.auth_cookie_secure (bool, default True), validates configuration at API startup using webob.cookies.make_cookie to catch invalid and mutually incompatible combinations (e.g., SameSite=none with Secure=False), and updates the router to respect these settings when setting auth cookies.",
        "keywords": [
            "auth cookie",
            "SameSite",
            "Secure",
            "StackStorm",
            "st2api",
            "st2web",
            "webob.cookies.make_cookie",
            "configuration validation",
            "HTTP cookie security",
            "config choices",
            "Backward compatibility",
            "unset vs none",
            "api.auth_cookie_same_site",
            "api.auth_cookie_secure"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this pull request, the StackStorm team implemented a 'security hardening' feature around the auth-token cookie that is set when authenticating against st2api via st2web (using tokens / API keys in query parameters).\n\nOriginally, the cookie lacked explicit SameSite and Secure attributes. That created two problems: (1) missed security hardening opportunities (no Secure flag by default, no SameSite protection), and (2) no way for operators to tune cookie behavior for their deployment requirements and browser compatibility.\n\nThe fix introduced two new configuration options in the API config:\n- api.auth_cookie_secure (BoolOpt, default True): controls whether the auth-token cookie includes the Secure flag. For best practice, it defaults to True; operators who still run StackStorm over plain HTTP (discouraged) can set it to False.\n- api.auth_cookie_same_site (StrOpt, default \"lax\", choices [\"strict\", \"lax\", \"none\", \"unset\"]): controls the SameSite attribute on the auth cookie. The default of \"lax\" is a balanced secure default. The special value \"unset\" means 'do not set SameSite at all', preserving the behavior from previous releases. The value \"none\" means explicitly send `SameSite=None`.\n\nThe original implementation used a single same_site_cookie string defaulting to none, but later iterations renamed and split this into the more explicit auth_cookie_same_site and auth_cookie_secure. The semantics around None vs none were confusing, so the option value \"None\" was renamed to \"unset\" to distinguish between 'do not send SameSite at all' (unset) and 'send SameSite=None' (none).\n\nTo prevent misconfiguration, the code now validates cookie-related settings during API initialization:\n- st2api.validation.validate_auth_cookie_is_correctly_configured() checks that api.auth_cookie_same_site is one of the allowed choices [\"strict\", \"lax\", \"none\", \"unset\"].\n- It then attempts to create a dummy cookie with webob.cookies.make_cookie using the configured secure and samesite values. If webob raises due to incompatible attributes (e.g., SameSite=\"none\" with Secure=False), validate_auth_cookie_is_correctly_configured rethrows a ValueError with a clear message. This ensures admin misconfigurations are caught early, before the API starts serving requests.\n\nThe router was updated so that when it sets the auth-token cookie on successful token-based authentication, it uses these config options:\n- Always passes httponly=True.\n- Passes secure=cfg.CONF.api.auth_cookie_secure.\n- For SameSite, it builds kwargs dynamically: if auth_cookie_same_site == \"unset\", it does not pass samesite at all; otherwise it passes samesite=<configured value>.\n\nUnit tests were added/updated to cover:\n- Validation logic (accepts valid values strict, lax, none, unset; rejects invalid values and mismatched combinations like none+secure=False).\n- API-level behavior in st2api/tests/unit/controllers/v1/test_auth.py: verifying that the auth cookie is set with HttpOnly and appropriate SameSite and Secure attributes for each configuration, and that when auth_cookie_same_site is \"unset\" the Set-Cookie header has no SameSite attribute.\n\nThe sample configuration file (conf/st2.conf.sample) and config generation script (tools/config_gen.py) were also updated:\n- The sample config now documents auth_cookie_same_site and auth_cookie_secure, includes valid value lists, and explains that \"unset\" restores the pre-hardening behavior.\n- The config generator now prints '# Valid values: ...' lines for options with a 'choices' attribute, to make the generated sample config self-describing.\n\nIn summary, this PR introduced configurable and validated SameSite and Secure attributes for the auth-token cookie, with safe defaults (Secure=True, SameSite=lax), a clear backward-compatible escape hatch (SameSite=unset), and robust startup-time validation to guard against invalid configurations.",
        "semantic_memory": "This change illustrates several general best practices around HTTP cookie security, configuration management, and validation in web services:\n\n1. **Secure defaults for auth cookies**\n   - Authentication cookies or tokens should default to secure configurations: `Secure` (HTTPS-only), `HttpOnly` to prevent access from JavaScript, and an appropriate `SameSite` setting to mitigate CSRF and cross-site attacks.\n   - Balanced defaults like `SameSite=Lax` often provide a good compromise between security and compatibility. More restrictive settings like `Strict` may be recommended but should be clearly documented due to potential UX impact.\n\n2. **Explicit configuration and clear semantics**\n   - When exposing config options for security-related behavior, names should clearly describe their purpose (e.g., `auth_cookie_secure`, `auth_cookie_same_site`) rather than generic names (`same_site_cookie`).\n   - Avoid overloading single symbols or values with multiple meanings. Here, the distinction between \"none\" and Python `None` was confusing, so a string value \"unset\" was used to mean 'do not set the attribute'. This avoids ambiguity between 'explicitly set SameSite=None' and 'omit the SameSite attribute'.\n   - Enumerated configuration values (`choices`) coupled with clear help texts and sample config comments help users avoid invalid or insecure settings.\n\n3. **Configuration validation at startup**\n   - Security-sensitive configuration should be validated early during application startup, not lazily at first use. That way, the service fails fast with a clear error instead of running in a partially broken or insecure state.\n   - For complex configuration interdependencies (e.g., SameSite=None requires Secure=True according to underlying library or standards), it's effective to validate by exercising the same code paths as runtime behavior: here, calling `webob.cookies.make_cookie` with the configured options and surfacing any exceptions as configuration errors.\n   - Validation functions should return booleans (or raise) and be tested independently; they can be called from multiple entry points (CLI launcher, WSGI app init, etc.).\n\n4. **Backwards compatibility mechanisms**\n   - When tightening security defaults, provide a clear, documented way for users to restore old behavior if needed (for example, for legacy browser support or complex deployments). Here, the 'unset' option preserves the pre-hardening behavior of not setting the SameSite attribute.\n   - Document the migration path in changelogs and sample configs, including new defaults and how to revert them.\n\n5. **Testing configuration-dependent HTTP behaviors**\n   - API tests should verify not only HTTP status and payload but also crucial headers, especially for security features like Set-Cookie attributes. Tests should cover all valid configuration permutations and edge cases (e.g., ensuring no SameSite attribute when configured as 'unset').\n   - Unit tests for validation logic should confirm both the acceptance of valid settings and the specific error messages and conditions for invalid settings.\n\n6. **Tooling support for configuration discovery**\n   - A config generation tool that emits 'Valid values:' comments based on option 'choices' makes it easier for operators to configure the system correctly, reducing misconfiguration and support burden.\n   - Keeping sample configs in sync with code via generation ensures that documentation does not drift from actual behavior.\n\nTogether, these patterns emphasize secure-by-default design, precise configuration semantics, startup-time validation of security-related options, and comprehensive testing and documentation.\n",
        "procedural_memory": [
            "How to diagnose and fix auth cookie SameSite/Secure configuration issues in a web API using webob or similar cookie libraries:",
            "Step 1: Identify the security and compatibility requirements for auth cookies",
            "  - Determine whether the application is expected to run behind HTTPS (it should, for production).",
            "  - Decide on an appropriate SameSite default (`Lax` vs `Strict` vs `None`) based on CSRF risk and cross-site usage (e.g., iframes, cross-domain SSO).",
            "  - Decide whether you must support legacy browsers that may not understand SameSite attributes.",
            "",
            "Step 2: Introduce explicit configuration options",
            "  - Add Boolean/enum config options for cookie security attributes, for example:",
            "    - `auth_cookie_secure` (boolean) controlling the Secure flag.",
            "    - `auth_cookie_same_site` (string with choices like `strict`, `lax`, `none`, `unset`).",
            "  - Use clear, context-specific names (e.g., `auth_cookie_*` rather than generic names).",
            "  - Set secure defaults (e.g., `auth_cookie_secure=True`, `auth_cookie_same_site='lax'`).",
            "  - If backward compatibility is needed, add a specific sentinel value like `unset` to mean 'do not set this attribute', and document it explicitly.",
            "",
            "Step 3: Map configuration to cookie construction",
            "  - In the code where you set cookies (e.g., using `webob.cookies.make_cookie`):",
            "    - Always set `httponly=True` for auth cookies.",
            "    - Always pass `secure=config.auth_cookie_secure`.",
            "    - Build an argument dict for optional attributes:",
            "      - Read `same_site = config.auth_cookie_same_site`.",
            "      - If `same_site != 'unset'`, include `samesite=same_site` in the call; otherwise, omit `samesite` entirely to preserve old behavior.",
            "    - Example pattern:",
            "      ```python",
            "      same_site = cfg.CONF.api.auth_cookie_same_site",
            "      kwargs = {}",
            "      if same_site != 'unset':",
            "          kwargs['samesite'] = same_site",
            "      cookie = cookies.make_cookie(",
            "          name, value, httponly=True, secure=cfg.CONF.api.auth_cookie_secure, **kwargs",
            "      )",
            "      ```",
            "",
            "Step 4: Implement startup-time validation of cookie configuration",
            "  - Write a validation function (e.g., `validate_auth_cookie_is_correctly_configured`) that:",
            "    - Verifies `auth_cookie_same_site` is one of the allowed strings (using `choices` or an explicit list).",
            "    - Attempts to create a dummy cookie via `make_cookie` using the configured `secure` and `same_site` settings.",
            "    - Catches any exceptions (e.g., \"Incompatible cookie attributes: when samesite equals 'none', secure must be True\") and rethrows as a `ValueError` with a clear and user-friendly message.",
            "  - Call this validation function during application startup, for example in your WSGI app factory or CLI `_setup()` function, before starting the server.",
            "",
            "Step 5: Update configuration schema and docs",
            "  - In your central config definition (e.g., using `oslo_config`):",
            "    - Use `choices` on StrOpt to restrict allowed values (`choices=['strict', 'lax', 'none', 'unset']`).",
            "    - For booleans (e.g., `auth_cookie_secure`), use BoolOpt.",
            "    - Write help texts that clearly explain defaults, recommended values, and any special sentinel values like `unset`.",
            "  - Update sample configuration files to include the new options, their defaults, and valid value lists (e.g., via a config generation script).",
            "  - If using a generator, enhance it to print `# Valid values: ...` when an option has explicit choices.",
            "",
            "Step 6: Add unit and functional tests",
            "  - Validation tests:",
            "    - Test that valid values for `auth_cookie_same_site` (e.g., `strict`, `lax`, `none`, `unset`) with `auth_cookie_secure=True` all pass validation.",
            "    - Test invalid values (e.g., `invalid`, `strictx`) raise `ValueError` with a clear message mentioning valid values.",
            "    - Test invalid combinations (e.g., SameSite=`none` with `secure=False`) raise `ValueError` with a message derived from or explaining the underlying library error.",
            "  - API/controller tests:",
            "    - Mock authentication and make a request that triggers cookie setting.",
            "    - For each valid configuration value, assert:",
            "      - Response status is OK (e.g., 200).",
            "      - `Set-Cookie` header is present.",
            "      - `HttpOnly` is present in `Set-Cookie`.",
            "      - When `auth_cookie_secure=True`, `secure` appears in the header; when False, it does not.",
            "      - When `auth_cookie_same_site` is `strict`, `lax`, or `none`, `SameSite=<value>` appears in the header.",
            "      - When `auth_cookie_same_site` is `unset`, `SameSite` does not appear at all.",
            "",
            "Step 7: Handle deployment and upgrade considerations",
            "  - Document the new config options and defaults in the changelog and upgrade notes.",
            "  - Specifically mention:",
            "    - That `auth_cookie_secure` defaults to True and may require HTTPS in front of the API.",
            "    - That `auth_cookie_same_site` defaults to `lax` for added security and may change behavior compared to older releases.",
            "    - That setting `auth_cookie_same_site` to `unset` restores the old behavior (no SameSite header).",
            "  - For users upgrading from older versions, provide a clear recommendation and example configuration snippets.",
            "",
            "Step 8: When debugging runtime issues",
            "  - If users report errors at startup related to cookie configuration:",
            "    - Look for ValueError messages raised by the validation function, particularly ones mentioning invalid values or incompatible attributes.",
            "    - Verify that the configured values for `auth_cookie_same_site` and `auth_cookie_secure` conform to the documented choices and constraints.",
            "  - If users see unexpected cookie behavior in the browser:",
            "    - Inspect the `Set-Cookie` header from responses (using browser dev tools or curl) to confirm which attributes are set.",
            "    - Cross-check with the configured values in st2.conf (or equivalent).",
            "    - Adjust configs to satisfy both the security requirements and any compatibility needs, using `unset` if necessary to match previous behavior."
        ]
    }
}