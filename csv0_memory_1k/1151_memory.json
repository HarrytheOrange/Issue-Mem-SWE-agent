{
    "search_index": {
        "description_for_embedding": "Deployment script st2_deploy.sh was refactored to install StackStorm from system package repositories (apt/yum) instead of manually downloading .deb/.rpm files. The fix adds the StackStorm apt repo, configures a yum repo, removes custom download logic, and updates st2client installation to use the python-st2client package via apt.",
        "keywords": [
            "StackStorm",
            "st2_deploy.sh",
            "deployment script",
            "apt repository",
            "yum repository",
            "package management",
            "manual download removal",
            "python-st2client",
            "gdebi replacement",
            "RPM install",
            "DEB install"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this PR, the StackStorm deployment script tools/st2_deploy.sh was updated to deploy from distribution repositories instead of downloading package files directly. Originally, the script computed package names for .deb and .rpm files, downloaded them from https://ops.stackstorm.net/releases, stored them locally, and installed them via dpkg -i or yum localinstall. That approach was brittle (tightly coupled to specific version/build paths and local file management).\n\nThe changes introduced several key updates:\n- A new flag handling for the \"latest\" version argument: if the user passes \"latest\" as the first argument, a LATEST=1 variable is set and VER is set to \"0.8dev\".\n- In install_apt, the script now adds an apt repository for StackStorm by writing /etc/apt/sources.list.d/stackstorm.list with a \"deb http://downloads.stackstorm.net/deb/ trusty main\" entry, then runs apt-get update and expects packages to be installed from there.\n- In install_yum, after handling RabbitMQ, the script downloads a StackStorm yum repo file into /etc/yum.repos.d/stackstorm.repo from a gist URL. It picks a different repo file depending on whether the LATEST flag is set, conceptually supporting a split between stable and latest/unstable channels.\n- The download_pkgs() function and its invocation were removed, eliminating the custom logic for downloading and cleaning up package files.\n- deploy_rpm was simplified to install required components via yum install -y for each package named in the PACKAGES list instead of removing existing st2 packages and locally installing *.rpm files. (Note: the patched code has variable naming inconsistencies, but the intention is clear.)\n- deploy_deb was similarly simplified to use apt-get install -y for each package name, instead of manually purging and dpkg -i installing local .deb files.\n- install_st2client for DEB-based systems was changed from using gdebi to install a locally downloaded st2client*.deb to simply running \"apt-get -y install python-st2client\", using the repository-provided client package.\n\nOverall, the incident was a refactor: shifting deployment from manual artifact download and installation to fully leveraging apt/yum repositories for StackStorm and its client package.",
        "semantic_memory": "This fix illustrates a common evolution in deployment tooling: moving from manual package file management to using first-class OS package repositories.\n\nKey generalizable concepts:\n- **Use native package managers and repos instead of manual downloads**: Downloading .deb/.rpm artifacts directly (via curl/wget) and installing them with dpkg/yum localinstall is brittle. It hardcodes URLs, versions, and architecture and requires additional logic for cleanup and upgrades. By defining an apt/yum repository and installing via apt-get/yum install, you gain dependency resolution, easier upgrades, and a stable interface.\n- **Separate stable and unstable channels**: Introducing logic to choose between stable and \"latest\"/dev repos (via a flag like LATEST) lets users intentionally opt into bleeding-edge builds without impacting default stability. This pattern is important for projects with frequent releases.\n- **Avoid local file assumptions in scripts**: When tools depend on locally present packages (e.g., st2client*.deb), scripts become fragile when filenames or locations change. Installing by package name from configured repositories is more robust and does not require file path management.\n- **Use distribution-appropriate package names**: Installing the client as a named package (python-st2client) rather than as a raw .deb or .rpm file makes the script easier to maintain and aligns with distro packaging conventions.\n- **Centralize repo configuration**: Explicitly writing repo configuration (e.g., /etc/apt/sources.list.d/stackstorm.list or /etc/yum.repos.d/stackstorm.repo) as part of the installation step ensures that subsequent installs/upgrades can be done with simple package-manager commands.\n\nThese practices reduce coupling to build infrastructure, improve maintainability, and make deployments more predictable across environments.",
        "procedural_memory": [
            "When a deployment script depends on manually downloaded .deb/.rpm artifacts and becomes fragile or hard to maintain, refactor it to use distribution repositories and native package management.",
            "Step 1: Identify manual download and install flows in the deployment script.\n- Search for curl/wget commands that download package files (.deb or .rpm).\n- Look for dpkg -i, rpm -i, or yum localinstall commands that operate on local files.\n- Find any cleanup logic that removes or rotates downloaded packages.",
            "Step 2: Confirm that repository endpoints exist for the software.\n- Check if the project provides apt or yum repos (e.g., documentation or existing .repo/.list files).\n- Identify correct repository URLs, distributions (e.g., trusty, focal), and components (e.g., main, unstable).",
            "Step 3: Add apt repository configuration for Debian/Ubuntu.\n- Create or update a file under /etc/apt/sources.list.d/<project>.list with a deb line pointing to the repo, e.g.: deb http://example.com/deb/ DIST main.\n- Import the repository GPG key if required (apt-key add or modern alternatives).\n- Run apt-get update to refresh the package index.",
            "Step 4: Add yum/dnf repository configuration for RHEL/CentOS/Fedora.\n- Create or update /etc/yum.repos.d/<project>.repo with the appropriate [repo] section, baseurl, gpgkey, and enabled flags.\n- Alternatively, if a repo file is provided remotely, download it into /etc/yum.repos.d/.\n- Import any required GPG keys via rpm --import.\n- Run yum makecache or rely on yum to auto-refresh.",
            "Step 5: Replace manual package installation with package-manager installs.\n- Instead of dpkg -i local-package.deb or yum localinstall /path/to/package.rpm, use:\n  - apt-get install -y <package-name>\n  - yum install -y <package-name>\n- Ensure PACKAGES lists in your script contain correct package names (e.g., python-st2client instead of a wildcard st2client*.deb).",
            "Step 6: Remove custom download and cleanup logic.\n- Delete functions that download versioned package artifacts from build servers.\n- Remove code that purges or manually uninstalls prior versions based on filenames; rely on package-manager upgrades and dependency resolution.",
            "Step 7: Provide version and channel selection mechanics via repos.\n- Introduce flags or arguments (e.g., --latest, --stable) that select which repo file or URL to use.\n- Map these flags to different repo definitions (stable vs latest/unstable) instead of hard-coding particular version paths.",
            "Step 8: Update client/CLI installation to use named packages.\n- If previously the script installed a client .deb via gdebi or dpkg, switch to installing the distribution-provided client package (e.g., apt-get install -y python-st2client).\n- Do the analogous update for RPM-based systems, using yum install <client-package>.",
            "Step 9: Test on both DEB and RPM based systems.\n- Run the updated script on supported distributions, verifying:\n  - The repo files are created correctly.\n  - apt-get/yum can resolve and install all required packages.\n  - Upgrades work via package-manager alone (no leftover local artifacts).\n- Fix any variable naming issues in loops (ensure you use consistent variable names when iterating over package lists).",
            "Step 10: Document the new behavior.\n- Note that deployments now depend on the configured apt/yum repos rather than direct download URLs.\n- Document any new flags (e.g., latest/stable) and the expected repo behavior."
        ]
    }
}