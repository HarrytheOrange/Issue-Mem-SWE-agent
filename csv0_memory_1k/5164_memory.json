{
    "search_index": {
        "description_for_embedding": "StackStorm CLI key-value command was updated so that the value argument is optional. If the value is omitted, the CLI interactively prompts the user for the value, preventing secrets from being exposed in shell history. Implemented via argparse nargs='?' and an input() prompt, plus changelog entry.",
        "keywords": [
            "StackStorm",
            "keyvalue.py",
            "KeyValuePair",
            "st2 key set",
            "CLI secret handling",
            "shell history leakage",
            "interactive prompt",
            "argparse nargs '?'",
            "secure input",
            "key-value store"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this change, the StackStorm CLI command for managing key-value pairs (st2client/st2client/commands/keyvalue.py) was enhanced to avoid leaking sensitive values into the shell history. Previously, the command required a positional 'value' argument when creating a key-value pair: the user had to type the value directly on the command line. For secrets, this meant the value was stored in the shell history, which is a security risk.\n\nTo fix this, the 'value' argument definition was changed from a mandatory positional to an optional positional by setting nargs='?'. In the command's run() method, the code was updated to check whether args.value is present. If the user did not provide a value on the command line, the CLI now prompts the user interactively with input(\"Please insert value for key: \") and uses that input as the value. If a value is provided as before, it behaves the same as prior versions. The rest of the KeyValuePair fields (name, scope, user, secret) are handled as before.\n\nAdditionally, a changelog entry was added under an 'Added' section in CHANGELOG.rst, documenting that users can now add new values to the key-value store via CLI without leaking them to shell history. Some minor whitespace adjustments were also made to keep the changelog formatting clean.\n\nOverall, the incident was about reducing secret exposure via shell history in a CLI key-value command by introducing an interactive prompt when the value is omitted.",
        "semantic_memory": "This change illustrates a common security and usability pattern in CLI tool design: avoid requiring sensitive data (such as passwords, API keys, or other secrets) as command-line arguments, because they may be persisted in shell history, logged, or exposed via process listings.\n\nGeneralizable concepts and best practices:\n\n1. **Avoid secrets on the command line**: Positional or flag arguments that accept secrets are risky. Shell history, scripts, and audit logs can inadvertently expose these values. Instead, provide interactive prompts or use environment variables, config files, or stdin.\n\n2. **Optional arguments plus interactive prompt**: A good pattern is to make the secret argument optional. If it is not supplied, the program interactively prompts the user for the value. This lets automation still pass values explicitly when appropriate, while allowing humans to avoid shell history exposure.\n\n3. **Use proper input mechanisms for secrets**: For truly secret values, it is generally better to use input methods that do not echo the value to the terminal (e.g., getpass.getpass in Python) rather than plain input(). While this change focused on shell history, the general best practice includes shielding secrets from shoulder-surfing and screen logs as well.\n\n4. **Argparse and optional positionals**: In Python, the argparse library allows making a positional argument optional using nargs='?'. Combined with runtime checks (if args.value is None), this enables conditional prompting for missing arguments.\n\n5. **Document security-relevant behavior**: Any change that affects how secrets are handled should be clearly documented (e.g., in a changelog), so users understand the safer usage pattern and can adjust their workflows accordingly.\n\n6. **Backward-compatible enhancements**: By allowing both explicit value arguments and interactive prompts, the change remains backward compatible for scripts/automation while improving security for interactive use.\n\nThese patterns apply broadly to any CLI or service that handles sensitive configuration values, not just StackStorm or this specific key-value command.",
        "procedural_memory": [
            "Identify and mitigate CLI secret exposure via command-line arguments.",
            "Step 1: **Locate commands handling sensitive values.** Review CLI commands and APIs to find where secrets (passwords, tokens, keys, etc.) are accepted, especially as positional or flag arguments.",
            "Step 2: **Assess exposure vectors.** Confirm whether these values can appear in shell history, process listings (e.g., ps), logs, or error messages. If yes, treat them as security issues.",
            "Step 3: **Decide on safer input mechanisms.** Choose one or more of: interactive prompt, environment variables, configuration files, stdin, or secure keystores. For interactive CLI usage, a prompt is often most convenient.",
            "Step 4: **Make secret arguments optional.** In Python argparse, convert mandatory secret arguments to optional ones. For positionals, set `nargs='?'` so the argument can be omitted; for options, make the flag optional and allow no value to be passed.",
            "Step 5: **Implement conditional prompting.** In the command handler (e.g., run method), add logic:\n- If the secret value argument is present, use it as-is (preserving existing automation behavior).\n- If it is missing, prompt the user: for example, using `getpass.getpass('Enter secret: ')` or at least `input('Enter value: ')` if no-echo is not required.",
            "Step 6: **Preserve backwards compatibility.** Ensure that existing scripts that pass the value explicitly still work unchanged. The new behavior should be an additive improvement for interactive users.",
            "Step 7: **Test both modes.** Add or update tests to cover:\n- Providing the value as an argument (old behavior).\n- Omitting the value so that the prompt path is exercised (can be tested via mocking input/getpass in unit tests).",
            "Step 8: **Update documentation and changelog.** Document the new behavior in CLI help text and changelog, emphasizing the more secure way to use the command for secrets.",
            "Step 9: **Review for other similar patterns.** After fixing one command, scan the codebase for other commands that accept secrets via command-line parameters and apply the same pattern.",
            "Step 10: **Consider further hardening.** If needed, move from plain `input()` to non-echo input (e.g., `getpass`), and ensure that prompts and error messages never print the secret value."
        ]
    }
}