{
    "search_index": {
        "description_for_embedding": "Multi-fix PR for PokemonGo-Bot improving robustness of configuration-driven features, event logging, MQTT/web integrations, and Pokemon optimization. Fixes include default handling of missing 'sort' rules in pokemon_optimizer, numeric XP tracking on evolve, case-insensitive evolve/blacklist lists, trimming spaces in custom keep_best config, proper pgoapi version check on startup, safer MQTT subscribe/unsubscribe on connect/disconnect, Telegram handler support for symbolic 'master' usernames, configurable team selection in CompleteTutorial, and exposing Pokemon level in inventory data.",
        "keywords": [
            "pokemon_optimizer",
            "sort default",
            "KeyError",
            "config.json",
            "CompleteTutorial",
            "team selection",
            "TelegramHandler",
            "master username",
            "MQTT",
            "social_handler",
            "subscribe on_connect",
            "unsubscribe on_disconnect",
            "pgoapi version check",
            "evolve_pokemon",
            "case insensitive",
            "transfer_pokemon",
            "keep_best_custom",
            "whitespace in config",
            "inventory",
            "pokemon level field",
            "websocket.remote_control help typo",
            "logger color argument",
            "map-chat",
            "min_slots_left",
            "optimizer configuration"
        ]
    },
    "agent_memory": {
        "episodic_memory": "This PR addressed a collection of robustness, usability, and configuration issues across the PokemonGo-Bot codebase.\n\n1) Event & logging additions\n- A new debug event `forts_found` was added in `pokemongo_bot.__init__`. After each GET_MAP_OBJECTS call, the bot inspects map cells; if any contain forts, it emits a `forts_found` event at `debug` level with the forts JSON payload. This allows downstream tools to debug/map fort data without cluttering normal logs.\n- A logger misuse was fixed in `_load_recent_forts`: passing an unsupported color argument `'red'` to `logger.info` caused issues. The color argument was removed so the error message is logged with the standard interface.\n\n2) Pokemon optimizer fixes\n- In `config.json.optimizer.example` and the docs, the `ncp` sort values were incorrectly strings (\"0.9\"). They are now numeric (0.9) so the optimizer can compare values correctly.\n- The documentation was clarified to state that when both `evolve` and `upgrade` are enabled for a rule, evolution has priority: the optimizer fully evolves a Pokemon before upgrading it.\n- In `pokemon_optimizer.py`:\n  - After evolving a Pokemon, the player's XP (`inventory.player().exp`) is now incremented by the XP gained. Previously, XP changes from evolution were not reflected in the in-memory player state, causing inconsistencies for any logic relying on `player().exp`.\n  - The code now guards against missing `sort` keys in rules. `rule.get(\"sort\")` previously returned `None`, which was iterated over, causing a `TypeError`. It now uses `rule.get(\"sort\", [])` in both `get_best_pokemon_for_rule` and `get_score`, so rules without `sort` simply behave as having no custom ranking criteria.\n  - The optimizer's free-slot threshold was hard-coded (`> 5` slots) to decide whether to run or whether to postpone evolution for a Lucky Egg batch. This is now configurable via `min_slots_left` (default 5). The example optimizer config gained this field and the code compares against `self.config.get(\"min_slots_left\", 5)` both in `work` (to decide whether to run) and in `apply_optimization` (to decide whether to skip evolution due to plenty of free slots).\n\n3) Evolve/transfer configuration robustness\n- In `evolve_pokemon.py`, user-specified `evolve_list` and `donot_evolve_list` are now normalized to lowercase strings. Filtering then uses `pokemon.name.lower()` for comparisons. This ensures that different casings in the config (e.g. \"Pidgey\" vs \"pidgey\") still match correctly.\n- In `transfer_pokemon.py`, the `keep_best_custom` string is now sanitized by removing spaces before splitting on commas (`keep_best_custom.replace(' ','').split(',')`). Previously, spaces could cause invalid metric names (e.g. \" iv\" instead of \"iv\") to silently disable keep_best or behave unexpectedly.\n\n4) Tutorial completion and team selection\n- The `CompleteTutorial` task in `complete_tutorial.py` was extended. It already handled the tutorial steps (legal screen, avatar, first catch, nickname, initial XP). Now it also supports:\n  - A `team` configuration option (0=none, 1=Blue/Mystic, 2=Red/Valor, 3=Yellow/Instinct), documented and added to all config example files.\n  - A new `_set_team` method that, once the player reaches level 5, optionally calls `SET_PLAYER_TEAM` to pick the configured team. It logs success with a human-readable team name or logs an error string on failure (handling status codes including TEAM_ALREADY_SET).\n  - A guard: if `team` is 0, it does nothing; if `player_data['team']` is already non-zero, it logs \"Team already picked\" and skips.\n  - The worker runs tutorial and team logic only once each (`tutorial_run` and `team_run` flags), preventing repeated API calls or loops.\n- A small bug was fixed where `self.team_run` was accidentally set with `==` (comparison) instead of `=` in `initialize`; this was corrected to `self.team_run = True`.\n- The docs (`configuration_files.md`) were updated to explain CompleteTutorial, its options, team values, and a sample configuration.\n\n5) Telegram handler improvements\n- The Telegram integration previously required numeric `master` IDs and didn’t properly handle symbolic values like \"master\" or non-numeric placeholders. The handler was enhanced to support a symbolic master configuration:\n  - `TelegramClass.__init__` now receives `config` and stores it.\n  - In `TelegramClass.run`, when handling updates, if `self.master` is set but not purely numeric, the first incoming message is treated as the \"master\". The code replaces the \"master\" value in the config with the actual chat ID (`update.message.chat_id`), removes existing Telegram handlers from the bot's event manager, and re-adds a new TelegramHandler instance with the updated config.\n  - This lets users specify a non-numeric master identifier and have the bot bind to whichever chat first contacts it.\n- `TelegramHandler` now passes `config` into `TelegramClass` and stores it locally for re-instantiation.\n\n6) MQTT and web map/chat robustness\n- `social_handler.py` previously subscribed to MQTT topics (`pgo/#`) immediately after calling `connect`, regardless of connection result. It also didn’t unsubscribe on disconnect and used slightly inconsistent debug prints.\n  - Subscription is now moved into `mqtt_on_connect`, executing only when `rc == 0` (successful connection). A debug message prints the return code if `DEBUG_ON` is set.\n  - On disconnect, it unsubscribes from `pgo/#`, and the unexpected disconnect message uses consistent print syntax.\n  - The `connect_to_mqtt` setup was simplified: handlers are attached unconditionally to the client, and the explicit subscribe call was removed (since it’s now in `on_connect`). The loop_start remains commented out.\n- Map chat JavaScript logic was adjusted to better handle server load and reconnections:\n  - In `map-chat/javascript/main.js`, the MQTT client now uses a longer reconnect period (60 seconds instead of 10). It subscribes to `pgomapcatch/#` and `pgochat/chat` on `connect`, and unsubscribes from these topics on `disconnect`. A previous toast about server overload was commented out, and the private-chat toast remains optional.\n  - In `map-chat/javascript/map.js`, `initialize()` now calls `initialiseEventBus()` immediately and then uses a fixed dummy starting position (0.1, 0.1) via `onFirstPosition`, rather than immediately calling `navigator.geolocation`. This keeps the map functional even if geolocation is unavailable or slow. The event bus was moved from `onFirstPosition` to `initialize` to ensure the MQTT connection begins right away.\n\n7) Start-up compatibility check\n- In `pokecli.py`, a start-up check was added to validate that the installed `pgoapi` package meets a minimum version requirement:\n  - Using `pkg_resources.get_distribution(\"pgoapi\").version`, the script ensures the version is at least `1.1.8`. If not, it prints an upgrade command (`pip install -r requirements.txt --upgrade`) and exits.\n  - If the distribution is missing, it prints instructions to install requirements and exits.\n  - If `pkg_resources` itself is not available, the ImportError is printed and ignored, so the bot can still attempt to run.\n- A minor typo in the `--websocket.remote_control` help text was corrected from \"websocekt\" to \"websocket\".\n\n8) Windows configurator improvements\n- The Windows batch script `PokemonGo-Bot-Configurator.bat` was expanded to:\n  - Clearly list that it creates `auth.json` and `userdata.js`, and warns that `auth.json`, `userdata.js`, and `config.json` will be overwritten.\n  - Add a third menu option to choose which `config.json.example` variant to use: default, cluster, map, optimizer, path, pokemon. Based on user choice, it copies the selected example to `config.json`.\n  - Adjust end-of-script text to state that the config may be customized or used as-is, and the corrected grammar (\"have been made\").\n\n9) Inventory Pokemon level exposure\n- In `inventory.py`, the `Pokemon` object already computed its level from `cp_m`, but this wasn’t reflected in the underlying `_data` dictionary.\n- The constructor now ensures `self._data['level']` is set if missing. This makes the computed level available to any components or APIs that inspect the raw data, enabling consistent downstream behavior without recomputing the level.\n\nOverall, this PR focused on making the bot more fault-tolerant, easier to configure, and less prone to runtime errors due to missing config fields, version mismatches, or external service behavior changes.",
        "semantic_memory": "Several generalizable patterns and best practices emerge from this PR:\n\n1) Defensive handling of optional configuration fields\n- When reading configuration dictionaries (e.g., rule objects) you should always assume some keys may be missing. Using constructs like `rule.get(\"sort\", [])` allows your logic to function gracefully even when configuration is incomplete.\n- When parsing user-supplied string lists (for Pokemon names, metrics, etc.), normalize them (e.g., lowercase, trimmed whitespace) before comparison. Case- and space-insensitive handling prevents subtle bugs and makes configuration less fragile.\n\n2) Keep in-memory state consistent with side effects\n- When an action (like evolving a Pokemon) modifies server-side state (XP, candy, etc.), ensure your in-memory models are updated accordingly. Otherwise, later logic that depends on these fields may behave incorrectly or inconsistently.\n- If you compute derived values (like Pokemon level from CP multipliers), consider storing them back into the raw data model so all consumers see a consistent view.\n\n3) Make thresholds and magic numbers configurable\n- Hard-coded thresholds (e.g., \"only optimize when there are <= 5 free Pokemon slots\") should be configuration options. This makes behavior tunable without code changes and clarifies the intent in config templates and docs.\n\n4) Resilient integration with external libraries and services\n- For critical dependencies (like `pgoapi`), performing a version check at startup can prevent obscure runtime errors and provide clear remediation instructions to users.\n- When integrating with MQTT or other network services, subscribe to topics only after a successful connection callback, and unsubscribe on disconnect. This avoids race conditions and ensures clean reconnection behavior.\n- On the web side, initialize network connections and map UI in a way that degrades gracefully: avoid blocking on geolocation, and use sensible defaults so the UI remains usable even if certain APIs fail or are slow.\n\n5) Robust chat/bot control flows\n- For chat-based admin control (e.g., Telegram), allow flexible master identification: accepting a symbolic placeholder and \"learning\" the actual master ID from the first incoming message improves UX while remaining secure.\n- When reconfiguring runtime behavior (like changing master ID), consider rebuilding handlers cleanly (removing old instances, re-adding new ones) to avoid state inconsistencies.\n\n6) Tutorial and onboarding automation\n- Automated onboarding flows (e.g., completing a game's tutorial or choosing a team) should:\n  - Be idempotent (only run once per relevant condition).\n  - Respect current state (e.g., do not attempt to re-pick a team if one is already chosen).\n  - Use clear configuration flags and document them in sample configs and docs.\n\n7) Logging and user messaging hygiene\n- Logging interfaces typically have specific signatures; avoid passing extra arguments (like color strings) unless supported by the logger.\n- CLI and GUI messages should be clear and actionable, especially when notifying about missing dependencies or destructive operations (overwriting files).\n\nTaken together, these changes illustrate how to make a bot or automation framework robust: validate dependencies early, sanitize configuration inputs, handle optional fields gracefully, mirror server-side effects in local state, and design integrations with remote services and chat platforms defensively.",
        "procedural_memory": [
            "Step-by-step patterns for diagnosing and fixing similar issues in configuration-heavy, network-integrated bots:",
            "Step 1: Audit crash points for missing or malformed config",
            "- Search stack traces for `KeyError`, `TypeError: 'NoneType' object is not iterable`, or similar exceptions in code that reads configuration (e.g., rules, lists of metrics).",
            "- For each such location, replace direct accesses like `rule['sort']` with `rule.get('sort', [])` or a sensible default. Ensure loops iterate over an empty list when the config key is absent.",
            "- If config values are numeric but appear as strings (e.g., \"0.9\"), convert them to proper types or fix the example configs so they are parsed correctly.",
            "",
            "Step 2: Normalize user-supplied string lists",
            "- Identify where user configuration supplies lists of names or fields (e.g., `evolve_list`, `donot_evolve_list`, `keep_best_custom`).",
            "- Normalize the input at load or validation time: strip whitespace, convert to lowercase, and split on the correct delimiter.",
            "- In filtering logic, apply the same normalization to the values you compare against (e.g., `pokemon.name.lower()`), ensuring case- and whitespace-insensitive matching.",
            "",
            "Step 3: Keep local models in sync with server-side effects",
            "- For each API action (e.g., evolve, upgrade, transfer), determine which player or Pokemon attributes change (XP, candy, inventory counts, etc.).",
            "- After the API call returns success, update your in-memory model objects with these changes. Avoid assuming they will be recomputed elsewhere.",
            "- When you compute derived values like levels from CP multipliers, consider storing them back in the raw data structures so all code paths see the same value.",
            "",
            "Step 4: External dependency checks at startup",
            "- Identify critical external libraries (like an API wrapper) and the minimum versions your code requires.",
            "- At program startup, use the package manager's APIs (e.g., `pkg_resources.get_distribution`) to inspect the installed version.",
            "- If the version is too low or missing, print a clear message with an exact command to fix the problem and exit early.",
            "",
            "Step 5: Harden MQTT or similar network integrations",
            "- When using MQTT (or similar protocols), attach callbacks for `on_connect`, `on_message`, and `on_disconnect`.",
            "- Move subscribes into `on_connect` and guard them with a success code check (e.g., `if rc == 0`).",
            "- In `on_disconnect`, unsubscribe from topics and log unexpected disconnects.",
            "- Configure a reasonable reconnect period to avoid hammering the broker during outages.",
            "",
            "Step 6: Make thresholds configurable and document them",
            "- Locate hard-coded thresholds (e.g., minimum free slots, XP counts for actions) that affect behavior.",
            "- Replace them with configuration options with sensible defaults (e.g., `min_slots_left`, `evolve_count_for_lucky_egg`).",
            "- Update example config files and documentation so users understand the new knobs and defaults.",
            "",
            "Step 7: Design idempotent onboarding flows",
            "- For tasks that should run only once per account state (e.g., tutorial steps, choosing a team), maintain flags in the task (e.g., `tutorial_run`, `team_run`) and check actual player state (e.g., `player()._level`, `player_data['team']`).",
            "- Before calling an irreversible action (SET_PLAYER_TEAM), verify whether it has already been performed. If so, log a message and skip.",
            "- Structure the worker so that failing one step returns an explicit error, but successful completion of prior steps does not re-run.",
            "",
            "Step 8: Improve chat and admin flows",
            "- For chat-based admin control, allow a symbolic identifier (e.g., a config value like \"master\") for the admin user.",
            "- On first message, if the configured master is symbolic or non-numeric, capture the sender's chat ID and update the configuration and handler instances to bind to that user.",
            "- Remove old handler instances and create new ones with the updated config to avoid inconsistent state.",
            "",
            "Step 9: Clean up logging and user messages",
            "- Review logger usage: ensure calls match the API (e.g., `logger.info(msg)` without unsupported color arguments).",
            "- Correct typos in CLI help and user-facing messages; ensure warnings about overwriting files or missing dependencies are clear and explicit.",
            "",
            "Step 10: Validate web frontend behavior under degraded conditions",
            "- For web/map UIs, avoid relying exclusively on browser APIs like geolocation; provide fallback positions or flows in case they fail.",
            "- Initialize network connections (like MQTT) early in the UI lifecycle and cleanly handle connect/disconnect events by subscribing/unsubscribing to topics.",
            "- Test the UI with network unavailable and with high server load to ensure it degrades gracefully rather than failing outright."
        ]
    }
}