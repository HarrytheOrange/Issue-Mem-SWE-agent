{
    "search_index": {
        "description_for_embedding": "Home Assistant HomematicIP_Cloud integration did not dynamically add or remove devices/groups; new devices required a restart to show up and removed devices lingered in the registries. The fix wires HomematicIP on_create/on_remove events into Home Assistant, adds delayed config entry reload for new entities, and cleans up device/entity registries when HomematicIP devices are removed. Requires homematicip library update to 0.10.12.",
        "keywords": [
            "Home Assistant",
            "homematicip_cloud",
            "HomematicIP_Cloud",
            "dynamic device discovery",
            "device removal",
            "device registry cleanup",
            "entity registry cleanup",
            "on_create",
            "on_remove",
            "EventType.DEVICE_ADDED",
            "AsyncHome",
            "async_will_remove_from_hass",
            "async_reload",
            "homematicip==0.10.12",
            "integration restart required",
            "live device add/remove"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this pull request, the HomematicIP_Cloud integration for Home Assistant was enhanced to support dynamic addition and removal of HomematicIP devices and groups without requiring a Home Assistant restart.\n\nPreviously, the integration only handled state updates from the HomematicIP API. When a new device or group was added in HomematicIP, Home Assistant would not discover it until the integration (or HA itself) was restarted. When a device was removed from HomematicIP, its corresponding entities and device entries remained in Home Assistant's device/entity registries, creating stale entries in the UI and configuration.\n\nThe fix makes three core changes:\n\n1. **Device removal handling in entities**:\n   - The base homematicip_cloud `GenericDevice` entity now tracks a flag `hmip_device_removed` to indicate that the underlying HomematicIP device has been removed.\n   - In `async_added_to_hass`, the entity registers two callbacks on the underlying HomematicIP device: `on_update` (existing) and `on_remove` (new) so it can react to both state changes and device removal.\n   - A new callback `_async_device_removed` sets `hmip_device_removed = True` and schedules the Home Assistant entity's own removal by calling `self.hass.async_create_task(self.async_remove())`.\n   - The entity implements `async_will_remove_from_hass`; if the removal is due to the HomematicIP device actually being deleted (`hmip_device_removed` is true), it calls `async_remove_from_registries`.\n   - `async_remove_from_registries`:\n     - Unregisters device callbacks (`remove_callback` for both update and remove callbacks) so HA no longer listens to an entity tied to a removed device.\n     - If the entity has an associated `device_id`, it loads the device registry and calls `device_registry.async_remove_device(device_id)`, which cascades and removes all associated entities from the entity registry.\n     - If there is no `device_id`, it directly removes the entity from the entity registry using `entity_registry.async_remove(entity_id)`.\n\n   This ensures that when a HomematicIP device is removed, its representation in HA's device and entity registries is cleaned up automatically.\n\n2. **Device and group creation handling via HAP (Home Access Point) wrapper**:\n   - The HomematicIP HAP wrapper (`hap.py`) now imports `EventType` from `homematicip.base.enums` and registers a creation callback: `home.on_create(self.async_create_entity)` in `get_hap`.\n   - The new callback `async_create_entity` receives events from HomematicIP, determines if the event refers to a device addition by checking `EventType(kwargs[\"event_type\"]) == EventType.DEVICE_ADDED`, and then schedules `async_create_entity_lazy(is_device)` as a task.\n   - `async_create_entity_lazy` delays entity creation when adding a device: if `is_device` is true, it waits 30 seconds (`await asyncio.sleep(30)`) before proceeding. This delay allows the end user to name/configure the device in the HomematicIP app before Home Assistant performs a reload, so HA can pick up the final, human-friendly name.\n   - After the optional delay, `async_create_entity_lazy` calls `self.hass.config_entries.async_reload(self.config_entry.entry_id)`, which triggers the HomematicIP_Cloud config entry to reload and discover new devices/groups.\n\n   As a result, newly added HomematicIP devices and groups appear in Home Assistant automatically, with a short delay, and without restarting HA.\n\n3. **Library update to support new events**:\n   - The integration's `manifest.json` and global requirements (`requirements_all.txt`, `requirements_test_all.txt`) are updated to require `homematicip==0.10.12` instead of `0.10.11`.\n   - This new version of the HomematicIP library provides the necessary `on_create` and `on_remove` events and corresponding enums used by the new callback-based behavior.\n\nOverall, the change transforms the HomematicIP_Cloud integration from a mostly static device discovery model (requiring restarts) into a more dynamic one that reacts to real-time HomematicIP events for device creation and removal, correctly managing Home Assistant's device and entity registries.",
        "semantic_memory": "This change illustrates several reusable integration patterns and best practices for Home Assistant (and similar event-based systems):\n\n1. **Dynamic device lifecycle management**:\n   - Integrations should react to upstream device lifecycle events (create/update/remove) instead of relying solely on periodic scans or manual restarts.\n   - Using callbacks (e.g., `on_create`, `on_update`, `on_remove`) from an underlying SDK, you can mirror the external system's state in Home Assistant in near-real time.\n   - For removals, it's important to distinguish between ordinary entity removal (e.g., the user disabling the entity in HA) and upstream device deletion. A flag (`hmip_device_removed`) is used here as a marker to trigger deeper registry cleanup only when the upstream device is actually removed.\n\n2. **Proper cleanup of device and entity registries**:\n   - Home Assistant maintains separate device and entity registries. If entities are tied to a device (`device_id` present), removing the device from the device registry will also remove all associated entities, which is often the cleanest approach for true hardware removal.\n   - If an entity is not associated with any device (no `device_id`), removing it directly from the entity registry is necessary.\n   - When an integration knows that the underlying device will never send updates again, it should both detach event callbacks and remove registry entries to avoid dangling references and stale UI elements.\n\n3. **Delayed reaction to external events to improve UX**:\n   - Immediate handling of create events can conflict with user workflows in the external system. In this case, new HomematicIP devices are often renamed or configured right after being added, so Home Assistant waits 30 seconds before reloading the config entry.\n   - Introducing a small, well-chosen delay between the upstream event and the integration's reload can allow external configuration to settle, so the integration discovers stable names and attributes instead of temporary placeholders.\n   - This pattern generalizes: when an external system emits event streams for resource creation, consider whether a delay or debouncing is beneficial before re-syncing.\n\n4. **Using config entry reload to resync devices**:\n   - For integrations that build their entity tree at config entry setup, reloading the config entry (`async_reload(entry_id)`) is a straightforward way to rescan and add new devices or groups.\n   - Instead of building ad-hoc logic for incremental additions, sometimes reusing the existing setup logic via reload is simpler and less error-prone, especially when the underlying library doesn't yet provide fine-grained discovery APIs.\n\n5. **Version pinning for library features**:\n   - When an integration relies on new callback types or enums from a third-party library (like `EventType.DEVICE_ADDED` and `on_create`/`on_remove` hooks), the integration must bump its required library version to guarantee availability of those APIs.\n   - This should be reflected both in the integration manifest and in global requirement files used for deployment and testing.\n\nOverall, the generalizable lesson is: when building a Home Assistant integration (or any adapter between an external device ecosystem and a local state model), design around the full resource lifecycle (create, update, delete) and tie into the platform’s registry and lifecycle hooks (`async_added_to_hass`, `async_will_remove_from_hass`) to keep state consistent without manual restarts.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Identify the symptom.\n- Observe that new devices or groups created in the upstream system (e.g., HomematicIP) are not appearing in Home Assistant until a restart.\n- Observe that devices removed upstream remain visible in the UI and/or remain in the device/entity registries.",
            "Step 2: Verify current integration behavior.\n- Inspect the integration's setup code to see how it discovers devices (often in `async_setup_entry` or similar).\n- Check whether it registers callbacks or listeners for upstream create/remove events, or if it only handles updates.\n- Confirm via logs or debugger whether any upstream events (e.g., device added/removed) are reaching the integration.",
            "Step 3: Check the underlying library capabilities.\n- Review the third-party library or SDK (here, `homematicip`) to see if it exposes callbacks or events for resource creation and removal (e.g., `on_create`, `on_remove`, specific `EventType` enums).\n- If the needed callbacks exist in a newer version of the library, plan to bump the dependency version in the integration’s manifest and global requirements.",
            "Step 4: Implement callbacks for creation and removal.\n- Register appropriate callbacks on the upstream home/device object (e.g., `home.on_create`, `device.on_remove`).\n- For updates, ensure existing callbacks (like `on_update`) are already wired and working.\n- In the removal callback for each entity:\n  - Set a flag (e.g., `self.hmip_device_removed = True`) to indicate the removal came from the upstream system.\n  - Schedule the entity removal in Home Assistant by calling `self.hass.async_create_task(self.async_remove())` (do not block in the callback).",
            "Step 5: Use lifecycle hooks to clean up registries.\n- Implement `async_will_remove_from_hass` on the entity and use it to perform cleanup when `hmip_device_removed` is true.\n- In this method:\n  - Unregister any callbacks from the upstream device (`remove_callback` for update/remove handlers) to avoid dangling references.\n  - Use `self.registry_entry` to see if there is a `device_id` attached.\n  - If there is a `device_id`, retrieve the device registry via `device_registry = await dr.async_get_registry(self.hass)` and call `device_registry.async_remove_device(device_id)`.\n  - If there is no `device_id`, retrieve the entity registry via `entity_registry = await er.async_get_registry(self.hass)` and remove the entity with `entity_registry.async_remove(entity_id)`.",
            "Step 6: Implement dynamic creation handling.\n- In the integration controller (e.g., HAP wrapper), implement a callback for upstream create events (e.g., `async_create_entity`).\n- Use the event payload to determine what was created (device vs. group) if necessary (e.g., using `EventType(kwargs[\"event_type\"])`).\n- Decide how to handle the creation in Home Assistant:\n  - Simple approach: reload the config entry using `self.hass.config_entries.async_reload(self.config_entry.entry_id)` so existing setup logic discovers new devices.\n  - If needed, schedule this reload via `self.hass.async_create_task` to avoid blocking.",
            "Step 7: Add delays or debouncing if user workflows require it.\n- If users typically rename or configure devices immediately after adding them in the upstream app, introduce a short delay before reloading discovery.\n- Implement an async helper (e.g., `async_create_entity_lazy`) that `await asyncio.sleep(<seconds>)` before calling `async_reload`.\n- Only delay where necessary (e.g., for physical device additions) to avoid slowing down other types of resource creation.",
            "Step 8: Update dependencies and manifests.\n- Bump the third-party library version in the integration’s `manifest.json` (e.g., `\"homematicip==0.10.12\"`).\n- Update global requirement files used by the project (`requirements_all.txt`, `requirements_test_all.txt`) to the same version.\n- Run any project-specific tooling (like `script.gen_requirements_all`) to regenerate derived requirement files if required by the development workflow.",
            "Step 9: Test end-to-end.\n- Start Home Assistant with the modified integration.\n- Add a new device or group in the upstream system; verify that after the expected delay or reload, the new device appears in HA with the correct name.\n- Remove a device in the upstream system; verify that the corresponding device and entities disappear from the UI and from both the device and entity registries (e.g., via the Developer Tools or configuration UI).\n- Confirm no errors in logs and that callbacks are unregistered (no further updates from removed devices).",
            "Step 10: Document the behavior.\n- Note in the integration documentation that devices/groups can be added or removed without restarting Home Assistant.\n- If there is a deliberate delay before new devices appear (e.g., 30 seconds to allow naming), mention this to set user expectations."
        ]
    }
}