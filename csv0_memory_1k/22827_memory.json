{
    "search_index": {
        "description_for_embedding": "Home Assistant Ambiclimate integration: initial climate platform implementation was rebased and reworked into a full config-entry-based component with OAuth2 config flow, proper token storage/refresh, service registration, manifest, and tests. Fixes included adding the ambiclimate dependency to requirements_all and requirements_test_all, robust handling of OAuth errors, correct climate API usage (current_humidity), and wiring the HTTP callback view for OAuth authorization.",
        "keywords": [
            "Home Assistant",
            "Ambiclimate",
            "climate",
            "config_flow",
            "OAuth2",
            "auth callback",
            "AmbiclimateOAuth",
            "ambiclimate==0.1.1",
            "requirements_all",
            "requirements_test_all",
            "token storage",
            "refresh_access_token",
            "AmbiclimateOauthError",
            "services.yaml",
            "HTTP view",
            "config entry",
            "integration tests"
        ]
    },
    "agent_memory": {
        "episodic_memory": "This PR introduced and stabilized the Ambiclimate smart AC integration for Home Assistant.\n\nInitially, Ambiclimate support existed as a simple climate platform under `homeassistant/components/climate/ambiclimate.py` with manual YAML config, a custom HTTP callback view, and in-file OAuth/token handling. During rebasing a previous PR, things were left in a broken or inconsistent state (e.g., duplicated coverage config, missing requirements wiring), so the author reopened and reworked the integration.\n\nThe fix consisted of several major refactors and cleanups:\n\n1. **Component split and config flow**\n   - The climate platform was moved under a new domain `ambiclimate` (`homeassistant/components/ambiclimate/climate.py`) and a package-level `__init__.py` plus `const.py` were introduced.\n   - A proper config flow (`config_flow.py`) was added using Home Assistant's `ConfigFlow` API. It:\n     - Registers a single Ambiclimate implementation via `register_flow_implementation(hass, client_id, client_secret)` using YAML config from `configuration.yaml`.\n     - Exposes an `auth` step that shows a form with an Ambiclimate OAuth authorization URL and the callback URL.\n     - Implements a dedicated HTTP callback view (`AmbiclimateAuthCallbackView`) that receives the `code` query parameter and triggers `config_entries.flow.async_init` with source `code`.\n     - Handles the `code` in `async_step_code`, exchanges it for an access token via `AmbiclimateOAuth.get_access_token`, persists it using `hass.helpers.storage.Store(STORAGE_VERSION, STORAGE_KEY)`, and creates a config entry containing the client id, secret, and computed callback URL.\n     - Robustly aborts in situations like: already configured (`already_setup`), no base config (`no_config`), or access token failures (`access_token`).\n\n2. **Token handling and climate entity behavior**\n   - Token management was moved from ad-hoc platform logic to using `hass.helpers.storage.Store` with a stable key `ambiclimate_auth`.\n   - On `async_setup_entry`, the integration:\n     - Loads any stored token_info from storage.\n     - Constructs an `AmbiclimateOAuth` instance using the stored client id/secret and callback URL.\n     - Attempts to refresh the access token via `oauth.refresh_access_token(token_info)`, gracefully logging and returning early if an `AmbiclimateOauthError` occurs (avoiding crashes).\n     - Saves any updated token_info back to storage.\n     - Creates an `AmbiclimateConnection` and calls `find_devices()`; if no devices are found, logs an error and exits.\n     - Updates device info concurrently for all discovered heaters, then instantiates `AmbiclimateEntity` objects for each device and adds them to Home Assistant.\n   - The climate entity was updated to:\n     - Expose proper `device_info` (identifiers, name, manufacturer) for device registry.\n     - Switch from `device_state_attributes` to `current_humidity`, matching modern climate API expectations.\n     - Implement `is_on`, `target_temperature`, `current_temperature`, `min_temp`, `max_temp`, and `current_operation` according to Ambiclimate's `heater` API.\n     - Handle token refresh in `async_update` via `self._heater.control.refresh_access_token()`, catching `AmbiclimateOauthError` and only writing back updated token info if present, then updating the local `_data` via `heater.update_device()`.\n\n3. **Services and schemas**\n   - Three Ambiclimate-specific climate services were defined:\n     - `ambiclimate.set_comfort_mode(name)`\n     - `ambiclimate.send_comfort_feedback(name, value)`\n     - `ambiclimate.set_temperature_mode(name, value)`\n   - The services use strict voluptuous schemas: `ATTR_NAME` is required; `ATTR_VALUE` is required where applicable and retrieved from `service.data[...]` (not `.get`) to ensure validation.\n   - They locate the corresponding device via `data_connection.find_device_by_room_name(device_name)` and call the relevant `ambiclimate` library methods.\n   - A `services.yaml` file was added to describe these services to users, including allowed feedback values and examples.\n\n4. **Manifest and requirements wiring**\n   - A `manifest.json` was introduced for the Ambiclimate component specifying `ambiclimate==0.1.1` as the dependency and linking documentation.\n   - `requirements_all.txt` was updated with `ambiclimate==0.1.1` under the `ambiclimate` component.\n   - `requirements_test_all.txt` and `script/gen_requirements_all.py` were updated to include `ambiclimate` in `TEST_REQUIREMENTS`. This ensures CI installs the library for tests that import it, fixing test failures such as `ModuleNotFoundError: No module named 'ambiclimate'` during `tox` runs.\n\n5. **Tests and coverage**\n   - A test module `tests/components/ambiclimate/test_config_flow.py` was added with comprehensive tests:\n     - Aborting when no Ambiclimate implementation is registered (`no_config`).\n     - Aborting when Ambiclimate is already set up (`already_setup`).\n     - Testing the full flow: `async_step_user` returns a form with an appropriate callback URL and OAuth authorization link, and `async_step_code` creates a config entry with correct data when `get_access_token` returns a token.\n     - Exercising error paths when `get_access_token` returns `None` or raises `AmbiclimateOauthError`, both resulting in an `access_token` abort.\n     - Verifying that the HTTP view returns `\"OK!\"` when a code is provided and `\"No code\"` otherwise, and that it calls `config_entries.flow.async_init` correctly.\n   - The coverage config was adjusted to omit `ambiclimate/climate.py` due to external API interactions, avoiding coverage noise.\n\n6. **Misc cleanups**\n   - Fixed typo/wording in translations and strings (`\"Please follow this link\"`, `cb_url` placeholder).\n   - Corrected and stabilized constants (storage key, domain, service names).\n   - Added `CODEOWNERS` entry for `homeassistant/components/ambiclimate/*` pointing to `@danielhiversen`.\n   - Removed duplicate omit entries in `.coveragerc` and minor style fixes (imports, formatting, and avoiding dead code).\n\nOverall, the broken or incomplete Ambiclimate integration (after a bad rebase) was turned into a first-class Home Assistant integration with a proper config flow, stable OAuth handling, services, tests, and dependency wiring. This also addressed issues like tests failing due to missing `ambiclimate` in test requirements and potential runtime crashes from mismanaged OAuth/token operations.",
        "semantic_memory": "This PR illustrates several generalizable practices for integrating third-party, OAuth-backed devices into Home Assistant or similar platforms:\n\n1. **Separate integration domain and platform-specific logic**\n   - Create a dedicated component/domain (e.g., `ambiclimate`) rather than embedding everything into a single platform module. This allows you to:\n     - Centralize constants and configuration schema (`const.py` and `__init__.py`).\n     - Implement a config flow that owns the auth/registration process.\n     - Host multiple platforms (climate, sensors, etc.) under one domain if needed.\n\n2. **Use config entries and config flows for cloud/OAuth integrations**\n   - Rely on `ConfigFlow` instead of manual, ad-hoc configurators or custom HTTP flows. This ensures:\n     - A uniform user experience for authentication and setup.\n     - Built-in handling of multiple configuration sources (UI, discovery, re-auth).\n     - Easier testing and maintenance.\n   - Provide clear abort reasons (`already_setup`, `no_config`, `access_token`) and map them to HA's translation strings for good UX.\n\n3. **Token storage and refresh best practices**\n   - Store OAuth token information using the host's storage utilities (here, `hass.helpers.storage.Store` with a versioned key) rather than custom files.\n   - Perform token refreshes in a centralized manner (e.g., inside `async_setup_entry` and entity `async_update` methods), and always:\n     - Catch provider-specific errors (e.g., `AmbiclimateOauthError`) and log them.\n     - Avoid crashing the main loop on refresh failures; instead, fail gracefully and allow later retries or re-auth.\n     - Persist updated token info if the refresh was successful, so subsequent requests use fresh credentials.\n\n4. **Robust HTTP callback handling for OAuth**\n   - Implement callback views that:\n     - Validate the presence of expected parameters (`code` in query string).\n     - Return useful plain-text responses (e.g., `\"OK!\"` vs `\"No code\"`) to support user debugging.\n     - Pass control back into the config flow (`config_entries.flow.async_init`) rather than completing configuration logic inside the view itself.\n   - Keep views idempotent and stateless aside from posting events back into the core.\n\n5. **Service registration and validation**\n   - When exposing custom services for user automations, define them with:\n     - Voluptuous schemas, using `vol.Required` and explicit field names.\n     - Domain-specific constants (`ATTR_NAME`, `ATTR_VALUE`) to avoid magic strings.\n     - Strong typing and constraints enforced at the schema level, so service handlers can safely assume parameters are present.\n   - Implement service handlers that resolve domain devices (e.g., by room name) via your data connection and then call library methods. If no device is found, simply no-op rather than raising.\n\n6. **Align entity model with platform API evolution**\n   - As the platform evolves (e.g., Home Assistant climate API), adapt to new attribute names and patterns:\n     - Use `current_humidity` instead of `device_state_attributes` to represent humidity.\n     - Implement `device_info` for device registry integration (identifiers, manufacturer, name).\n   - Keep supported features and state properties in sync with what the underlying device actually supports.\n\n7. **Testing OAuth flows and views**\n   - For integrations that depend on external OAuth providers, isolate the OAuth client in tests by mocking methods like `get_access_token()` and `get_authorize_url()`.\n   - Test not just the happy path but also error branches: when tokens are missing, invalid, or when the library raises exceptions.\n   - Test HTTP views using lightweight mock requests (e.g., `aiohttp.MockRequest`) to verify they handle query strings and integrate back into the host's flow system.\n\n8. **Dependency management for CI**\n   - When tests import third-party libraries, ensure those libs are listed in both production requirements and the test requirements (`requirements_all.txt` and `requirements_test_all.txt`).\n   - For Home Assistant specifically, also add the integration module name to `TEST_REQUIREMENTS` in `script/gen_requirements_all.py` to guarantee the dependency is installed during CI runs.\n\n9. **Incremental refactoring and style fixes**\n   - Large integration PRs often require multiple follow-up commits to fix style issues, coverage configuration, and test flakiness. It's normal to:\n     - Clean up `.coveragerc` to omit modules that are hard to test or rely heavily on external APIs.\n     - Add `CODEOWNERS` entries for long-term ownership.\n     - Iterate on tests as the config flow behavior stabilizes.\n\nAltogether, this illustrates a template for building robust, OAuth-backed integrations: clear separation of concerns (config flow vs platform logic), reliable token handling and storage, well-defined services, and matching test coverage plus dependency wiring.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues involving a new OAuth-based integration in Home Assistant that fails tests or behaves inconsistently:",
            "Step 1: Isolate the integration domain and configuration model",
            "- Create a dedicated component directory (e.g., `homeassistant/components/your_integration/`) with `__init__.py`, `const.py`, `manifest.json`, platform modules (`climate.py`, etc.), translations, and `services.yaml` if needed.",
            "- Move any platform-only implementation (e.g., an old `climate/your_integration.py`) into the new domain and update imports accordingly.",
            "- Define a `DOMAIN` constant and any other shared constants in `const.py`.",
            "",
            "Step 2: Implement or refactor the config flow",
            "- Subclass `config_entries.ConfigFlow` to implement `async_step_user` and any additional steps (`async_step_auth`, `async_step_code`, etc.).",
            "- In `async_step_user`, enforce a single-account model by aborting with `already_setup` if `self.hass.config_entries.async_entries(DOMAIN)` is non-empty.",
            "- Pull client id/secret from YAML configuration via a helper like `register_flow_implementation(hass, client_id, client_secret)` and abort with `no_config` if they're missing.",
            "- In the authorization step, build and display an OAuth authorization URL and the callback URL as description placeholders. Ensure the HTTP view for the callback is registered once.",
            "- In the step that processes the authorization `code`, call the OAuth client's `get_access_token(code)`, handle errors, and abort with a useful reason (`access_token`) if retrieval fails.",
            "- On success, store the resulting configuration (including callback URL) in a config entry via `self.async_create_entry()`.",
            "",
            "Step 3: Implement robust token storage and refresh",
            "- Use `hass.helpers.storage.Store(version, key)` to persist token information instead of managing files manually.",
            "- On setup (`async_setup_entry`):",
            "  - Load token info from storage.",
            "  - Instantiate the OAuth client with client id, secret, callback URL, and a shared `aiohttp` session.",
            "  - Attempt `refresh_access_token(token_info)` inside a try/except for the provider-specific error class (e.g., `AmbiclimateOauthError`).",
            "  - If refresh fails, log and return without raising, so the integration doesn't crash Home Assistant.",
            "  - When a new token is returned, save it back into storage and update the in-memory token info.",
            "  - Construct your API/connection object using the updated OAuth client and token info.",
            "",
            "Step 4: Discover devices and create entities",
            "- Use your API client to discover devices via a method like `find_devices()`. If it returns false or an empty list, log an error and exit setup.",
            "- For each discovered device, perform any required info updates (e.g., `heater.update_device_info()`), possibly concurrently using `asyncio.wait`.",
            "- Create entity instances (e.g., `AmbiclimateEntity`) that wrap each device and pass any objects they need (e.g., storage object) to the constructor.",
            "- Call `async_add_entities(entities, True)` to register them with Home Assistant.",
            "",
            "Step 5: Register and validate services",
            "- For each custom operation you want to expose (e.g., comfort mode, temperature mode):",
            "  - Define a voluptuous schema specifying required fields (like `ATTR_NAME` and `ATTR_VALUE`).",
            "  - Implement an async service handler that:",
            "    - Retrieves required data from `service.data[...]` (not `.get`), relying on schema validation to guarantee presence.",
            "    - Locates the target device using your connection object (e.g., `find_device_by_room_name`).",
            "    - Calls the appropriate API method (e.g., `set_comfort_mode`, `set_comfort_feedback`, `set_temperature_mode`).",
            "    - Does nothing (or logs) if no device is found, instead of throwing exceptions.",
            "  - Register the service with `hass.services.async_register(DOMAIN, SERVICE_NAME, handler, schema=schema)`.",
            "- Document these services in `services.yaml` so they appear correctly in the UI and docs.",
            "",
            "Step 6: Align entities with the platform API",
            "- Implement properties such as `unique_id`, `name`, `temperature_unit`, `target_temperature`, `current_temperature`, `min_temp`, `max_temp`, and supported features to match your device capabilities and the Home Assistant climate API.",
            "- Use the newer climate API properties (e.g., `current_humidity`) instead of old `device_state_attributes` where appropriate.",
            "- Provide `device_info` with identifiers `(DOMAIN, unique_id)` plus manufacturer and friendly name, to integrate with the device registry.",
            "- In `async_update`, handle token refresh and device data update in one place: refresh token (with error handling) then call `update_device()` and store returned state in a local dict.",
            "",
            "Step 7: Wire dependencies for both runtime and tests",
            "- Add your external library (e.g., `ambiclimate==0.1.1`) to `manifest.json` under `requirements`.",
            "- Add it to `requirements_all.txt` under the appropriate component header.",
            "- Add it to `requirements_test_all.txt` and `TEST_REQUIREMENTS` in `script/gen_requirements_all.py` to ensure it is available during CI test runs.",
            "- If some modules are very hard to test or rely heavily on external APIs, consider excluding them from coverage in `.coveragerc` to avoid test instability and noise.",
            "",
            "Step 8: Write targeted tests for config flow and HTTP views",
            "- Use the test harness (e.g., `tests/components/your_integration/test_config_flow.py`) to:",
            "  - Test `async_step_user` aborting when no implementation is registered and when already configured.",
            "  - Test that `async_step_user` returns a form with correct placeholders (callback URL, OAuth URL) when config is present.",
            "  - Mock `OAuth.get_access_token()` to return a token and verify that `async_step_code` creates the expected config entry.",
            "  - Mock `OAuth.get_access_token()` to return `None` or raise the provider's error to ensure `async_step_code` aborts with the correct reason.",
            "  - Test the HTTP callback view by creating mock requests with and without `code` in the query and asserting returned strings and that `config_entries.flow.async_init` is called with expected data.",
            "",
            "Step 9: Address user-facing issues and improve robustness",
            "- If users report runtime errors (e.g., `NoneType has no attribute 'lower'` on state checks), inspect how device data is stored on the entity (`self._data`) and add appropriate defaults or guards before calling methods on values.",
            "- For any part of the integration that depends on optional keys or third-party responses, guard against missing or `None` values and log gracefully.",
            "- Keep translations (`.translations/en.json` and `strings.json`) aligned with flow abort reasons and step ids so users see accurate error messages.",
            "",
            "By following these steps, you can systematically diagnose and fix issues in an OAuth-based Home Assistant integration, ensuring stable configuration, reliable token handling, solid testing, and a good user experience."
        ]
    }
}