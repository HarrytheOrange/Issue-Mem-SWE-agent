{
    "search_index": {
        "description_for_embedding": "Added remote TCP/IP support to the Home Assistant DSMR sensor platform by introducing an optional 'host' configuration. When 'host' is empty, DSMR data is read from a local serial/USB port as before. When 'host' is set, the 'port' is treated as a TCP port and an asyncio DSMR protocol connection is created to a remote ser2net-like bridge. Implementation includes a new create_dsmr_connection helper using asyncio.loop.create_connection and DSMRProtocol, while preserving backward compatibility.",
        "keywords": [
            "DSMR",
            "Home Assistant",
            "remote sensor",
            "TCP/IP",
            "ser2net",
            "asyncio",
            "create_connection",
            "serial to network bridge",
            "configuration schema",
            "backward compatibility"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, a user wanted Home Assistant's DSMR sensor platform to read smart meter data not only from a local serial/USB port, but also from a remote machine exposing the serial port over TCP/IP via a tool like ser2net. Previously, the DSMR integration only supported local serial ports configured via the 'port' setting.\n\nTo solve this, the developer extended the DSMR sensor configuration schema by adding an optional 'host' field (default empty string) alongside the existing 'port' field. The logic in async_setup_platform was adjusted so that if 'host' remains empty, the code behaves exactly as before, using create_dsmr_reader with the 'port' interpreted as a local serial device. If 'host' is non-empty, the system instead calls a new helper, create_dsmr_connection(host, port, dsmr_version, telegram_callback, loop), which treats 'port' as a TCP port and opens a remote connection.\n\nThe create_dsmr_connection function uses dsmr_parser's telegram_specifications and parser classes (TelegramParser, TelegramParserV2_2) plus DSMRProtocol. It selects the correct parser depending on dsmr_version ('2.2' or '4') and then builds an asyncio protocol factory using functools.partial(DSMRProtocol, loop, telegram_parser(specifications), telegram_callback=telegram_callback). It returns loop.create_connection(protocol, host, port), which establishes a TCP connection to the remote host. Minor cleanups removed an unused socket import and fixed function signature spacing.\n\nAlthough this specific PR was later closed in favor of another upstream implementation already in progress, it encapsulates the pattern for adding optional remote TCP support while keeping the original local serial behavior intact.",
        "semantic_memory": "This change illustrates a common pattern for extending a hardware/IO integration from local-only access to optional remote access while preserving backward compatibility and minimizing disruption to existing users.\n\nKey generalizable concepts:\n\n1. **Optional remote endpoint configuration**: Introduce a 'host' configuration parameter with a neutral default (such as an empty string or null) that indicates 'local mode'. When the parameter is populated, the system switches to 'remote mode' and interprets existing fields (like 'port') differently (e.g., TCP port vs serial device path).\n\n2. **Preserve old behavior by default**: Default values and conditional logic should ensure that existing configurations continue to behave exactly as before. New functionality is opt-in. Here, leaving 'host' empty keeps using the original serial reader.\n\n3. **Separate connection helpers**: Implement distinct helper functions for different transport types (e.g., create_dsmr_reader for serial, create_dsmr_connection for TCP). This isolates transport-specific logic and makes the main setup function easier to reason about.\n\n4. **Async protocol and factory pattern**: Use asyncio's loop.create_connection alongside a protocol factory built with functools.partial to parameterize protocol instances (e.g., passing in parser and callbacks). This keeps protocol initialization flexible and avoids ad-hoc global state.\n\n5. **Version-based parser selection**: When protocols evolve (DSMR 2.2 vs 4), switch parsers based on a configuration value and a well-defined mapping from version -> parser + specification. This keeps parsing logic extensible.\n\n6. **Minimal, focused changes**: The patch adds a new feature with minimal code changes: one new config option, one new helper, and a small branch in the setup function. This limits regression risk and simplifies review.\n\n7. **Clean up unused imports and style nits early**: Removing unused imports (like socket) and fixing minor style issues (spacing in function signatures) keeps modules clean and can prevent confusion about intended transport mechanisms.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Clarify the requirement and constraints\n- Identify whether the integration currently only supports local connections (e.g., serial/USB port) and whether there is a need to support remote access (e.g., via TCP/IP and a serial-to-network bridge like ser2net).\n- Determine which configuration fields are already in use (e.g., 'port') and how they are interpreted (device path vs TCP port). Decide how to add new configuration while preserving existing behavior.",
            "Step 2: Extend the configuration schema safely\n- Add a new optional configuration parameter such as 'host' with a default that clearly indicates 'local mode' (e.g., empty string or null).\n- Keep the existing 'port' configuration in place; do not change its meaning for existing setups. Only reinterpret it when 'host' is explicitly set.\n- Update the platform schema (or equivalent configuration validation) to include the new parameter and provide conservative defaults.",
            "Step 3: Introduce a transport-specific connection helper\n- Implement a new function that encapsulates the logic for the new transport (e.g., create_dsmr_connection(host, port, version, callback, loop)).\n- Inside this helper, select the correct protocol/parsing classes based on configuration (e.g., DSMR version) and construct an asyncio Protocol factory using functools.partial or a closure.\n- Use asyncio loop.create_connection (for TCP) or the appropriate API for your framework, returning the coroutine/future that establishes the connection.",
            "Step 4: Preserve the existing local behavior with conditional logic\n- In the main setup or initialization function (e.g., async_setup_platform), branch based on the new configuration parameter:\n  - If host is empty/unset: call the existing local-connection helper (e.g., create_dsmr_reader) using the 'port' as a serial device path.\n  - If host is set: call the new remote-connection helper, treating 'port' as a TCP port.\n- Ensure the rest of the pipeline (callbacks, entity updates, etc.) is identical in both branches so that everything downstream stays unchanged.",
            "Step 5: Integrate with the event loop and lifecycle\n- Wrap the connection coroutine in the framework's task creation mechanism (e.g., hass.loop.create_task) and await it in your async setup as needed.\n- Register appropriate cleanup handlers (e.g., on EVENT_HOMEASSISTANT_STOP) to close the transport regardless of whether it's serial or TCP.",
            "Step 6: Test both modes thoroughly\n- Test with an existing local serial configuration to confirm no behavior regressions.\n- Set up a remote serial-to-TCP bridge (like ser2net), configure host and port, and verify that data is received and parsed correctly in remote mode.\n- Test different protocol versions (e.g., DSMR 2.2 and 4) to validate the version-based parser selection.",
            "Step 7: Refine and clean up the implementation\n- Remove any imports that are no longer used (e.g., socket if you rely only on asyncio's TCP APIs).\n- Fix minor code style issues (spacing, naming) to keep the codebase consistent and maintainable.\n- Document the new configuration options with clear examples (e.g., example YAML showing host + port for TCP and port-only for local)."
        ]
    }
}