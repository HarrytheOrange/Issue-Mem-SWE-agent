{
    "search_index": {
        "description_for_embedding": "Test suite against MongoDB was slow and inconsistent on Travis CI. The fix reconfigures CI to download and run a specific MongoDB version with performance flags (nojournal, syncdelay, WiredTiger options), optionally on ramdisk, removes reliance on the Travis MongoDB service/apt packages, and optimizes test DB setup/teardown by dropping the whole database instead of each collection and avoiding redundant ensure_indexes calls.",
        "keywords": [
            "MongoDB",
            "Travis CI",
            "test performance",
            "WiredTiger",
            "ramdisk",
            "nojournal",
            "syncdelay",
            "--notablescan",
            "db_setup",
            "db_ensure_indexes",
            "drop_database",
            "drop_collection",
            "continuous integration",
            "st2tests",
            "Python tests"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the team noticed that tests using MongoDB on Travis CI were slower than expected and that a previously used optimization (`--notablescan` and other MongoDB options) had been inadvertently removed along with other perf-related changes. The CI environment relied on the Travis-provided MongoDB service and apt-installed packages, which made it harder to control MongoDB version and startup options.\n\nThe fix was implemented in two main areas:\n\n1) **CI / MongoDB startup changes**\n- Introduced a `MONGODB_VERSION` environment variable (set to `3.4.16`) in `.travis.yml`.\n- Stopped using the Travis `mongodb` service and MongoDB apt packages by commenting them out.\n- Added a custom script `scripts/travis/install-and-run-mongodb.sh` that:\n  - Validates that `MONGODB_VERSION` is set.\n  - Downloads the matching MongoDB tarball from `fastdl.mongodb.org` into `/tmp/mongodb.tgz`.\n  - Extracts it into `/tmp/mongodb` (referred to as `MONGODB_DIR`).\n  - Creates a MongoDB data directory (initially with logic for `/mnt/ramdisk/mongodb` vs `/tmp/mongodbdata`; later forced to `/tmp/mongodbdata` again while ramdisk usage was being evaluated).\n  - Symlinks the downloaded `mongo` shell binary into `/usr/local/bin/mongo` and `/usr/bin/mongo` so `mongo --version` reflects the downloaded version.\n  - Starts `mongod` with performance options: `--nojournal`, `--journalCommitInterval 500`, `--syncdelay 0`, `--wiredTigerStatisticsLogDelaySecs 0`, `--noIndexBuildRetry`, `--noscripting`, binding to `127.0.0.1` and logging to `/tmp/mongodb.log`.\n  - Initially attempted to use `--notablescan` to catch indexless queries early, but this was temporarily commented out to first evaluate performance and because tests were failing due to missing indexes.\n  - Fixes several bugs in early revisions: using the correct `MONGODB_VERSION` variable instead of `MONGODB`, fixing a bad symlink path that mistakenly used `${MONGODB_PID}`, correcting the success exit code (0 instead of 9), and improving log output.\n- `.travis.yml` was updated so that for all tasks, Travis:\n  - Runs `sudo -E ./scripts/travis/create-and-mount-ramdisk.sh` (for potential FS speedup), and\n  - Runs `./scripts/travis/install-and-run-mongodb.sh` to start MongoDB.\n- A `before_script` step `mongo --version` was added to verify that the custom `mongo` shell is available and correct.\n\n2) **Test harness MongoDB usage changes (`st2tests/st2tests/base.py`)**\n- In `BaseDbTestCase._establish_connection_and_re_create_db`, the code previously:\n  - Established a DB connection with `db_setup(..., ensure_indexes=False)`,\n  - Dropped every collection individually via `cls._drop_collections()`, then\n  - Called `db_connection.drop_database(...)` and finally `db_ensure_indexes()`.\n- This per-collection dropping and explicit `db_ensure_indexes()` was originally needed for older MongoDB versions and storage engines.\n- With MongoDB 3.x and WiredTiger, dropping the database itself safely removes all collections in one step, and synchronous index ensuring is no longer necessary for tests.\n- The updated logic:\n  - Connects with `ensure_indexes=False` via `db_setup`.\n  - Skips `cls._drop_collections()` when recreating the DB (the call is commented out with explanation that WiredTiger handles drop_database correctly).\n  - Drops the database directly with `cls.db_connection.drop_database(cfg.CONF.database.db_name)`.\n  - Only calls `db_ensure_indexes()` if a new class attribute `ensure_indexes` is `True`.\n- `BaseDbTestCase` now defines `ensure_indexes = False` by default with a clarifying comment that synchronous index ensuring after `db_setup` is only needed for older MongoDB versions and that skipping it yields significant test speedups in newer versions.\n- `_drop_db` is also updated to no longer drop collections one-by-one before dropping the database; the per-collection drop is commented out with notes about WiredTiger.\n- `DbTestCase` no longer defines its own `ensure_indexes`; it inherits the default from `BaseDbTestCase`.\n\nOverall, this PR re-established a controlled, optimized MongoDB setup for CI, stopped relying on Travis's default MongoDB, reduced redundant collection/index operations in test setup/teardown, and laid groundwork to re-enable `--notablescan` in a follow-up PR once index issues are fixed. The net effect is cleaner, faster MongoDB-backed tests with more predictable behavior.",
        "semantic_memory": "This fix illustrates several general patterns and best practices for working with MongoDB in automated test environments and CI systems:\n\n1) **Explicitly control your database version and startup parameters in CI**\n- Relying on a CI provider's default DB service or distro packages can lead to performance variability and configuration drift (different versions, options, and storage engines across environments).\n- Downloading a specific version of a database directly (e.g., MongoDB tarball) and starting it from a script ensures consistent behavior and allows fine control over options like journaling, sync delay, and diagnostic flags.\n\n2) **Optimize MongoDB for ephemeral test workloads**\n- For CI/tests, durability guarantees (journaling, disk sync intervals) are much less important than speed:\n  - `--nojournal` and small `--journalCommitInterval` and `--syncdelay 0` reduce I/O overhead at the cost of durability, which is acceptable for disposable test data.\n  - Using a tmpfs or ramdisk for DB storage can remove disk bottlenecks entirely, as long as the engine and version support small files and limited space.\n- Engine-specific options like `--wiredTigerStatisticsLogDelaySecs 0`, `--noIndexBuildRetry`, and `--noscripting` can reduce overhead and attack surface when the DB is used only by the tests.\n\n3) **Use strict options (like `--notablescan`) to catch query/index regressions**\n- Enabling `--notablescan` (or equivalent strictness options) causes queries that would result in collection scans to fail, surfacing missing indexes or bad query patterns during tests rather than in production.\n- This kind of strict option can be temporarily disabled while you measure performance or fix regressions, but having it in CI is a powerful way to keep data access patterns efficient and safe.\n\n4) **Adjust test DB lifecycle for modern engines**\n- Older MongoDB versions and storage engines had quirks that made it safer to drop collections one by one, or required more manual index management.\n- With newer MongoDB versions and WiredTiger, dropping the database (`drop_database`) is sufficient to clear all collections and indexes in a test DB, making per-collection `drop_collection` calls redundant and slow.\n- Explicitly synchronously ensuring indexes (`db_ensure_indexes`) on every setup can be expensive and may not be necessary if indexes are created at model definition time or lazily on first use. Making this behavior configurable via a flag (e.g., `ensure_indexes`) allows tests that truly require it to opt in while keeping the default fast.\n\n5) **Design test infrastructure to be version-aware and engine-aware**\n- Comments and conditional logic in the test base layer acknowledge that some behaviors are required only for older MongoDB versions. Parameterizing this (e.g., `ensure_indexes`) and documenting it makes future migrations easier.\n- When upgrading DB versions or engines, it's valuable to revisit long-standing workarounds (like collection-by-collection drops) to remove unnecessary overhead.\n\n6) **Validate your CI wiring with explicit version checks and logs**\n- Running `mongo --version` and tailing the DB log after startup is a simple way to confirm that the intended binary is in use and that startup options are effective.\n- Scripts should return accurate exit codes and provide enough logging so CI can fail fast when DB startup fails and developers can quickly see why.\n\nOverall, the pattern is: control, simplify, and specialize the database configuration for the test context instead of inheriting production or CI-default settings, and revisit legacy test setup/teardown practices when upgrading underlying database technology.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Detect that MongoDB-backed tests are slow or flaky in CI\n- Measure total test runtime and identify whether MongoDB-heavy suites are dominating.\n- Check CI logs to see how MongoDB is being started (CI service vs custom script vs OS package) and which version/options are actually in use (run `mongo --version` or similar in CI).\n- Look for frequent collection drops, index-building logs, or full collection scans in MongoDB logs as signs of inefficiency.",
            "Step 2: Take control of MongoDB version and startup in CI\n- Stop relying on the CI provider's MongoDB service if you need specific options or versions.\n- Introduce an environment variable like `MONGODB_VERSION` in your CI configuration.\n- Add a setup script (e.g., `scripts/ci/install-and-run-mongodb.sh`) that:\n  - Validates `MONGODB_VERSION` is set.\n  - Downloads the corresponding MongoDB tarball from the official download URL.\n  - Extracts it into a known directory (e.g., `/tmp/mongodb`).\n  - Optionally symlinks the `mongo` shell into `/usr/local/bin` or similar so `mongo` resolves to your downloaded version.\n  - Starts `mongod` with explicit, test-optimized options and logs to a known file.\n  - Waits briefly, verifies that `mongod` is running (e.g., via `ps` or a health check), and exits with a non-zero status and tail of the log on failure.",
            "Step 3: Optimize MongoDB settings for test environments\n- Configure `mongod` with options that prioritize speed over durability:\n  - `--nojournal` to disable journaling.\n  - `--journalCommitInterval` tuned for tests (often larger intervals or no journaling at all).\n  - `--syncdelay 0` to avoid periodic fsyncs.\n- For WiredTiger, consider further options:\n  - `--wiredTigerStatisticsLogDelaySecs 0` to avoid periodic stats logging.\n  - `--noIndexBuildRetry` and `--noscripting` to limit unnecessary overhead.\n- If feasible, configure the data directory on a ramdisk or tmpfs (e.g., `/mnt/ramdisk/mongodb`), ensuring the MongoDB version and engine support the filesystem characteristics and size.",
            "Step 4: Use strict validation options like --notablescan (when ready)\n- Once the DB and tests are stable, enable `--notablescan` or similar options to ensure that all queries use indexes.\n- Run the test suite and note where tests fail due to queries causing a table scan.\n- For each failing query, add or fix the relevant MongoDB index and update your data model or migrations.\n- Keep `--notablescan` enabled in CI to guard against future regressions.",
            "Step 5: Simplify test DB lifecycle operations\n- Review how your test framework sets up and tears down the MongoDB database between tests or test classes.\n- If you are on a modern MongoDB version with WiredTiger:\n  - Prefer dropping the whole database (`drop_database`) instead of dropping every collection individually.\n  - Remove or comment out per-collection `drop_collection` loops unless there is a specific reason to keep them (and document that reason if so).\n- Make index management configurable:\n  - Introduce a flag (e.g., `ensure_indexes` on a base test class) that controls whether `db_ensure_indexes()` is called.\n  - Default this flag to `False` for speed in most tests, and enable it only for tests that depend on synchronous index creation.",
            "Step 6: Refactor the test base classes to match the new behavior\n- In your base DB test class:\n  - In the setup path (e.g., `_establish_connection_and_re_create_db`), connect to MongoDB via a helper like `db_setup`, usually with `ensure_indexes=False`.\n  - Drop the entire test database (`drop_database`) rather than iterating through models and calling `drop_collection`.\n  - After dropping the database, call `db_ensure_indexes()` only if the `ensure_indexes` flag is `True`.\n- In the teardown path (e.g., `_drop_db`):\n  - Avoid redundant per-collection drops and simply call `drop_database` if a connection exists.\n  - Always call a teardown helper (e.g., `db_teardown()`) to cleanly close connections.\n- Document in comments that these choices depend on the MongoDB version and storage engine, so future maintainers know when it's safe to remove legacy workarounds.",
            "Step 7: Verify and iterate\n- Update CI configuration (`.travis.yml`, GitHub Actions workflow, etc.) to:\n  - Run the MongoDB install/start script during the install or before_script phase.\n  - Optionally run `mongo --version` as a sanity check.\n- Run the full test suite and compare runtimes before and after the changes.\n- Inspect MongoDB logs to confirm there are fewer index build operations, no unnecessary collection drops, and no startup errors.\n- If test failures arise from changed DB behavior (e.g., stricter indexing rules), fix the underlying data access patterns rather than weakening the DB configuration.",
            "Step 8: Keep scripts robust and transparent\n- Ensure your DB start script uses the correct environment variables consistently and exits with appropriate status codes.\n- Log key actions (download URL, data directory, symlink targets, startup options) so failures are easy to debug.\n- Tail the last part of the DB log on both success and failure as needed to expose startup details in CI logs."
        ]
    }
}