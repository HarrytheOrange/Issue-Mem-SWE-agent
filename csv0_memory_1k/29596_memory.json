{
    "search_index": {
        "description_for_embedding": "Home Assistant dwd_weather_warnings sensor failed to set up because the DWD REST API endpoint rejected requests without a User-Agent header. The fix was to pass an explicit User-Agent header to RestData, using Home Assistant's global SERVER_SOFTWARE user agent constant instead of a hardcoded string.",
        "keywords": [
            "Home Assistant",
            "dwd_weather_warnings",
            "RestData",
            "User-Agent header",
            "HTTP 4xx",
            "setup error",
            "SERVER_SOFTWARE",
            "aiohttp_client",
            "integration initialization failure",
            "REST API requires User-Agent"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant integration `dwd_weather_warnings` failed to set up correctly. Users were seeing a setup error traced back to calls to the DWD REST API. The API endpoint silently required a `User-Agent` HTTP header, and when Home Assistant made the request without this header via `RestData`, the endpoint did not respond as expected, causing the platform setup to fail.\n\nThe initial fix added a hardcoded \"dummy\" User-Agent header (`{\"User-Agent\": \"HomeAssistant/0.103.0\"}`) when constructing `RestData` in `homeassistant/components/dwd_weather_warnings/sensor.py`. This ensured the API accepted the request and eliminated the setup error.\n\nAfter review, the solution was improved to avoid hardcoding a version-specific string. Instead, the code imported `SERVER_SOFTWARE` from `homeassistant.helpers.aiohttp_client`, which is the global Home Assistant user-agent string used elsewhere. The import was aliased to `HA_USER_AGENT` for clarity:\n\n- `from homeassistant.helpers.aiohttp_client import SERVER_SOFTWARE as HA_USER_AGENT`\n\nThen, the sensor's REST client was created with:\n\n- `headers = {\"User-Agent\": HA_USER_AGENT}`\n- `self._rest = RestData(\"GET\", resource, None, headers, None, True)`\n\nThe comment was updated to clarify that a User-Agent is required for this specific REST API endpoint (referencing issue #29496). After this change, the `dwd_weather_warnings` platform initialized successfully while reusing the central Home Assistant user-agent configuration and avoiding a fragile hardcoded value.",
        "semantic_memory": "This fix illustrates a common integration pitfall: some third-party HTTP APIs refuse or alter behavior for requests lacking a proper `User-Agent` header. When an application relies on a thin HTTP wrapper (like Home Assistant's `RestData` helper) that does not set a User-Agent by default, API calls can fail with non-obvious errors during component setup.\n\nA good practice is to:\n- Use a consistent, globally defined User-Agent for the entire application (e.g., a `SERVER_SOFTWARE` or similar constant) rather than hardcoding versioned strings in individual integrations.\n- Centralize HTTP client/session configuration (including headers) and reuse it across integrations instead of each integration rolling its own HTTP setup.\n- When an integration fails during setup due to remote API issues, inspect HTTP traffic (status codes, required headers) and consult provider documentation to identify hidden requirements like mandatory headers.\n\nGeneralizable lessons:\n- Always check whether an external API imposes header requirements (`User-Agent`, `Authorization`, `Accept`, etc.), especially public or governmental services that may block non-browser or unidentified traffic.\n- Avoid embedding static version numbers or ad-hoc strings in headers. Reference shared constants or configuration hooks so updates and branding changes propagate automatically.\n- When fixing HTTP-related setup errors, align with framework conventions (using the framework's HTTP client/session and constants) instead of introducing one-off configuration in a single module.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce and inspect the failure\n- Trigger the failing integration (e.g., restart the application or reload the component) and capture logs.\n- Identify any errors related to HTTP requests (connection errors, 4xx/5xx codes, or generic setup failures) in the logs or error traces.",
            "Step 2: Inspect the HTTP request/response behavior\n- If possible, enable debug logging for HTTP client modules to see request URLs, headers, and response statuses.\n- Alternatively, reproduce the same request with curl or a REST client (Postman, HTTPie) and try variations with and without specific headers (especially `User-Agent`).\n- Check whether the target API behaves differently or returns errors when `User-Agent` is missing or unusual.",
            "Step 3: Confirm API expectations\n- Look up the remote API documentation (or community reports/issues) to see if it requires a `User-Agent` or other specific headers.\n- Verify that adding an appropriate `User-Agent` in a manual request makes the API behave correctly.",
            "Step 4: Integrate the fix into the code using framework conventions\n- Locate where HTTP requests are constructed (e.g., a helper like `RestData` or a direct `aiohttp` call).\n- Check whether your framework already defines a global User-Agent or HTTP session (e.g., `SERVER_SOFTWARE` or a shared session factory).\n- Import and reuse the framework's User-Agent constant instead of hardcoding a string. For example:\n  - `from homeassistant.helpers.aiohttp_client import SERVER_SOFTWARE as APP_USER_AGENT`\n  - `headers = {\"User-Agent\": APP_USER_AGENT}`\n- Pass the headers into the HTTP helper/constructor (e.g., `RestData(method, url, payload, headers, auth, verify_ssl)`).",
            "Step 5: Clean up comments and naming\n- Update code comments to accurately describe the requirement (e.g., \"A User-Agent is required for this endpoint\" rather than calling it a dummy hack).\n- Use descriptive names for imported constants (e.g., aliasing `SERVER_SOFTWARE` to `HA_USER_AGENT` or `APP_USER_AGENT`) so their purpose is clear in context.",
            "Step 6: Test the fix locally\n- Run the application and verify that the integration now sets up correctly without errors.\n- If available, run the project's automated test suite (e.g., `tox`, `pytest`) to ensure no regressions were introduced.",
            "Step 7: Generalize and prevent future issues\n- If multiple integrations access similar APIs, consider centralizing the header behavior in a shared helper or base class so that all benefit from the fix.\n- Document in developer guidelines that external REST integrations should use the global HTTP client/session and shared User-Agent instead of defining their own custom ones."
        ]
    }
}