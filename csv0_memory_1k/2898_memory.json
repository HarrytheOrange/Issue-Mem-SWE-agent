{
    "search_index": {
        "description_for_embedding": "Fixes a logrotate misconfiguration where a broad 'find . -name \"st2actionrunner*\"' cleanup command was run from the wrong directory, causing non-log files (including the st2actionrunner service manager file) to be deleted. The fix restricts the search path to /var/log/st2 and the filename pattern to 'st2actionrunner*.log' so only stale log files older than 30 days are removed.",
        "keywords": [
            "logrotate",
            "StackStorm",
            "st2actionrunner",
            "file deletion",
            "find command",
            "log cleanup",
            "misconfigured log rotation",
            "service file removed",
            "postrotate script",
            "production incident"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the StackStorm st2actionrunner service manager file was mysteriously disappearing from the system. Investigation led to the logrotate configuration for StackStorm logs. The logrotate postrotate hook contained a cleanup command:\n\n  find . -type f -name \"st2actionrunner*\" -mtime +30 -exec rm -f {} \\;\n\nBecause the command used 'find .' instead of a specific log directory and a very broad filename pattern, it could be executed from a directory higher up in the filesystem (e.g., /), causing it to traverse the whole tree. As a result, it matched and deleted non-log files whose names started with 'st2actionrunner', including critical service/manager files. \n\nThe fix was applied in two steps: (1) constrain the search path explicitly to /var/log/st2/ so it only walks the log directory:\n\n  find /var/log/st2/ -type f -name \"st2actionrunner*\" -mtime +30 -exec rm -f {} \\;\n\n(2) further narrow the match to only log files by requiring the .log suffix:\n\n  find /var/log/st2/ -type f -name \"st2actionrunner*.log\" -mtime +30 -exec rm -f {} \\;\n\nThis ensures that only st2actionrunner log files older than 30 days are removed and prevents accidental deletion of service manager or other non-log files. The change was considered important enough to be cherry-picked into the v2.0.x release line.",
        "semantic_memory": "This case illustrates a common class of operational bugs: overly broad maintenance scripts running with more privileges or broader scope than intended. In logrotate (and similar automation tools), using relative paths (e.g., 'find .') and loose filename patterns can cause commands to operate on unexpected parts of the filesystem, especially when the working directory is different than assumed. When cleanup rules are not tightly scoped, they can inadvertently delete configuration, service, or data files, leading to production outages.\n\nGeneral lessons:\n- Never rely on implicit working directories for destructive commands in cron/logrotate/systemd timers; always use explicit absolute paths.\n- Use precise filename patterns that clearly distinguish between log files and other resources (e.g., require the .log extension instead of matching any file prefix).\n- When implementing automated cleanup (e.g., using 'find -exec rm'), assume that the command could be mis-run from / or another unexpected directory and design the path constraints accordingly.\n- Log rotation and cleanup scripts should be reviewed with the same rigor as application code, as they often run as root and can cause systemic damage.\n- For log retention jobs, prefer whitelisting (targeting known log directories and extensions) over blacklisting to reduce risk of collateral damage.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Identify the symptom\n- Observe what is going wrong: files mysteriously disappearing (config files, service units, binaries, etc.).\n- Check system logs (syslog, journald, application logs) for patterns around the time files go missing.",
            "Step 2: Look for automated jobs that modify or delete files\n- Inspect cron jobs: 'crontab -l' for relevant users and '/etc/cron.*' directories.\n- Check logrotate configs in '/etc/logrotate.conf' and '/etc/logrotate.d/'.\n- Review systemd timers and associated services (e.g., 'systemctl list-timers').",
            "Step 3: Inspect logrotate (or similar) postrotate/cleanup commands\n- Open the relevant logrotate config file.\n- Look for 'postrotate' sections containing 'rm', 'find -exec rm', or other destructive commands.\n- Note whether the commands use relative paths ('.', '..') or overly broad glob patterns (e.g., 'name \"foo*\"').",
            "Step 4: Reproduce and reason about the command scope\n- Manually run a non-destructive variant of the command to see what it would affect, for example:\n  - Replace 'rm -f' with 'echo' to list targeted files: 'find /some/path -name \"pattern\" -print'.\n- Confirm the working directory that logrotate uses for that script (check documentation or logs) and simulate it in a shell before running 'find .'.",
            "Step 5: Constrain the search path\n- Replace relative paths like 'find .' with absolute, specific directories, e.g.:\n  - 'find /var/log/myapp/ ...' instead of 'find . ...'.\n- Ensure the directory is strictly for the resource you intend to manage (logs, temp files, etc.).",
            "Step 6: Tighten the filename pattern\n- Restrict the pattern to the exact file types you want to delete:\n  - Use extensions: 'name \"myservice*.log\"' instead of 'name \"myservice*\"'.\n  - Avoid patterns that could match config, service, or binary files.\n- If necessary, combine with other tests (e.g., '-path', '-regex') for extra safety.",
            "Step 7: Add safety checks and test\n- Initially run the updated command in a safe mode:\n  - Use 'find ... -print' to confirm the list of files to be affected.\n- Consider using 'xargs -r' or similar to avoid executing 'rm' with empty input.\n- Review the output with another engineer before enabling automatic deletion.",
            "Step 8: Deploy the fix and monitor\n- Update the logrotate (or other automation) configuration with the corrected command.\n- Force a logrotate run in a controlled environment (e.g., 'logrotate -f /etc/logrotate.conf') and verify behavior.\n- Monitor for at least one rotation cycle to ensure that only intended files are removed and that the original disappearing-file issue is resolved.",
            "Step 9: Prevent regressions\n- Add comments in the config explaining why paths and patterns are constrained.\n- If possible, add integration tests or checks in CI that scan maintenance scripts for dangerous patterns (e.g., 'find . -exec rm').\n- Document the incident and the fix so future maintainers understand the constraints and don't loosen them inadvertently."
        ]
    }
}