{
    "search_index": {
        "description_for_embedding": "Fix Qt tooltip event filter crash in napari by no longer passing the QApplication instance into QtToolTipEventFilter when installing it as an event filter, resolving documentation build failures and mysterious bus errors on shutdown.",
        "keywords": [
            "napari",
            "Qt",
            "QtToolTipEventFilter",
            "QApplication",
            "event filter",
            "tooltip",
            "application shutdown",
            "bus error",
            "segfault",
            "qt_event_loop.py",
            "docs build failure"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, napari was experiencing two related problems: (1) local documentation builds were failing (see issue #3813) and (2) users were intermittently seeing low-level 'bus errors' and similar crashes when quitting the application. Investigation traced these issues to the way the Qt tooltip event filter was being installed. In napari/_qt/qt_event_loop.py, within get_app(), the code was calling app.installEventFilter(QtToolTipEventFilter(app)). This meant the QtToolTipEventFilter was being constructed with the QApplication object as an argument, likely as its QObject parent. This created problematic ownership and/or lifecycle interactions between the QApplication and the event filter, particularly at shutdown time when Qt tears down QObject hierarchies. The result was subtle crashes and failures in environments like the docs build where the Qt lifecycle can be unusual. The fix was minimal but critical: change the installation to app.installEventFilter(QtToolTipEventFilter()) so the event filter is created without passing the app into its constructor. The filter is still attached to the app via installEventFilter, but it no longer has the app as a parent argument, eliminating the shutdown crashes and fixing the documentation build issue.",
        "semantic_memory": "When working with Qt and QObject-based components such as event filters, ownership and lifetime management are critical. Passing the QApplication (or other core objects) as a parent or constructor argument to helper objects can introduce subtle shutdown-time crashes, especially if those helpers are also registered back onto the same object (e.g., installEventFilter on the app). This can create complex, sometimes circular ownership or destruction orders that only manifest as low-level 'bus errors' or segfaults during application teardown or in special runtimes (like embedded IPython shells, documentation build environments, or headless CI). A safer pattern is to keep QObject ownership graphs simple and avoid using the application instance as a parent unless strictly necessary. Letting the component be owned in a different, clearer way (or just by Python's own GC when safe) while registering it as an event filter or signal receiver is often sufficient. More generally, crashes on application shutdown in Qt code frequently stem from lifetime and ownership mismanagement, especially around global/singleton objects, event filters, and cross-module QObject references.",
        "procedural_memory": [
            "Diagnosing Qt shutdown crashes or bus errors related to event filters and global objects:",
            "Step 1: Reproduce the failure in a controlled environment. Try to run the application and then quit it in different contexts: normal GUI run, embedded IPython/Jupyter, and any build/test environments (e.g., Sphinx docs build) that are failing.",
            "Step 2: Check the crash logs or console output for low-level signals like SIGBUS or SIGSEGV, especially during application teardown. If crashes occur only on exit or in headless/doc builds, suspect QObject lifetime issues.",
            "Step 3: Inspect where QApplication (or QCoreApplication) is created and how global or long-lived Qt objects (event filters, singletons, managers) are constructed and attached to it. Look for patterns like HelperClass(app) followed by app.installEventFilter(helper).",
            "Step 4: Review the constructor of any QObject-derived helpers (e.g., custom event filters). Confirm whether they actually need the QApplication as a parent or as a logical dependency. If they simply need to be installed as an event filter, a parent argument is often unnecessary.",
            "Step 5: Simplify object ownership: remove the application (or other central objects) from being passed as a parent or constructor argument unless strictly required. For event filters, instantiate them without a parent when possible, then register them via installEventFilter on the target object.",
            "Step 6: Apply the change: for example, change app.installEventFilter(QtToolTipEventFilter(app)) to app.installEventFilter(QtToolTipEventFilter()). Ensure that the event filter remains referenced (e.g., by being attached to some longer-lived object, or otherwise kept alive) so it is not garbage collected prematurely.",
            "Step 7: Re-run the failing scenarios: quit the application multiple times, run the test suite, and run any doc builds or headless CI jobs that previously produced bus errors. Confirm that the crashes are gone and that the event filter behavior (e.g., tooltip wrapping) still works as intended.",
            "Step 8: As a preventive measure, audit other uses of QApplication as a QObject parent, and other global/singleton Qt objects, to ensure there are no similarly risky ownership or circular-reference patterns that might cause shutdown-time crashes."
        ]
    }
}