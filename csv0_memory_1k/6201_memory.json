{
    "search_index": {
        "description_for_embedding": "Fixes inconsistent handling of bad logins in Home Assistant: wrong authentication over WebSocket now triggers the same IP ban and notification flow as HTTP endpoints, and wrong-login processing is centralized in the HTTP ban middleware by catching HTTPUnauthorized responses.",
        "keywords": [
            "Home Assistant",
            "authentication",
            "bad login",
            "failed login",
            "websocket_api",
            "HTTPUnauthorized",
            "HTTP 401",
            "http ban middleware",
            "ip_ban",
            "login_attempts_threshold",
            "process_wrong_login",
            "persistent_notification",
            "security",
            "rate limiting",
            "brute force protection"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, Home Assistant had inconsistent behavior when a user supplied wrong credentials, especially over WebSocket connections. HTTP endpoints that required authentication manually invoked process_wrong_login(), logged a warning, and raised HTTPUnauthorized, which in turn incremented failed-login counters and could lead to IP bans and persistent notifications. However, WebSocket-based authentication did not call process_wrong_login at all; it only returned an AUTH_INVALID message to the client and did not trigger IP bans or login failure notifications. Additionally, wrong-login handling for HTTP endpoints was wired directly into the view handler instead of being managed by the HTTP ban middleware, meaning only one code path benefited from the ban logic.\n\nThe fix refactored this behavior in two ways:\n1) The HTTP ban middleware (ban_middleware_handler) was updated to wrap the downstream handler in a try/except block that intercepts aiohttp.web_exceptions.HTTPUnauthorized. When a handler raises HTTPUnauthorized, the middleware now calls process_wrong_login(request) and then re-raises the exception. process_wrong_login was expanded to log a clear warning message including the remote IP, create a persistent notification about the failed login, and then update the failed login counters and ban list based on the configured IP ban settings and login_attempts_threshold. The manual logging and notification creation were removed from the HTTP view handler in homeassistant/components/http/__init__.py, centralizing this behavior in the middleware.\n2) The WebSocket authentication flow in homeassistant/components/websocket_api.py now imports and calls process_wrong_login(self.request) whenever a password-based authentication attempt is invalid (i.e., after validate_password fails and KEY_AUTHENTICATED is false). It still sends the auth_invalid message to the client and returns the WebSocket socket, but now also invokes the same incorrect-login processing as HTTP endpoints, ensuring that WebSocket auth failures contribute to IP bans and user-facing notifications.\n\nTests were updated to reflect this new behavior: the WebSocket authentication test test_auth_via_msg_incorrect_pass now patches websocket_api.process_wrong_login and asserts that it is called on bad password, and an extraneous print statement was removed from the HTTP ban tests. This aligns WebSocket and HTTP authentication failure handling and consolidates the security-related logic in one place.",
        "semantic_memory": "Generalizable lessons from this fix:\n\n1. **Centralize authentication failure handling in a shared layer (middleware):** Instead of duplicating login failure logic (logging, counters, bans, notifications) across individual request handlers, place it in a middleware or equivalent cross-cutting layer. In this case, the HTTP ban middleware catches HTTPUnauthorized and runs the wrong-login handling routine. This ensures any view that signals unauthorized access automatically participates in the security controls without explicit calls.\n\n2. **Unify behavior across protocols (HTTP and WebSocket):** Systems that expose multiple communication channels (REST, WebSocket, RPC, etc.) should treat authentication and security events consistently. If HTTP login failures trigger IP bans or alerts, WebSocket authentication failures should do the same. Otherwise attackers may bypass protections via the weaker path.\n\n3. **Use exceptions as signals for cross-cutting concerns:** Raising a standard exception (e.g., HTTPUnauthorized) from handlers and letting middleware intercept it allows decoupling business logic from security/infrastructure concerns. The handler doesn't need to know about ban thresholds or notifications; it just raises the appropriate error.\n\n4. **Include contextual information in logs and notifications:** When recording failed logins, log the remote IP (or other identifying information) and use clear messages. This is important for both security auditing and for users debugging misconfigured clients.\n\n5. **Keep tests aligned with cross-cutting behavior:** When centralizing logic in middleware or shared helpers like process_wrong_login, tests should verify that callers (HTTP handlers, WebSocket handlers) correctly invoke or trigger that logic. Mocking the shared function and asserting it is called is an effective pattern.\n\n6. **Avoid duplicated side-effects in multiple layers:** Only one layer should be responsible for particular side-effects (like notifying users of failed logins). Previously, the HTTP view handled this directly; after refactoring, the middleware is the single source of truth, reducing the risk of inconsistent behavior and bugs when other entry points (e.g., WebSockets) are added.",
        "procedural_memory": [
            "When diagnosing and fixing inconsistent authentication failure handling across HTTP and WebSocket endpoints:",
            "Step 1: Identify all authentication entry points.",
            "  - Search for places where credentials are validated (e.g., validate_password, token validators, auth messages).",
            "  - List all protocols and handlers: HTTP views, WebSocket handlers, RPC endpoints, etc.",
            "Step 2: Compare behavior on failed authentication across entry points.",
            "  - For each entry point, determine what happens on bad credentials: which HTTP status is returned, what logs are written, whether any security counters or IP bans are updated, and whether user notifications are created.",
            "  - Use tests or manual requests (curl, WebSocket clients) to confirm actual behavior.",
            "Step 3: Define a single source of truth for failed-login handling.",
            "  - Design or select a shared function (e.g., process_wrong_login(request)) responsible for: logging, updating failed-login counters, enforcing thresholds/IP bans, and raising or re-raising appropriate exceptions.",
            "  - If possible, place this logic in middleware or a cross-cutting component that can see all relevant requests.",
            "Step 4: Wire HTTP handlers to the shared failed-login logic via middleware.",
            "  - In the HTTP middleware chain, wrap downstream handlers in a try/except for the frameworkâ€™s unauthorized exception (e.g., aiohttp.web_exceptions.HTTPUnauthorized).",
            "  - On catching HTTPUnauthorized, call the shared wrong-login handler with the request (e.g., yield from process_wrong_login(request)), then re-raise the exception so the client still sees the 401 response.",
            "  - Remove ad-hoc logging and notification code from individual handlers and rely on the middleware instead.",
            "Step 5: Update non-HTTP protocols (e.g., WebSockets) to also use the shared logic.",
            "  - In WebSocket auth flows, after validating credentials, if invalid, call the same process_wrong_login(request) helper before or after sending the auth failure message back to the client.",
            "  - Ensure the WebSocket request object (or equivalent context) provides enough information (e.g., remote IP) for the shared routine.",
            "Step 6: Ensure process_wrong_login gathers and records relevant context.",
            "  - Use a helper like get_real_ip(request) to derive the client IP address, considering proxies if needed.",
            "  - Log a clear and consistent warning (e.g., 'Login attempt or request with invalid authentication from <IP>').",
            "  - Create or trigger any user-facing notifications about the failed login, using a stable notification ID to avoid duplicates.",
            "  - Increment per-IP failed login counters and check them against configured thresholds to apply IP bans when necessary.",
            "Step 7: Write or update tests to cover the new behavior.",
            "  - For HTTP: create tests that perform requests with invalid credentials and assert that the ban/notification path is exercised (e.g., by checking ban files, app state, or mocking process_wrong_login).",
            "  - For WebSockets: patch the shared handler (e.g., with unittest.mock.patch) and assert that on invalid password, process_wrong_login is called and an AUTH_INVALID response is sent.",
            "  - Remove or update any tests that assumed the old, handler-local behavior and ensure they now assert interactions with the centralized logic.",
            "Step 8: Verify end-to-end behavior and configuration sensitivity.",
            "  - Run the application with various IP ban settings (bans enabled/disabled, different login_attempts_threshold) and confirm that behavior (banning, notifications) reflects configuration.",
            "  - Test multiple failed attempts from the same IP and confirm bans occur at the expected threshold for both HTTP endpoints and WebSocket connections.",
            "Step 9: Document the behavior and the responsibility boundaries.",
            "  - Note in code comments or developer docs that handlers should signal unauthorized access by raising HTTPUnauthorized (or equivalent), and that no manual ban/notification logic is needed in the handler.",
            "  - Clarify that all authentication failure side-effects are handled by the shared function and middleware, ensuring future handlers follow the same pattern."
        ]
    }
}