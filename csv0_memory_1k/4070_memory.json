{
    "search_index": {
        "description_for_embedding": "Adds a CompleteTutorial worker/task to PokemonGo-Bot that checks player_data.tutorial_state and programmatically completes the tutorial steps (legal screen, avatar selection, first capture, nickname, first-time experience) using the PGOAPI. Introduces a configurable nickname (default empty instead of username) and updates example configs to include the new task. Fixes previous issues with incorrect mark_tutorial_complete / encounter_tutorial_complete usage and result key names.",
        "keywords": [
            "PokemonGo-Bot",
            "CompleteTutorial",
            "tutorial_state",
            "player_data",
            "mark_tutorial_complete",
            "encounter_tutorial_complete",
            "claim_codename",
            "config nickname",
            "BaseTask worker",
            "API result key mismatch",
            "bot first run setup",
            "automation of onboarding flow"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this change, a new CompleteTutorial cell worker was introduced to the PokemonGo-Bot to automatically complete the in-app tutorial for newly created accounts. Previously, the tutorial flow either wasn't handled or was handled incorrectly via direct API calls (e.g., using mark_tutorial_complete with the wrong parameter type or misinterpreting API response keys). The new worker pulls player_data.tutorial_state from bot.player_data and sequentially ensures that key tutorial steps are marked as completed: legal screen (0), avatar selection (1), first Pokémon capture (3), nickname selection (4), and the 'first-time experience complete' flag (7).\n\nThe worker defines initialize(), should_run(), and work() methods as a proper BaseTask-based Worker. In work(), it calls _check_tutorial_state() and returns SUCCESS or ERROR based on whether it can successfully complete the tutorial. Internally, it:\n- Uses mark_tutorial_complete(tutorials_completed=[completed], send_marketing_emails=False, send_push_notifications=False) to update server-side tutorial state for steps 0, 1, and 7, and correctly reads responses['MARK_TUTORIAL_COMPLETE']['success'] and ['player_data'].\n- Implements _encounter_tutorial() to complete the capture tutorial by choosing a random starter Pokémon (IDs 1, 4, or 7), calling encounter_tutorial_complete(pokemon_id=...), and checking responses['ENCOUNTER_TUTORIAL_COMPLETE']['result'] == 1, fixing a previous typo / wrong key usage.\n- Implements _set_nickname() that uses claim_codename(codename=nickname) and reads responses['CLAIM_CODENAME']['status'] to handle success and specific error codes.\n\nConfig handling was also changed: instead of defaulting config.nickname to config.username (which might expose an email-like username such as a Gmail address), nickname now defaults to an empty string. The tutorial nickname step is skipped and the worker returns an error if nickname is not explicitly set. Example configuration files (config.json.example and related variants) were updated to add a CompleteTutorial task (disabled by default) early in the task list, with a dedicated 'nickname' config field and a comment placeholder. The worker is registered in pokemongo_bot/cell_workers/__init__.py. The discussion also clarified that team selection and avatar customization are not yet implemented and might be added later when inventory/playerstats are available via a unified mechanism.\n\nOverall, this PR converts ad-hoc, partially broken tutorial handling into a reusable, configurable BaseTask that correctly matches the PGOAPI's expected parameters and response structures, and makes first-run automation safer by not leaking email-like usernames as nicknames.",
        "semantic_memory": "This change illustrates several generalizable practices:\n\n1. **Automating first-time flows via state inspection**: Rather than assuming that tutorial steps are needed or completed, the code inspects a state array (player_data.tutorial_state) and conditionally executes actions. This is the right pattern when bridging a client automation layer to a remote service with explicit progression flags.\n\n2. **Correctly matching API shape (parameters and response keys)**: The PGOAPI functions require specific parameter types (e.g., mark_tutorial_complete expects a list tutorials_completed=[...], not a single int), and their responses are nested in strongly typed keys (e.g., responses['ENCOUNTER_TUTORIAL_COMPLETE']['result'], responses['MARK_TUTORIAL_COMPLETE']['success'], responses['CLAIM_CODENAME']['status']). Errors occurred previously because of mismatched parameter shapes or incorrect key names. The fix emphasizes the importance of reading and following API definitions and inspecting actual traffic or documentation.\n\n3. **Graceful handling of optional user configuration**: Instead of defaulting a nickname to the account username (which may be an email address and could look suspicious or leak private data), the code uses an empty default and requires explicit configuration from the user. When the nickname is missing, it logs a clear message and stops the tutorial at that step rather than making a risky or wrong assumption.\n\n4. **Encapsulating flows as modular tasks**: The tutorial completion logic is implemented as a BaseTask worker, making it easy to enable/disable via config and insert at a specific point in the task list. This modularization is preferable to ad-hoc calls scattered across the codebase or hooking into unrelated tasks.\n\n5. **Robust error handling and logging around external calls**: Every API call (_encounter_tutorial, _set_nickname, _set_tutorial_state) is wrapped in try/except KeyError and logs descriptive messages on failure. This is especially important when dealing with remote services where responses may change or contain partial data.\n\nThese patterns apply broadly to any automation or bot that must walk through onboarding flows, interact with external APIs, or map configuration to potentially sensitive user-identifying actions.",
        "procedural_memory": [
            "When implementing or fixing onboarding / tutorial automation against a remote API, follow these steps:",
            "Step 1: Inspect and understand state fields that represent progression (e.g., tutorial_state lists or flags in player_data). Determine the exact values that correspond to each step of the tutorial and design your automation to check these values before acting.",
            "Step 2: Verify the API contract carefully. For each endpoint you call (e.g., mark_tutorial_complete, encounter_tutorial_complete, claim_codename), confirm parameter types (scalars vs. arrays, nested structures) and the exact layout of the response (nested keys, status codes, and success flags). Use official docs, protocol definitions, or MITM inspection if necessary.",
            "Step 3: Implement the flow as a dedicated, modular component (e.g., a task class derived from a shared BaseTask) rather than scattering tutorial logic around the codebase. Use initialize() to pull configuration, should_run()/work() to control execution, and ensure that the worker returns clear results (SUCCESS/ERROR).",
            "Step 4: Sequence the tutorial steps by checking the current state and only executing missing steps. After each successful call, refresh or update your local state representation from the latest server response to avoid stale decisions.",
            "Step 5: For configuration values that may expose sensitive data (like nicknames, emails, or real names), prefer safe defaults (e.g., empty string or disabled behavior). Require explicit user configuration for such values instead of deriving them from potentially sensitive fields like usernames.",
            "Step 6: Wrap all external API calls in robust error handling. Use try/except blocks around nested response access, log clear error messages for KeyError or unexpected status codes, and return a failure status so the rest of the system can react gracefully.",
            "Step 7: Add the new component to your system's registration or plugin list (e.g., import the new worker in __init__.py) and update example configuration files to show typical usage, including enabling/disabling flags and documented config keys.",
            "Step 8: Test with a fresh account or clean state, verifying that each tutorial step is completed in order, that nickname is only set when configured, and that failures (e.g., nickname already taken) are logged properly and do not crash the application."
        ]
    }
}