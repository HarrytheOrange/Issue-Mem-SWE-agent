{
    "search_index": {
        "description_for_embedding": "Home Assistant HTTP component bug where `use_x_forwarded_for` and `trusted_proxies` could be configured independently despite docs requiring them together. Fix adds config schema validation using `vol.Inclusive` so both options must be specified together, updates HTTP setup code to handle missing keys with defaults, and adjusts tests.",
        "keywords": [
            "Home Assistant",
            "http component",
            "use_x_forwarded_for",
            "trusted_proxies",
            "X-Forwarded-For",
            "proxy configuration",
            "config validation",
            "voluptuous.Inclusive",
            "schema enforcement",
            "unit tests"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant HTTP component had a discrepancy between documentation and behavior. The docs stated that `use_x_forwarded_for` should only be used when `trusted_proxies` is also configured, to ensure the client IP derived from the X-Forwarded-For header is only trusted when coming from known proxies. However, the configuration schema allowed `use_x_forwarded_for` and `trusted_proxies` to be set independently, with default values (`False` and `[]` respectively). This could lead to misconfiguration where X-Forwarded-For is honored without restricting which proxies are trusted, or proxies are configured but X-Forwarded-For parsing is disabled.\n\nThe fix modified `homeassistant/components/http/__init__.py` to enforce that `use_x_forwarded_for` and `trusted_proxies` are configured together. Using Voluptuous, the schema changed from optional fields with defaults to `vol.Inclusive(CONF_USE_X_FORWARDED_FOR, 'proxy')` and `vol.Inclusive(CONF_TRUSTED_PROXIES, 'proxy')`, grouping them under the same tag so that either both are present or neither. Since the keys may now be absent, the HTTP setup logic was updated to use `conf.get(CONF_USE_X_FORWARDED_FOR, False)` and `conf.get(CONF_TRUSTED_PROXIES, [])` instead of direct indexing.\n\nNew tests were added in `tests/components/http/test_init.py` to verify that configuration succeeds when both `use_x_forwarded_for` and `trusted_proxies` are provided together and fails when only one of them is provided. Additionally, the `tests/scripts/test_check_config.py` expectations were updated to remove the previously assumed default values for `trusted_proxies` and `use_x_forwarded_for`, since they are no longer present in the validated config when not explicitly configured. This resolved the mismatch and ensured configuration validation now enforces the documented behavior.",
        "semantic_memory": "This case illustrates a common pattern in configuration design and validation: certain options are logically dependent on each other and must be set together to be safe or meaningful. When such dependencies exist, they should be enforced at the schema/validation level, not just documented, to prevent silent misconfigurations.\n\nUsing a validation library like Voluptuous, pairs or groups of related options can be enforced with constructs like `vol.Inclusive` (or `Exclusive`/`Required`/`Optional` with groups). When an option's safety or correctness depends on another (e.g., trusting X-Forwarded-For headers only from known proxies), the schema should ensure that you cannot enable one without configuring the other.\n\nAdditionally, when schema defaults are removed or when keys become optional, all code paths consuming the configuration must handle missing keys safely (e.g., via `dict.get(key, default)` instead of direct indexing). Automated tests and config-checking scripts must be updated to reflect the new shape of the validated configuration, ensuring meta-tools (like `check_config`) don't assume defaults that no longer exist.\n\nMore generally, this fix exemplifies:\n- Aligning implementation behavior with documented security expectations.\n- Using schema-level constraints to enforce security-sensitive configuration coupling.\n- Keeping tests and tooling synchronized with schema changes.",
        "procedural_memory": [
            "Diagnose and fix issues where configuration options that must be used together are not enforced by validation.",
            "Step 1: Identify the dependency between configuration options. Determine which options are logically or security-wise dependent (e.g., `use_x_forwarded_for` requires `trusted_proxies` to be meaningful and safe). Confirm existing documentation describing the expected relationship.",
            "Step 2: Review the current configuration schema. Inspect the validation layer (e.g., Voluptuous schema) to see how these options are defined. Look for `Optional`, `Required`, defaults, or lack of grouping that may allow invalid combinations.",
            "Step 3: Decide on the appropriate validation construct. For Voluptuous, use `vol.Inclusive` when two or more keys must always appear together, `vol.Exclusive` when only one of a set may appear, or `vol.Required` when an entire group is mandatory. Group related keys under a group name so the validator enforces the relationship.",
            "Step 4: Update the schema to enforce the relationship. Replace separate `Optional` definitions with a grouped constraint. For example:\n- Before: `vol.Optional(CONF_USE_X_FORWARDED_FOR, default=False): cv.boolean` and `vol.Optional(CONF_TRUSTED_PROXIES, default=[]): ...`\n- After: `vol.Inclusive(CONF_USE_X_FORWARDED_FOR, 'proxy'): cv.boolean` and `vol.Inclusive(CONF_TRUSTED_PROXIES, 'proxy'): ...`",
            "Step 5: Adjust configuration consumers for missing keys. If the schema no longer provides default values and instead allows the keys to be omitted, update any code that reads from the config dict to use `conf.get(key, default)` rather than `conf[key]`, supplying appropriate safe defaults.",
            "Step 6: Add or update unit tests to cover valid and invalid configurations. Create tests that verify setup succeeds when all required related options are present and fails when only a subset is provided. For this case: one test where both `use_x_forwarded_for` and `trusted_proxies` are set and two tests where only one of them is set, asserting that setup does not return `True` for invalid configurations.",
            "Step 7: Update meta-tests and tools. If there are higher-level tests (like a `check_config` script) that assert against the structure or contents of the validated configuration, update their expected outputs to reflect removed defaults or new behaviors.",
            "Step 8: Run the full test suite and, if possible, manual verification. Execute unit tests and any integration tests (`tox`, etc.). If relevant, verify behavior in a realistic environment (e.g., behind a proxy server) to confirm both the new validation and runtime behavior are correct.",
            "Step 9: Document the enforced behavior. Ensure user-facing documentation clearly describes that certain options must be configured together, and that misconfigurations will now be rejected during validation, reducing the chance of insecure setups."
        ]
    }
}