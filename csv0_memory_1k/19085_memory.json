{
    "search_index": {
        "description_for_embedding": "Home Assistant Apple TV integration broke due to issues in pyatv 0.3.11 (including tvOS 12.1.1 changes and artwork handling). The fix is to upgrade the pyatv dependency to version 0.3.12 in both the component REQUIREMENTS and the global requirements_all.txt, which restores Apple TV functionality and fixes several edge cases in pairing, manually paired remotes, AirPlay without credentials, and artwork status code handling.",
        "keywords": [
            "Home Assistant",
            "apple_tv",
            "pyatv",
            "dependency upgrade",
            "tvOS 12.1.1",
            "external library breaking change",
            "artwork status code",
            "AirPlay credentials",
            "pairing leading zeros",
            "manually paired remotes",
            "requirements_all.txt",
            "REQUIREMENTS"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Apple TV integration stopped working correctly after changes in Apple TV/tvOS (notably tvOS 12.1.1) and bugs in pyatv 0.3.11. Users experienced completely broken Apple TV support and specific issues such as unhandled status codes when artwork was missing, problems with manually paired remotes being removed on reboot, pairing issues when device identifiers had leading zeros, and poor error messages when using AirPlay without credentials.\n\nInvestigation showed that these problems were already identified and fixed upstream in the pyatv library, released as version 0.3.12. Home Assistant was still pinning pyatv to 0.3.11 in the Apple TV component and in the global requirements_all.txt file. As a result, Home Assistant was shipping an outdated pyatv version that could not handle the latest tvOS behavior.\n\nThe fix was straightforward: bump the pyatv dependency from 0.3.11 to 0.3.12 in two places:\n- homeassistant/components/apple_tv.py: REQUIREMENTS = ['pyatv==0.3.11'] → ['pyatv==0.3.12']\n- requirements_all.txt: pyatv==0.3.11 → pyatv==0.3.12\n\nNo code changes were required inside the Apple TV component itself; the new library version contained all necessary fixes. Due to the severity (Apple TV support was completely broken), the change was requested for inclusion in the next beta release rather than waiting for a distant minor/hotfix. Project maintainers decided to tag it for beta, with no separate hotfix planned.",
        "semantic_memory": "This case demonstrates a common pattern in integrations that depend on external libraries and evolving platforms:\n\n1. **External dependencies can break integrations when upstream APIs or platforms change.** A minor OS update (tvOS 12.1.1) changed behavior that pyatv 0.3.11 relied on, causing failures in a downstream integration (Home Assistant Apple TV). The integration itself did not change, but its dependency became incompatible with the environment.\n\n2. **Pinning library versions is useful but requires proactive maintenance.** Pinning to a specific version (pyatv==0.3.11) increases reproducibility and stability, but when upstream issues are fixed in newer versions, a pinned version can block critical bug fixes. Maintain a process to regularly review upstream changelogs and bump pinned versions when necessary.\n\n3. **Many bugs are best fixed upstream in the dedicated library rather than in each integration.** Issues like handling leading zeros in pairing identifiers, better error messages for missing credentials, and correct handling of missing artwork belong in the protocol/library layer (pyatv). The integration should then simply upgrade the dependency, rather than re-implementing protocol workarounds.\n\n4. **Central requirement files must stay consistent with per-component REQUIREMENTS.** In this project, dependencies are declared both in each component's REQUIREMENTS and in a global requirements_all.txt. Forgetting to update one of these can cause inconsistent environments. Automating the generation of global requirement files and enforcing checks reduces this risk.\n\n5. **Severity and rollout strategy matter.** When a dependency breakage completely disables a feature (Apple TV support), maintainers might prioritize including the fix in the next beta/stable release instead of issuing a separate hotfix, balancing release overhead against user impact.\n\n6. **Better error handling in libraries improves user experience and debugging.** Fixes like handling unrecognized status codes when no artwork is available or providing clearer errors for AirPlay without credentials show that robust error handling in a shared library can significantly improve reliability and troubleshooting for all downstream consumers.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Identify the symptoms and confirm the scope of breakage.\n- Collect error logs and user reports from the affected integration (e.g., Apple TV support failing, exceptions on missing artwork, pairing failures).\n- Determine whether the integration used to work and recently started failing (e.g., after an OS update or dependency upgrade).",
            "Step 2: Determine if the issue originates in an external dependency.\n- Check stack traces for errors originating in third-party libraries (e.g., pyatv).\n- Look at pinned versions of the library in the component (REQUIREMENTS or similar) and in any central requirements file.\n- Compare with the library’s latest release notes or issue tracker to see if similar bugs have been reported and fixed upstream.",
            "Step 3: Verify that an upstream fix exists.\n- Visit the external library’s repository (e.g., GitHub) and search issues/PRs using the observed error messages or behavior (e.g., \"tvOS 12.1.1\", \"artwork status code\", \"pairing leading zeros\").\n- Confirm that the fixes are included in a specific released version (e.g., pyatv 0.3.12) and review the changelog for compatibility notes or breaking changes.",
            "Step 4: Decide on the target version and adjust pinned requirements.\n- Choose the minimum library version that contains the necessary fixes (e.g., bump from 0.3.11 to 0.3.12, avoiding unnecessary major jumps).\n- Update the component’s dependency declaration (e.g., REQUIREMENTS = ['pyatv==0.3.12']).\n- Update any global or aggregated requirements files (e.g., requirements_all.txt) to the same version to keep the environment consistent.",
            "Step 5: Regenerate and verify requirements if the project uses tooling.\n- If there is a script (e.g., script/gen_requirements_all.py) that generates the global requirements file, run it and commit the result.\n- Ensure no other unintended dependency changes are introduced by the generation process.",
            "Step 6: Test the integration with the new dependency version.\n- Run automated tests for the integration, if available (unit/integration tests around Apple TV functionality).\n- Perform basic manual tests: pairing (including edge cases like leading zeros), remote persistence across reboots, artwork retrieval (including when artwork is missing), and AirPlay usage with and without credentials.\n- Confirm that previously reported errors no longer occur and that no new regressions appear.",
            "Step 7: Coordinate release strategy based on severity.\n- If the dependency issue completely breaks the feature for all users, prioritize inclusion in the next beta or stable release.\n- Discuss with maintainers whether a dedicated hotfix release is warranted, or whether tagging the PR for the next scheduled release is sufficient.\n- Document in release notes that a dependency was upgraded to fix compatibility with the latest platform version (e.g., tvOS 12.1.1).",
            "Step 8: Improve monitoring and maintenance practices.\n- Set up a process to periodically review upstream library releases for critical fixes affecting your integration.\n- Consider adding tests or health checks that can quickly detect when an external platform (e.g., tvOS) changes behavior in a way that breaks the library or integration.\n- Where feasible, ensure better error handling in the integration when the external library throws unexpected errors, so users see actionable messages rather than raw stack traces."
        ]
    }
}