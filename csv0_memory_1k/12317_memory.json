{
    "search_index": {
        "description_for_embedding": "Home Assistant Netatmo integration was assigning non-unique 'unique_id' values to sensors and cameras, causing duplicate entity_id conflicts and missing entities after upgrades. The fix removes the incorrect unique_id usage from Netatmo platforms so Home Assistant falls back to name-based entity IDs, and it enhances the entity platform error message to include the platform name when duplicate entity_ids occur and unique_id is present.",
        "keywords": [
            "homeassistant",
            "netatmo",
            "unique_id collision",
            "duplicate entity_id",
            "entity already exists",
            "binary_sensor.netatmo",
            "camera.netatmo",
            "sensor.netatmo",
            "entity_platform",
            "HomeAssistantError",
            "integration bug",
            "device registry"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Netatmo integration declared unique_id values for several entity types (binary sensors, cameras, and sensors) that were not actually unique across all entities. Specifically, the Netatmo camera and binary_sensor platforms derived their unique_id from the camera's 'id' field, and the sensor platform constructed unique_id from a module_id/type pair that was not reliably unique. As Home Assistant relies on unique_id to map entities to stable entity_ids, this led to collisions where multiple entities tried to claim the same entity_id. Users observed missing Netatmo sensors after upgrading, and reverting to an earlier version restored the entities, indicating a regression linked to the unique_id logic.\n\nThe fix took a conservative approach: instead of trying to re-derive a correct unique identifier immediately, the developer removed the unique_id properties entirely from the Netatmo binary_sensor, camera, and sensor entity classes. This allows Home Assistant to fall back to its default entity_id generation based on the entity name, which avoids the conflicting IDs. As a result, after upgrading to the fixed version (0.63.1), users saw their Netatmo entities return, sometimes with slightly changed IDs/names requiring configuration updates.\n\nAdditionally, the core entity platform (_async_add_entity in homeassistant/helpers/entity_platform.py) was updated to improve diagnostics. When a new entity is added and the entity_id already exists in the component_entities set, the error message now includes, when applicable, that the platform did not generate proper unique IDs and explicitly names the platform. If entity.unique_id is not None and a duplicate entity_id is detected, the error raised becomes: 'Entity id already exists: <id>. Platform <platform_name> does not generate unique IDs.' This change is meant to \"shame\" misbehaving platforms and make it clearer to both developers and users where the problem lies.",
        "semantic_memory": "This case highlights important best practices around entity identity management in systems like Home Assistant where entities are dynamically discovered and persisted:\n\n1. **Unique IDs must truly be globally unique and stable**: A platform's unique_id must uniquely identify a specific physical or logical device across restarts and should not collide with other entities. Using a field that only seems unique within a narrow scope (e.g., within a home or camera list) can lead to collisions when mapped into a larger global entity registry.\n\n2. **When in doubt, prefer no unique_id over a wrong one**: Declaring an incorrect unique_id is worse than not having one at all. Without a unique_id, the system falls back to name-based entity_id generation, which may be less stable but avoids hard collisions. A bad unique_id can cause silent data corruption-like behavior (entities replacing each other, missing entities, or failed registrations).\n\n3. **Diagnostic messages should be specific and actionable**: When a duplicate entity_id is detected, the error message should clearly state not only that a conflict occurred but also which platform is implicated and why (e.g., platform did not generate unique IDs). This transforms a generic runtime error into guidance that a specific integration needs to fix its unique_id logic.\n\n4. **Backwards-compatibility vs. correctness**: Fixing broken unique_id schemes often means changing entity_ids or dropping unique_id entirely. This can force users to update configuration references, but it is preferable to maintaining a broken identity mapping. It can be useful to accept short-term inconvenience to restore correctness and consistency.\n\n5. **Central enforcement of identity constraints**: Having a central place (like entity_platform._async_add_entity) that enforces uniqueness of entity_ids and throws clear errors helps catch platform bugs early instead of letting buggy integrations silently overwrite each otherâ€™s entities.\n\n6. **Testing integrations against upgrades**: Problems surfaced when users upgraded Home Assistant and observed missing sensors. Integration maintainers should test upgrade paths and ensure that identity and registry behavior remains consistent (or is intentionally migrated) to avoid surprises.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Detect the symptom\n- Look for user reports or logs indicating that entities are missing, have been replaced, or that an error like 'Entity id already exists: <entity_id>' is thrown when an integration sets up entities.\n- Pay special attention to regressions observed immediately after an upgrade, as they often indicate changes in identity or registry handling.",
            "Step 2: Inspect the entity platform error and context\n- Find the stack trace around entity addition (e.g., in Home Assistant, _async_add_entity in entity_platform).\n- Check the error message for mentions of duplicate entity_id and platform name. If it includes 'Platform <platform_name> does not generate unique IDs', the platform is misusing or mis-defining unique_id.",
            "Step 3: Review the integration's unique_id implementation\n- Open the platform's entity classes (e.g., sensor, binary_sensor, camera) and locate any unique_id property or attribute assignments.\n- Determine what data is being used (e.g., device 'id', module id, type, or name) and evaluate whether it is globally unique and stable across installations and devices.\n- Consider edge cases such as multiple homes, multiple locations, or multiple modules of the same type.",
            "Step 4: Decide between fixing or removing unique_id\n- If you can derive a truly unique and stable identifier (e.g., vendor-provided UUID, MAC address, serial number), refactor unique_id to use that instead.\n- If you cannot guarantee correctness, remove the unique_id implementation entirely for that platform. Allow the core system to generate entity_ids from names rather than advertising a broken unique_id.",
            "Step 5: Implement and simplify\n- Remove or adjust _unique_id fields and unique_id @property implementations from the entity classes that are causing conflicts.\n- For example, stop deriving unique_id from a camera's 'id' if that value is not unique across all entities, or from module/type combinations that can collide.",
            "Step 6: Improve error reporting (if working on core)\n- In the central entity registration layer, enhance error messages for duplicate entity_ids to include the platform name and, if entity.unique_id is present, a hint that the platform is not generating proper unique IDs.\n- This makes future misconfigurations easier to detect and fixes faster to implement.",
            "Step 7: Test upgrade and runtime behavior\n- Start from a version before the fix, register a representative set of entities, then upgrade to the fixed version.\n- Verify that entities appear correctly, no duplicate entity_id errors are thrown, and that no entities unexpectedly overwrite others.\n- Check that any new or changed error messages appear as intended when you intentionally create duplicate scenarios in a test environment.",
            "Step 8: Communicate user-facing changes\n- Document that entity_ids might change if unique_id was removed or corrected. Inform users that they may need to update entity references in their configuration or automations.\n- Where possible, provide a migration path or mapping, but prioritize correctness and the elimination of collisions over preserving broken identifiers.",
            "Step 9: For future integrations\n- Always design unique_id using a truly unique, stable identifier provided by the device/vendor (serial, UUID, immutable IDs) rather than inferred names or indices.\n- Add tests (unit/integration) that simulate adding multiple entities and assert that entity_ids remain distinct and consistent, catching potential collisions early in development."
        ]
    }
}