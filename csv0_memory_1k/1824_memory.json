{
    "search_index": {
        "description_for_embedding": "Home Assistant Plex media_player integration was not detecting Plex players that were powered on after Home Assistant started. The fix adds a scheduled time-based callback using track_utc_time_change to periodically call update_devices so newly powered players are discovered.",
        "keywords": [
            "Home Assistant",
            "Plex",
            "media_player",
            "device discovery",
            "not detecting players after power up",
            "polling",
            "track_utc_time_change",
            "scheduled update",
            "update_devices",
            "integration bug"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Plex media_player component failed to detect Plex clients that were powered on after Home Assistant had already started. Users observed that when turning Plex players off and then back on (or powering them up after HA start), the players did not appear as entities in Home Assistant. The root cause was that the Plex integration only updated its device list reactively/at startup and did not have a reliable periodic polling mechanism to refresh the known clients. As a result, newly available Plex clients were never discovered. The fix imported `track_utc_time_change` from `homeassistant.helpers.event` and registered a time-based callback inside `setup_plexserver`: `track_utc_time_change(hass, lambda now: update_devices(), second=30)`. This schedules `update_devices()` to run periodically (once per minute at second 30), subject to the existing `@util.Throttle` decorator (`MIN_TIME_BETWEEN_SCANS`), ensuring that Plex clients that come online after initial setup are regularly discovered. The change consists of two lines: adding the import of `track_utc_time_change` and adding the scheduling call before defining the throttled `update_devices` function usage.",
        "semantic_memory": "For integrations with external devices or services, especially where device availability can change over time (e.g., clients being powered on/off), relying solely on startup discovery or event-driven updates is often insufficient. A periodic polling mechanism is necessary to keep the internal device list in sync with the real-world state. Home Assistant provides time-based helpers like `track_utc_time_change` that allow components to schedule regular updates aligned with the system clock. Combining these scheduled callbacks with throttling decorators (e.g., `@util.Throttle`) is a best practice: it ensures that updates occur often enough to pick up new devices but not so frequently as to overload the external service or Home Assistant itself. The general pattern is: (1) import the appropriate scheduling helper, (2) register a callback that invokes the component's update routine, and (3) protect that routine with throttling to control API call frequency. Bugs where devices are not discovered after power cycles often indicate missing or misconfigured periodic polling rather than a discovery logic failure.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues involving integrations not detecting devices that appear after startup:",
            "Step 1: Reproduce the issue.",
            "Power cycle or disconnect/reconnect the relevant device (e.g., a Plex client) after the home automation system has fully started. Observe whether the device appears in the UI and whether its entity is created/updated.",
            "Step 2: Inspect integration logs and update flow.",
            "Enable debug logging for the affected integration. Look for evidence that the integration's discovery or update routine (e.g., `update_devices`) is being called after the device is powered on. If there are no log entries, the issue is likely missing polling or event subscription.",
            "Step 3: Review how discovery is triggered.",
            "Examine the integration’s setup function (e.g., `setup_plexserver`) and search for any calls to update functions or discovery routines. Check whether these are only called at startup, or whether there is a mechanism (event subscription, polling, or scheduled callback) that triggers them periodically.",
            "Step 4: Determine appropriate update mechanism.",
            "If the external service does not push events to the integration (webhooks, sockets, etc.), plan to add periodic polling. In Home Assistant, use time/event helpers like `track_utc_time_change` or `async_track_time_interval` to schedule periodic calls to the update function.",
            "Step 5: Implement scheduled updates.",
            "Import a scheduler helper, such as:\nfrom homeassistant.helpers.event import track_utc_time_change\n\nInside the setup function, register a periodic callback:\ntrack_utc_time_change(hass, lambda now: update_devices(), second=30)\nAdjust the arguments (minute, second, etc.) to get a suitable cadence.",
            "Step 6: Combine with throttling to avoid excessive calls.",
            "Ensure the update routine is decorated with a throttling mechanism, for example:\n@util.Throttle(MIN_TIME_BETWEEN_SCANS, MIN_TIME_BETWEEN_FORCED_SCANS)\ndef update_devices():\n    ...\nThis prevents the scheduler from causing overly frequent API calls while still ensuring regular updates.",
            "Step 7: Test and validate.",
            "Restart Home Assistant, then power up a device after startup. Confirm that the device is discovered within the expected polling interval. Monitor logs to ensure `update_devices` runs at the scheduled times and that no rate limit or performance issues occur.",
            "Step 8: Clean up and document.",
            "Document the new periodic behavior and any configuration implications (e.g., increased polling) in the integration’s documentation or code comments. If necessary, make the polling interval configurable for different environments or device types."
        ]
    }
}