{
    "search_index": {
        "description_for_embedding": "Travis CI builds on Ubuntu Precise started hanging on travis_apt_get_update due to Travis apt addon/network issues. The project first replaced the apt addon with explicit apt-get commands using retries, IPv4 forcing, and list cleanup, then ultimately migrated the Travis distribution from Precise to Xenial. Xenial required higher command timeouts, a permissions workaround (chmod 777 /home/travis) so tests running as the 'stanley' user could access the repo, and adding --exe to nosetests invocations so executable test files are still discovered.",
        "keywords": [
            "Travis CI",
            "travis_apt_get_update timeout",
            "apt addon",
            "apt-get update retries",
            "Acquire::ForceIPv4",
            "Ubuntu Precise",
            "Ubuntu Xenial",
            "CI migration",
            "chmod 777 /home/travis",
            "nosetests --exe",
            "StackStorm tests",
            "COMMAND_THRESHOLD",
            "MongoDB 3.4 on Travis",
            "RabbitMQ exchange durable false",
            "stanley user permissions"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, Travis CI builds for the project started failing and hanging on the `travis_apt_get_update` step. These failures appeared suddenly, without any repository changes, and were traced to upstream issues with Travis' apt addon and networking on the Ubuntu Precise images.\n\nThe initial approach was to bypass Travis' apt addon entirely and manage package installation manually in `.travis.yml`. The maintainer:\n- Commented out the `addons.apt` configuration.\n- Added manual steps to add the MongoDB 3.4 repo and key, and (initially) a git PPA.\n- Ran `apt-get update` with custom options to mitigate network flakiness: `Acquire::Retries=100`, `Acquire::http::Timeout=60`, and later `Acquire::ForceIPv4=true`.\n- Added apt cleanup and list directory reset: `apt-get clean`, moving `/var/lib/apt/lists` to `lists.old`, recreating `lists/partial`, then running update again.\n- Switched the MongoDB repo to HTTPS and installed `apt-transport-https`.\n\nDespite these workarounds, the core problem appeared tied to the Precise environment. The maintainer concluded that Precise itself was the issue (and already very old), so the Travis distribution in `.travis.yml` was switched from `dist: precise` to `dist: xenial`.\n\nOn Xenial, a few new issues emerged:\n- Test runs were 30–50% slower, causing command timeouts. To address this, the `COMMAND_THRESHOLD` environment values in the Travis job matrix were doubled for all major CI tasks (unit, integration, lint, and Python 3 jobs).\n- Travis on Xenial runs the checkout under the `travis` user, but some integration and pack tests run as the `stanley` user. This caused permissions problems when `stanley` attempted to access the workspace.\n\nTo fix the permissions problem, a new script `scripts/travis/permissions-workaround.sh` was added. It:\n- Requires root (run via `sudo`).\n- Detects the Ubuntu codename.\n- If running on Xenial, recursively `chmod 777` on `/home/travis` to ensure `stanley` can read/write the code.\n\nBecause this workaround makes many files executable, nose’s default behavior (skipping executable files) threatened to cause tests to be silently skipped. The project mitigated this by adding `--exe` to all nosetests invocations:\n- The orquesta integration tests in the `Makefile` now run `nosetests ... --exe`.\n- A new `.ci-travis-permissions-workaround` make target runs the permissions script, and the CI targets `ci-packs-tests` and `ci-py3-unit` depend on it.\n- In `tox.ini`, all unit-test `nosetests` commands were updated to include `--exe`, as well as the `py36` Mistral runner tests.\n\nAdditionally, to help debug a failing sendmail test on Travis, the sendmail test `test_sendmail_default_text_html_content_type` was temporarily instrumented to print the action status, result, email data, and message when calling `_run_action`.\n\nFinally, there was an experimental change to the RabbitMQ transport bootstrap: during exchange declaration, the code now sets `durable=False` and `delivery_mode=1` (transient). This was intended to see if non-durable, transient exchanges speed up tests on CI. The MongoDB repo setup retained a Precise codename in the repo string, but Xenial’s apt was fine with it in this context.\n\nOverall, the resolution involved migrating Travis from Precise to Xenial, hardening the custom apt-get workflow, relaxing CI timeouts to match the slower environment, and introducing a permissions workaround plus `--exe` flags so that all tests continue to be discovered and run correctly under the new CI image.",
        "semantic_memory": "This case illustrates several generalizable patterns when maintaining CI pipelines and dealing with upstream environment changes:\n\n1. **Avoid over-reliance on CI provider addons when they become unstable**: Travis' apt addon (`travis_apt_get_update`) became a point of failure. By switching to explicit `apt-get` commands with well-controlled options (retries, timeouts, IPv4 enforcement), the project regained control over its dependency installation behavior. In general, when a CI-provided abstraction is flaky, bypass it in favor of explicit, debuggable steps.\n\n2. **Network and apt issues can often be mitigated with retries, timeouts, and cache cleanup**: Using `Acquire::Retries`, `Acquire::http::Timeout`, and `Acquire::ForceIPv4` mitigates transient network and DNS issues. Cleaning `/var/lib/apt/lists` and running `apt-get clean` can fix corrupted or stale apt cache state that leads to hangs or header-waiting behavior.\n\n3. **Migrating CI images (OS versions) can expose hidden assumptions**: Moving from Precise to Xenial changed performance characteristics (slower tests) and user/permissions behavior. This revealed assumptions like \"tests run under the same user that owns the workspace\" and \"files are non-executable by default\". When you change CI base images, expect to revisit timeouts, file permissions, and tools' default discovery rules.\n\n4. **CI timeouts must reflect real-world performance on the chosen environment**: As the OS and toolchain changed, tests ran 30–50% slower. Instead of treating these as intermittent failures, the project increased per-command thresholds (via `COMMAND_THRESHOLD`) to realistic values. This is a general pattern: align CI timeout settings with observed behavior in the actual runtime environment.\n\n5. **File permissions affect test discovery**: Nose (and some other test runners) skip executable files by default. A broad permissions change (e.g., `chmod -R 777`) can unexpectedly mark test files executable and cause them to be skipped. The fix is either to constrain the permissions change or to adjust the test runner configuration (e.g., `nosetests --exe`) to continue discovering tests. This is a general lesson: any large-scale chmod in CI may interact with testing tools’ assumptions.\n\n6. **Cross-user test execution requires explicit permission management**: When tests are run as a different user than the CI checkout user (e.g., `stanley` vs `travis`), workspace permissions must be set accordingly. The general solution is to ensure shared group ownership, adjust umask, or (as a blunt but effective workaround) loosen permissions on the workspace. The StackStorm project used `chmod 777 /home/travis` as a pragmatic CI-only workaround.\n\n7. **Debugging CI-only failures benefits from temporary, targeted logging**: The sendmail test that passed locally but failed on Travis was temporarily modified to print action status, result, email data, and message. This pattern—adding targeted debug output only around CI-only failures—is generally useful when remote CI logs are the only source of truth.\n\n8. **Message broker configuration can be tuned for test speed**: Marking exchanges as non-durable and messages as transient (`delivery_mode=1`) can reduce I/O overhead in a test environment. For ephemeral CI test runs, durability is often unnecessary. As long as this is limited to test or CI-specific paths, it can improve performance without impacting production semantics.\n\nOverall, the broader lesson is that CI pipelines live in an evolving environment (OS images, provider infrastructure). Robust pipelines minimize hidden dependencies on provider-specific addons, explicitly manage networking and permissions, and treat configuration (timeouts, user IDs, repo setup) as first-class, observable, and adjustable concerns.",
        "procedural_memory": [
            "Step-by-step approach to diagnosing and fixing Travis CI apt timeouts and OS image migration issues:",
            "Step 1: Confirm the nature of the failure",
            "- Inspect Travis build logs and identify where the job hangs or fails. In this case, failures happened during `travis_apt_get_update` (Travis apt addon).",
            "- Check whether the repo changed recently. If not, suspect upstream CI changes (e.g., new images, infrastructure issues).",
            "",
            "Step 2: Bypass flaky CI provider addons",
            "- If the failure is in a CI addon (like Travis' `addons.apt`), comment out or remove that addon configuration from `.travis.yml`.",
            "- Replace it with explicit shell commands under `before_install` or a dedicated script:",
            "  - Add required apt repositories and keys manually (e.g., `add-apt-repository`, `curl ... | apt-key add -`).",
            "  - Add any custom repos to `/etc/apt/sources.list` or `/etc/apt/sources.list.d/*.list` using `tee`.",
            "",
            "Step 3: Harden apt-get against networking and cache problems",
            "- Use `apt-get` options that mitigate network flakiness and slow endpoints:",
            "  - `sudo apt-get clean` before updates to clear cached state.",
            "  - If apt hangs on headers, reset the list directory: move `/var/lib/apt/lists` to a backup and recreate `lists/partial`.",
            "  - Run `sudo apt-get update` with:",
            "    - `--option Acquire::ForceIPv4=true` (if IPv6 causes issues).",
            "    - `--option Acquire::Retries=100` (to retry on transient failures).",
            "    - `--option Acquire::http::Timeout=\"60\"` (to avoid indefinite stalls).",
            "- If using HTTPS repos, ensure `apt-transport-https` is installed before adding HTTPS sources.",
            "",
            "Step 4: Consider migrating to a newer CI base image",
            "- If the base image (e.g., Ubuntu Precise) is EOL or clearly unstable, switch to a newer distribution in the CI configuration:",
            "  - For Travis, change `dist: precise` to `dist: xenial` (or later) in `.travis.yml`.",
            "- Run a subset of jobs on the new image to evaluate compatibility and performance.",
            "",
            "Step 5: Adjust CI timeouts for a slower environment",
            "- Measure typical job durations on the new image. If tests run significantly slower (e.g., 30–50%), increase timeouts to avoid false-failing builds.",
            "- For this repo, a `COMMAND_THRESHOLD` environment variable was doubled for each job in the Travis matrix. In your project:",
            "  - Identify per-command or per-job timeout env vars or settings.",
            "  - Increase them conservatively (e.g., 2x) and monitor build stability.",
            "",
            "Step 6: Handle cross-user permissions in CI",
            "- Determine which user owns the workspace and which user runs tests (e.g., `travis` vs `stanley`).",
            "- If tests need to run as a non-owner user, ensure that user has sufficient permissions:",
            "  - E.g., for Travis on Xenial, this repo used:",
            "    - A root-only script `scripts/travis/permissions-workaround.sh` that:",
            "      - Detects the Ubuntu codename (`lsb_release -a`).",
            "      - On Xenial, runs `chmod -R 777 /home/travis`.",
            "  - Wire this script into CI via a Makefile target (e.g., `.ci-travis-permissions-workaround`) and make test targets depend on it (`ci-packs-tests`, `ci-py3-unit`).",
            "- In a more security-conscious setup, prefer group-based permissions or ACLs instead of a recursive 777, but for CI-only environments a broad chmod is often acceptable.",
            "",
            "Step 7: Prevent test discovery from breaking due to permissions changes",
            "- Some test runners (like nose) skip executable files by default. A blanket `chmod 777` can make test files executable and cause them to be ignored.",
            "- Update your test runner invocation to include flags that continue to include executable test files:",
            "  - For nose: add `--exe` to every `nosetests` command (Makefile, tox, CI scripts).",
            "  - Update all relevant pipelines (e.g., unit tests, integration tests, pack tests, specific runners like Mistral or Orquesta).",
            "",
            "Step 8: Add targeted debug logging for CI-only test failures",
            "- If a test fails only on CI, temporarily instrument it to print intermediate values:",
            "  - Capture return values (status, result objects, payloads) and print them before assertions.",
            "  - Use these logs from the CI build to understand environmental differences or side effects (e.g., missing env vars, different paths).",
            "- Once resolved, either remove or guard debug prints to avoid noisy logs.",
            "",
            "Step 9: Optimize message broker configuration for test speed (optional)",
            "- If your test suite interacts heavily with a message broker (e.g., RabbitMQ), consider using non-durable, transient constructs in the test environment:",
            "  - Set `durable=False` when declaring exchanges.",
            "  - Set `delivery_mode=1` (transient) for messages in tests.",
            "- Do this only in test/CI code paths or ensure it does not impact production expectations.",
            "",
            "Step 10: Validate the complete CI flow",
            "- Run the full CI matrix on the new image:",
            "  - Ensure all test categories (unit, integration, packs, Python 2/3 variants) run and pass.",
            "  - Confirm that no tests are silently skipped (double-check counts before/after changes).",
            "  - Watch for performance regressions and adjust thresholds if needed.",
            "- Once stable, remove or restrict any temporary debug instrumentation and document the CI-specific workarounds for future maintainers."
        ]
    }
}