{
    "search_index": {
        "description_for_embedding": "Home Assistant Hue integration: fix discovery flows so that when a Hue bridge is rediscovered via SSDP or HomeKit with a new host/IP, the existing config entry is updated instead of just aborting as already_configured. Uses the config flow helper _abort_if_unique_id_configured(updates={CONF_HOST: ...}) to keep the host in sync. Adds tests for host updates, import already_configured behavior, and error/missing-field paths in the config flow.",
        "keywords": [
            "Home Assistant",
            "Hue",
            "Philips Hue",
            "config_flow",
            "config entries",
            "discovery",
            "SSDP",
            "HomeKit",
            "unique_id",
            "already_configured",
            "host change",
            "IP change",
            "abort_if_unique_id_configured",
            "CONF_HOST",
            "linking error handling",
            "missing SSDP attributes"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Hue integration had a subtle issue with automatic discovery of already-configured Hue bridges. When a Hue bridge was discovered via SSDP or HomeKit, and that bridge was already configured (matched by unique_id), the config flow would abort with reason \"already_configured\" but would not update the stored host/IP address. If the bridge's hostname or IP changed (common in home networks without static leases), Home Assistant would keep trying to talk to the old host and could appear to have \"lost\" the bridge, even though discovery knew the new address.\n\nThe initial fix introduced a custom `_update_existing_entry` method that iterated over existing entries, compared `bridge.id` to `entry.unique_id`, and updated `entry.data[CONF_HOST]` when they differed, calling `async_update_entry` during the AbortFlow path. However, the core config flow helpers were enhanced in a related PR (#31090) to make this pattern generic. The implementation was then refactored to use the new `self._abort_if_unique_id_configured(updates={CONF_HOST: bridge.host})` API.\n\nThe final change is in `homeassistant/components/hue/config_flow.py`:\n- In `async_step_ssdp` and `async_step_homekit`, after creating an `aiohue.Bridge` instance and setting `self.unique_id` from `bridge.id`, the code now calls `self._abort_if_unique_id_configured(updates={CONF_HOST: bridge.host})`. If an existing entry is found, the flow is aborted as `already_configured` and the existing entry's `data[\"host\"]` field is automatically updated to the new host/IP.\n\nAdditional tests were added in `tests/components/hue/test_config_flow.py`:\n- `test_ssdp_discovery_update_configuration` and `test_homekit_discovery_update_configuration` verify that when a bridge with the same unique_id but a different host is rediscovered, the flow aborts as `already_configured` and the existing config entry's `host` is updated to the new value.\n- `test_bridge_import_already_configured` validates that import flows abort as `already_configured` when the host is already configured.\n- `test_flow_link_unknown_error` ensures that when an unexpected `OSError` occurs during user creation (linking), the flow returns to the `link` step with `errors = {\"base\": \"linking\"}`.\n- `test_bridge_ssdp_missing_location` and `test_bridge_ssdp_missing_serial` confirm that SSDP discovery aborts with `not_hue_bridge` if key attributes like `ssdp.ATTR_SSDP_LOCATION` or `ssdp.ATTR_UPNP_SERIAL` are missing.\n\nOverall, the bug was that discovery did not refresh the stored host for an existing Hue bridge; the fix leverages the core config flow API to update the entry atomically when aborting for an already-configured unique ID, plus adds tests for this behavior and related error cases.",
        "semantic_memory": "Generalizable knowledge from this fix:\n\n1. **Discovery flows should update dynamic connection parameters when an entity is rediscovered.**\n   In systems like Home Assistant, devices are often identified by a stable unique ID (serial, MAC, etc.), but their connection details (host, IP, port) can change. When a discovery flow detects a device whose unique ID matches an existing configuration entry, the correct behavior is usually to:\n   - Abort the flow as `already_configured` (to avoid duplicate entries), and\n   - Update the existing entry's dynamic fields (e.g., `host`) with the new data from discovery.\n\n2. **Use built-in helpers to update entries on abort rather than hand-rolling update logic.**\n   Home Assistant’s config flow framework supports updating an existing entry when aborting a flow via `_abort_if_unique_id_configured(updates=...)`. This is safer and more maintainable than manually iterating over entries and calling `async_update_entry` in exception handling paths.\n\n3. **Unique ID is the canonical identity; host/IP are mutable attributes.**\n   When designing device configuration models, treat hardware identifiers (like serial numbers) as the identity, and treat network addresses as mutable state to be refreshed any time better information is available (e.g., from SSDP, mDNS, or HomeKit). This prevents stale addresses from breaking integrations.\n\n4. **Explicit error handling for user-facing flows is important.**\n   During interactive steps (like linking a Hue bridge by pressing the button), unexpected exceptions (e.g., `OSError` during user creation) should not crash the flow but surface as a user-facing validation error (e.g., `errors = {\"base\": \"linking\"}`), so the user can retry.\n\n5. **Validate discovery payloads and abort early on incomplete data.**\n   Discovery protocols often have optional fields. The Hue SSDP logic explicitly checks for required attributes such as `location` and `serial`, and aborts with a clear reason (`not_hue_bridge`) when they are missing, preventing attempts to configure from incomplete or incorrect discovery data.\n\n6. **Tests should cover both the happy path and nuanced discovery/abort behaviors.**\n   Regression tests for: host/IP updates on rediscovery, import flows on already-configured devices, missing discovery fields, and error handling in linking steps help ensure the integration stays robust as the framework evolves.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues involving rediscovery and config entry updates:",
            "Step 1: Identify the symptom",
            "- Observe that devices which were previously configured become unreachable after their IP/host changes, despite the discovery system still finding them.",
            "- Check logs and config flows: discovery may report the device as already configured but the integration is still using an outdated host/IP.",
            "",
            "Step 2: Confirm the config model and unique ID usage",
            "- Inspect the integration’s config entries to see how identity and connection details are represented (e.g., `unique_id` vs `data[\"host\"]`).",
            "- Verify that a stable identifier (serial, MAC, UUID) is used as `unique_id` for the config entry.",
            "- Confirm that the host/IP is stored as a field in `entry.data` or similar.",
            "",
            "Step 3: Inspect discovery flows for already-configured behavior",
            "- Locate the config flow methods that handle discovery (e.g., `async_step_ssdp`, `async_step_homekit`, `async_step_zeroconf`, etc.).",
            "- Look for calls to `async_set_unique_id(...)` and `_abort_if_unique_id_configured()` or equivalent logic.",
            "- Check what happens when `_abort_if_unique_id_configured` is triggered: does it update the existing entry’s host, or just abort?",
            "",
            "Step 4: Use framework helpers to update the existing entry",
            "- If using Home Assistant’s config entries framework, replace manual update logic with the supported API:",
            "  - After computing the new host/IP from discovery, call:",
            "    `await self.async_set_unique_id(device_unique_id)`",
            "    `self._abort_if_unique_id_configured(updates={CONF_HOST: new_host})`",
            "- This ensures that if the entry already exists, the flow aborts as `already_configured` and the existing entry’s `data[\"host\"]` is updated atomically.",
            "- Remove any custom try/except `AbortFlow` logic that manually iterates over entries and calls `async_update_entry`, unless there is a specific need not covered by the helper.",
            "",
            "Step 5: Validate discovery input data",
            "- Review the discovery input (e.g., SSDP or HomeKit payload) and identify required fields (location URL, serial/ID, manufacturer URL).",
            "- In the discovery step, add guards that check for missing or invalid required attributes and abort with a clear reason (e.g., `not_device_type_x`) to avoid misconfigurations.",
            "",
            "Step 6: Improve error handling for interactive steps",
            "- For flows that require user interaction (like pressing a hardware button), wrap the communication/user-creation calls in try/except blocks.",
            "- On exceptions such as `OSError` or timeouts, return the same step with `result[\"type\"] == \"form\"`, the same `step_id`, and `errors[\"base\"]` set to a sensible key (e.g., `\"linking\"`) so the UI can show a retryable error.",
            "",
            "Step 7: Add regression tests",
            "- Add tests that:",
            "  - Create a `MockConfigEntry` with a given `unique_id` and old `host`, add it to hass, then run a discovery flow with the same ID but new host and assert:",
            "    - The flow aborts with `reason == \"already_configured\"`.",
            "    - `entry.data[\"host\"]` is updated to the new host/IP.",
            "  - Test `import` flows with an already-configured device to ensure they abort correctly without duplicating entries.",
            "  - Test missing or malformed discovery fields (e.g., missing `location` or `serial`) to ensure the flow aborts with a clear reason.",
            "  - Test error conditions during linking (e.g., raising `OSError` in mock user creation) and assert that the error is surfaced as a form error (`errors[\"base\"]`).",
            "",
            "Step 8: Run the full test suite and validate in a real environment",
            "- Run the integration’s tests to ensure all new and existing tests pass.",
            "- In a lab or test environment, change the device’s IP/host (e.g., via DHCP lease), wait for discovery to trigger, and verify that the integration continues to work and the config entry reflects the new host."
        ]
    }
}