{
    "search_index": {
        "description_for_embedding": "Home Assistant PR adding a new `counter` component used as an automation helper. Counters are configured in `configuration.yaml` with `initial`, `step`, `name`, and `icon`, and expose services (`counter.increment`, `counter.decrement`, `counter.reset`) for use in automations. Implementation uses an `EntityComponent`, service schemas in `services.yaml`, and tests to validate configuration, service behavior, and startup behavior (initial value always overrides any restored state).",
        "keywords": [
            "Home Assistant",
            "counter component",
            "automation helper",
            "stateful helper",
            "increment service",
            "decrement service",
            "reset service",
            "services.yaml registration",
            "voluptuous config schema",
            "EntityComponent",
            "restore_state",
            "configuration.yaml"
        ]
    },
    "agent_memory": {
        "episodic_memory": "This pull request implements a new `counter` component in Home Assistant to support counting within automations. The original discussion contrasted a generic timer component with this design. The author clarified that the goal is not time-based countdowns but discrete counting events (e.g., 'do x things, and after n times, trigger a notification').\n\nImplementation details:\n- A new domain `counter` is introduced with entities like `counter.count1`.\n- Configuration schema (`CONFIG_SCHEMA`) allows defining multiple counters in `configuration.yaml`:\n  - `name` (friendly name)\n  - `icon` (mdi icon)\n  - `initial` (starting integer value, default 0)\n  - `step` (increment/decrement amount, default 1)\n- Each counter is an `Entity` subclass with:\n  - `state` = current integer count\n  - Attributes `initial` and `step`\n  - Services: `async_increment`, `async_decrement`, `async_reset` that update `_state` and call `async_update_ha_state()`.\n- `async_setup` uses `EntityComponent` to manage entities and registers three domain services (`increment`, `decrement`, `reset`) using definitions loaded from `services.yaml`. A common async service handler dispatches to the appropriate method on all target counters.\n- Synchronous and asynchronous helper functions (`increment`, `async_increment`, etc.) are bound via `@bind_hass` to allow easy usage from Python scripts.\n- The component imports `async_get_last_state` but, by design and tests, it effectively ignores restored state: the entity's `_state` is initialized to the configured `initial` (or 0) and is never `None`, so the restore logic is not triggered. Tests explicitly verify that any restore cache is ignored and that `initial` always wins.\n\nTest coverage includes:\n- Invalid configuration shapes are rejected (`None`, non-dict, bad keys).\n- Basic behavior of `increment`, `decrement`, and `reset` using the default configuration: starting at 0, incrementing to 2, decrementing to 1, reset back to 0.\n- Behavior with custom configuration: starting at `initial=10` and changing in steps of `5`.\n- Configuration options: verifying that entities with and without optional fields are created, and that `friendly_name` and `icon` attributes are set only when configured.\n- Startup behavior: ensuring that both counters with and without an explicit `initial` ignore any previous stored state and start at either 0 or the configured `initial` value.",
        "semantic_memory": "Generalizable lessons from this PR:\n\n1. Designing an automation helper component (non-device, stateful helper):\n   - Use a dedicated domain (e.g., `counter`) with an `EntityComponent` to manage entity lifecycle.\n   - Expose simple, stateless services (e.g., `increment`, `decrement`, `reset`) that operate on internal entity state; this keeps integrations and automations using a clear, declarative API.\n   - Use YAML configuration with a `voluptuous` schema to define per-entity options. `cv.slug` keys let users define multiple named instances easily.\n\n2. Service design and registration in Home Assistant:\n   - Group related services under the component's domain and define their schema via `voluptuous` (`entity_id` optional to allow targeting multiple entities).\n   - Place human-readable service descriptions in `services.yaml` and load them at runtime with `load_yaml_config_file`. This keeps code and UI documentation in sync.\n   - Provide both sync and async helper functions (`increment`, `async_increment`) bound with `@bind_hass` so that Python scripts can call them easily from different contexts.\n\n3. State management for helper entities:\n   - For deterministic behavior, especially after restarts, it's often better to define an explicit `initial` value and ignore persisted state, especially for counters used in one-off or bounded workflows.\n   - If you want to ignore restored state, initialize `_state` in the constructor and avoid leaving it `None`; the restore logic should only execute when there truly is no configured initial state.\n   - Expose essential configuration parameters (like `initial` and `step`) as state attributes. This gives UI and automations access to metadata without extra storage.\n\n4. Testing new components:\n   - Test configuration validation explicitly, including invalid types and invalid keys.\n   - Test service behavior end-to-end: call the service helpers, block until done, then assert on the state.\n   - Test optional configuration behavior (names, icons) by asserting on attributes and entity counts.\n   - Test startup behavior with and without restore cache to make sure the component's initialization strategy is correct and stable.\n\nOverall pattern: when adding a new HA component that acts as an automation helper rather than talking to external devices, define clear domain services, a strict config schema, explicit initial state behavior, and comprehensive tests around configuration and service behavior.",
        "procedural_memory": [
            "How to design and implement a Home Assistant counter-like helper component:",
            "Step 1: Define the domain, constants, and configuration schema.\n- Choose a unique domain name (e.g., `counter`).\n- Define constants for configuration options (`CONF_INITIAL`, `CONF_STEP`, `CONF_NAME`, `CONF_ICON`) and defaults.\n- Use `voluptuous` to declare `CONFIG_SCHEMA`, with a mapping from `cv.slug` object IDs to per-entity config dicts.\n- Provide sensible defaults so that minimal configuration is valid (e.g., default initial 0, default step 1).",
            "Step 2: Implement the Entity class.\n- Subclass `homeassistant.helpers.entity.Entity`.\n- In `__init__`, set `entity_id`, `_name`, `_icon`, `_initial`, `_step`, and `_state`. If you want deterministic restarts, set `_state` to `_initial` (or 0) and avoid using restore_state.\n- Implement properties: `should_poll` (False), `name`, `icon`, `state`, and `state_attributes` to expose configuration like `initial` and `step`.\n- Implement async methods to mutate state (`async_increment`, `async_decrement`, `async_reset`) that update `_state` and call `async_update_ha_state()`.",
            "Step 3: Implement async_setup and register services.\n- In `async_setup(hass, config)`, create an `EntityComponent` with the domain.\n- Iterate over `config[DOMAIN]` items to construct your entity instances and collect them into a list.\n- Define a common async service handler that:\n  - Uses `component.async_extract_from_service(service)` to get all target entities.\n  - Maps `service.service` to the proper method name (e.g., `async_increment`, `async_decrement`, `async_reset`).\n  - Schedules the entity method coroutines (via `asyncio.wait`).\n- Load service descriptions from `services.yaml` using `load_yaml_config_file`.\n- Call `hass.services.async_register` for each domain service with the handler, description, and `SERVICE_SCHEMA`.\n- Finally, `yield from component.async_add_entities(entities)` to add all entities.",
            "Step 4: Provide bound helper functions for convenience.\n- Use the `@bind_hass` decorator to create functions like `increment(hass, entity_id)` and `async_increment(hass, entity_id)`.\n- The sync version should schedule the async version via `hass.add_job`.\n- The async version should call `hass.services.async_call(DOMAIN, SERVICE_XXX, {ATTR_ENTITY_ID: entity_id})`.\n- Repeat for other actions (decrement, reset). This lets Python code interact with the component easily.",
            "Step 5: Add service metadata to services.yaml.\n- Under your domain key (`counter:`) in `homeassistant/components/services.yaml`, define each service (`increment`, `decrement`, `reset`).\n- For each, include a `description` and `fields` section, describing `entity_id` and providing an example.\n- This ensures UI and developer docs show correct service usage.",
            "Step 6: Write tests for configuration and behavior.\n- Use `get_test_home_assistant()` and `setup_component` / `async_setup_component` to load your component in tests.\n- Test invalid configurations (e.g., `None`, non-dict types, invalid keys) and assert that `setup_component` returns `False`.\n- Test service behavior by:\n  - Setting up with a minimal configuration.\n  - Retrieving the entity state.\n  - Calling `increment/decrement/reset` helpers.\n  - `block_till_done()` and assert that the state changes as expected.\n- Test configuration options: verify that entities with custom `name`, `icon`, `initial`, `step` have the correct state and attributes.\n- If relevant, test startup/restore behavior using `mock_restore_cache` and `CoreState.starting` to ensure your design (restore vs. initial value) behaves as expected.",
            "Step 7: When designing restart behavior, decide on restore vs. initial.\n- If you want counters to always start fresh on restart, always initialize `_state` to `initial` or 0 and ignore restore_state.\n- If you want to restore previous state, leave `_state` as `None` in the constructor and use `async_added_to_hass` to fetch the last state via `async_get_last_state` and set `_state` from it when available.\n- Add explicit tests for both scenarios to avoid surprises for users after a restart."
        ]
    }
}