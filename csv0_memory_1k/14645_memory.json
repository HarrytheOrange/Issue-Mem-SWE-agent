{
    "search_index": {
        "description_for_embedding": "Home Assistant Hue integration bug where activating scenes by name failed or picked the wrong scene when the same scene name existed in multiple Hue groups. Fixed by restoring logic to disambiguate duplicate scene names using the group’s light IDs, enabled by upgrading aiohue to 1.5.0 so scene.lights is available.",
        "keywords": [
            "Home Assistant",
            "Hue",
            "Philips Hue",
            "aiohue",
            "scene activation",
            "duplicate scene names",
            "group lights matching",
            "regression after dependency upgrade",
            "requirements_all.txt",
            "async component"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Hue integration could not reliably activate Hue scenes when multiple groups contained scenes with the same name (e.g., default Hue scenes reused across rooms). The Hue component’s service call expected a (group_name, scene_name) pair but, after a previous refactor to use the aiohue library, the disambiguation logic for duplicate scene names had been removed. The code was simply doing:\n\n- Find the group object by matching group.name to the requested group_name.\n- Find a scene_id by taking the first scene where scene.name == scene_name.\n\nIf the same scene name existed in multiple groups, this naive search could pick the wrong scene or fail to find the desired one, breaking scene activation for common setups.\n\nThe fix restores and adapts the original disambiguation logic using the newer aiohue API (version 1.5.0). The updated `hue_activate_scene` implementation now:\n\n1. Locates the group by name as before.\n2. Gathers all scenes with the requested scene_name.\n3. If only one matching scene exists, it uses that scene’s id directly.\n4. If multiple scenes share the same name, it compares the group’s light IDs with each candidate scene’s `lights` list. It sorts the group’s `group.lights` and checks for equality with `scene.lights` to find the scene that exactly matches the group’s composition. The first such match determines the scene_id.\n5. If neither the group nor a suitable scene_id is found (and `updated` is False), it falls back to re-fetching the latest data as before.\n\nTo support this, the dependency on `aiohue` was bumped from 1.3.0 to 1.5.0 in the Hue component (`homeassistant/components/hue/__init__.py`) and in the global requirement files (`requirements_all.txt` and `requirements_test_all.txt`), because aiohue 1.5.0 exposes the necessary scene light information on the scene objects. Earlier drafts of the PR temporarily referenced a GitHub archive of a custom aiohue fork, but the final change uses the published `aiohue==1.5.0` release.\n\nThe branch unintentionally picked up unrelated changes (gitterpy, TwitterAPI, lw12wifi), and a reviewer noted the branch contamination and requested a cleanup. This is a process reminder that feature branches should be kept focused on a single change.\n\nThe outcome: Home Assistant once again correctly supports duplicate Hue scene names by selecting the scene that matches the target group’s lights, restoring pre-aiohue behavior and fixing issue #13685.",
        "semantic_memory": "Generalizable lessons from this fix:\n\n1. **Disambiguate by structure, not just labels:** Human-readable names (like scene names) are often not unique across a system. When you need to programmatically identify a resource (scenes, rooms, profiles), relying only on a name string is brittle. Use additional structural context (e.g., associated group, light IDs, or other identifiers) to pick the correct object.\n\n2. **Maintain behavior parity during refactors:** When migrating to a new library (here, switching to aiohue), it is easy to drop edge-case logic that handled real-world scenarios (like duplicate scene names). Regression tests or explicit checks for feature parity can prevent subtle behavior regressions that users will notice.\n\n3. **Leverage richer API models to resolve ambiguity:** Newer versions of APIs or libraries often expose more detailed models (e.g., a scene’s list of lights). These can and should be used to resolve ambiguities instead of adding brittle heuristics. Matching on underlying IDs (e.g., `group.lights` vs `scene.lights`) is more robust than matching on shared labels.\n\n4. **Upgrade dependencies intentionally and consistently:** When a feature fix depends on a library change, ensure the dependency is updated both in the component-specific requirement and in the project-wide requirement files (runtime and test). Temporary pointers to personal forks or GitHub ZIPs should be removed in favor of proper, versioned releases before merging.\n\n5. **Keep feature branches focused:** Mixing unrelated changes (like unrelated library upgrades or new components) into a feature/bugfix branch makes review and integration harder and risks blocking the primary fix. Each PR should be as atomic as practical.\n\n6. **Consider duplicate names as a first-class design concern:** In domains like lighting, media, or user-facing names, duplicate names are common and often generated by default. System design should assume duplicates will occur and directly support disambiguation by context (e.g., by group, location, or ID).\n\n7. **Use sorted comparisons when order is not semantically meaningful:** When comparing collections of IDs where order doesn’t matter (e.g., sets of light IDs in a group versus a scene), sort the lists (or use sets) before comparison to avoid false mismatches from ordering differences.\n",
        "procedural_memory": [
            "Step-by-step strategy to diagnose and fix issues with ambiguous or duplicate resource names in an integration:",
            "Step 1: Reproduce the problem with a minimal setup. In this case, create two Hue groups (rooms) each having a scene with the same name (e.g., 'Relax') and attempt to activate the scene via the integration’s service (e.g., `hue.hue_activate_scene` with group_name and scene_name). Confirm that the wrong scene is activated or that activation fails.",
            "Step 2: Inspect the current implementation of the scene activation logic. Look for how the code selects scenes: is it only matching on `scene.name` or is it using additional context (group id, list of lights, or unique IDs)? Identify where ambiguity can arise when names are duplicated.",
            "Step 3: Review previous versions or pre-refactor behavior. Compare current logic with the old implementation (before a migration or major refactor). Check commit history or pre-migration code to see if there was special handling for duplicate names that was inadvertently removed.",
            "Step 4: Check the underlying API/library capabilities. Inspect the models exposed by the device/service library (here, aiohue). Look for properties that relate resources to each other (e.g., `scene.lights` vs `group.lights`, or scene->group mapping). Determine what structural data you can use to uniquely identify the desired resource.",
            "Step 5: Design a disambiguation strategy. For duplicate scene names, decide how to select the correct scene. A robust pattern is:\n- Filter scenes by the requested name.\n- If there is exactly one match, use it.\n- If several matches exist, choose the one whose associated structural information (like light IDs) matches the target context (like the group's lights).",
            "Step 6: Implement the narrowed selection logic. For example, in the Hue bridge code:\n- Collect `scenes = [scene for scene in api.scenes.values() if scene.name == requested_scene_name]`.\n- If `len(scenes) == 1`, set `scene_id = scenes[0].id`.\n- Otherwise, compare sorted `group.lights` with each `scene.lights` and set `scene_id` when they match.\n- Ensure you handle the 'no match found' case gracefully (e.g., leave `scene_id` as None and trigger a refresh or error).",
            "Step 7: Adjust dependency versions if needed. If your disambiguation logic requires newer API fields (like `scene.lights` introduced in aiohue 1.5.0), bump the dependency version in:\n- The specific component’s `REQUIREMENTS`.\n- Project-wide `requirements_all.txt`.\n- Test requirements such as `requirements_test_all.txt`.\nEnsure all environments use the new version.",
            "Step 8: Add or update tests around the edge case. Create tests that simulate multiple scenes with the same name across different groups and verify the API call selects the scene whose lights match the specified group. This guards against future regressions when refactoring.",
            "Step 9: Clean up branch and PR scope. Remove unrelated commits and dependency changes that are not required for the fix. Keep the PR focused on the bug and its direct dependencies to simplify review and reduce the risk of merge conflicts.",
            "Step 10: Validate end-to-end. After the fix and dependency upgrade, run local tests and try activating scenes in a real or mocked Hue setup that includes duplicate scene names. Confirm that each group activates the correct scene and that there are no regressions for unique-name scenes."
        ]
    }
}