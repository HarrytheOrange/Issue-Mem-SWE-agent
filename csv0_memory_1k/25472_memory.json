{
    "search_index": {
        "description_for_embedding": "Fix for Home Assistant Nest climate integration where turning off eco mode on a heat/cool-capable Nest thermostat tried to write an invalid mode ('auto') to the Nest API instead of 'heat_cool', plus addition of explicit hvac_action mapping based on Nest hvac_state.",
        "keywords": [
            "Nest",
            "Home Assistant",
            "climate",
            "hvac_mode",
            "eco mode",
            "preset_eco",
            "heat_cool",
            "auto mode mapping",
            "API mode mapping bug",
            "enum mapping",
            "CURRENT_HVAC_HEAT",
            "CURRENT_HVAC_COOL",
            "CURRENT_HVAC_IDLE",
            "hvac_action",
            "hvac_state"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the Home Assistant Nest climate integration had a bug when handling eco mode for thermostats that support both heating and cooling. When the user turned eco mode off (preset ECO -> normal mode), the integration attempted to restore the prior hvac_mode using a raw value from the operation list. For Nest devices with heat/cool capability, Home Assistant's hvac_mode.AUTO should be represented as 'heat_cool' in the Nest API. However, the code path for exiting eco mode and the general hvac_mode mapping logic were inconsistent, and the mapped mode could end up being 'auto', which Nest does not accept. This caused failures when toggling eco off.\n\nThe fix introduced a single, centralized mapping between Home Assistant HVAC mode constants and Nest mode strings: MODE_HASS_TO_NEST and its inverse MODE_NEST_TO_HASS. All conversions between Home Assistant and Nest modes, including when leaving eco mode, now go through these mappings. Specifically, set_hvac_mode and the eco preset handler (set_preset_mode) now use MODE_HASS_TO_NEST, and hvac_mode reads from MODE_NEST_TO_HASS, with special handling for NEST_MODE_ECO where the first available operation is used.\n\nAdditionally, the pull request added support for hvac_action reporting. A new ACTION_NEST_TO_HASS mapping converts Nest's hvac_state values ('off', 'heating', 'cooling') into Home Assistant's CURRENT_HVAC_* constants (IDLE, HEAT, COOL). The NestClimateDevice now tracks self._action from device.hvac_state in update(), and exposes it via the hvac_action property. This makes the integration accurately reflect whether the Nest is actively heating, cooling, or idle.",
        "semantic_memory": "This fix illustrates several generalizable patterns for integrations with third-party APIs, especially where both sides use enumerations or string constants for modes:\n\n1. **Centralized bidirectional mapping for modes:** When two systems represent the same concept with different values (e.g., Home Assistant's hvac_mode.AUTO vs Nest's 'heat_cool'), maintain a single, authoritative mapping (e.g., MODE_HASS_TO_NEST and MODE_NEST_TO_HASS) used everywhere. This avoids divergence when new code paths are added (such as presets, special modes, or state restoration). Duplicate or ad-hoc mappings are a common source of subtle bugs.\n\n2. **Use reverse maps rather than conditionals:** Instead of multiple if/elif chains converting between modes, a dictionary plus its inverse makes conversions more robust and easier to extend. It also makes it clear when an unsupported mode is encountered, enabling explicit error handling.\n\n3. **Presets and special modes must restore underlying modes correctly:** Eco/away presets often temporarily override the device mode. When unsetting such presets, the integration should restore an underlying hvac_mode using the same mapping logic as normal mode changes. Restoring raw, device-specific strings without mapping can lead to invalid API calls or inconsistent UI state.\n\n4. **Separate device mode (configuration) from hvac action (runtime state):** Many HVAC devices distinguish between configured mode (heat, cool, heat_cool, off) and current action (heating, cooling, idle). Integrations should expose both concepts via dedicated properties like hvac_mode and hvac_action, with explicit mapping from the vendor's state fields (e.g. Nest's hvac_state) to platform-level constants (e.g. CURRENT_HVAC_*). This improves UI fidelity and automations that depend on actual activity.\n\n5. **Always align integration constants with official platform interfaces:** Using the standardized constants (HVAC_MODE_*, CURRENT_HVAC_*) and mapping correctly to vendor-specific values keeps the integration stable as the platform evolves and avoids breaking automations.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce and characterize the behavior\n- Trigger the problematic transition, e.g., toggle an HVAC preset such as eco/away on and then off, particularly on devices with multiple supported modes (heat/cool).\n- Observe logs and network/API traffic to see what mode values are being sent to the third-party API (e.g., Nest). Look for rejected requests or unexpected device behavior.\n",
            "Step 2: Identify all mappings between platform and vendor modes\n- Search the integration code for where hvac_mode (or equivalent) is read and written.\n- List all conversion points between platform constants (e.g., HVAC_MODE_AUTO, HVAC_MODE_HEAT) and vendor strings (e.g., 'heat_cool', 'heat', 'cool', 'off').\n- Pay special attention to preset handling (eco/away), startup/restore logic, and any helper properties that infer modes.\n",
            "Step 3: Consolidate mappings into centralized dictionaries\n- Create a single dictionary mapping from platform -> vendor (e.g., MODE_HASS_TO_NEST = {HVAC_MODE_AUTO: 'heat_cool', ...}).\n- Create the inverse mapping vendor -> platform with a comprehension (MODE_NEST_TO_HASS = {v: k for k, v in MODE_HASS_TO_NEST.items()}) to avoid duplication.\n- Replace scattered if/elif mapping logic with lookups to these dictionaries in all relevant methods (set_hvac_mode, hvac_mode property, preset handling, etc.).\n",
            "Step 4: Fix preset/unset logic to use the same mapping\n- For code that restores a previous mode when a preset is disabled (e.g., leaving eco mode), ensure it uses the same MODE_HASS_TO_NEST mapping.\n- Do not write raw platform or UI-level values (like 'auto') directly to the device; always convert via the mapping to the vendor’s expected value (e.g., 'heat_cool').\n- Verify that for all possible prior modes (heat, cool, auto, off), the correct vendor string is produced.\n",
            "Step 5: Add or correct hvac action/state mapping\n- Identify the vendor’s field that represents actual runtime action (e.g., Nest’s hvac_state = 'off' | 'heating' | 'cooling').\n- Introduce a mapping from vendor actions to platform CURRENT_HVAC_* constants (e.g., ACTION_NEST_TO_HASS = {'off': CURRENT_HVAC_IDLE, 'heating': CURRENT_HVAC_HEAT, 'cooling': CURRENT_HVAC_COOL}).\n- Track this state in the entity’s update() method (e.g., self._action = device.hvac_state) and expose it through a hvac_action property using the mapping.\n",
            "Step 6: Add defensive checks and logging (optional but recommended)\n- Where appropriate, handle unknown keys in the mapping dictionaries by logging a clear error or falling back to a safe default (like OFF or IDLE) rather than raising a KeyError.\n- Log unexpected vendor values to help diagnose future API changes.\n",
            "Step 7: Test across all supported modes and presets\n- Write or run unit/integration tests that:\n  - Set each hvac_mode and verify correct values are sent to the vendor API.\n  - Enable and disable eco/away presets and confirm that the underlying hvac_mode is restored correctly and accepted by the vendor API.\n  - Check that hvac_action reflects the true heating/cooling/idle state as reported by the device.\n- Manually test on a device that supports both heat and cool to confirm the specific bug (eco off => invalid mode) is resolved.\n",
            "Step 8: Document and maintain mappings\n- Clearly document in code comments that MODE_HASS_TO_NEST and MODE_NEST_TO_HASS (and ACTION_NEST_TO_HASS) are the only authoritative mappings.\n- When adding new modes or vendor features, update these mappings first and ensure all call sites use them."
        ]
    }
}