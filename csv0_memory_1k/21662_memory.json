{
    "search_index": {
        "description_for_embedding": "Fix CORS configuration so that the HTTP API correctly allows the Authorization header (e.g., Bearer tokens) in cross-origin requests by adding it to Access-Control-Allow-Headers using aiohttp's AUTHORIZATION constant, and add tests to verify both normal and preflight CORS behavior.",
        "keywords": [
            "CORS",
            "Authorization header",
            "Access-Control-Allow-Headers",
            "preflight request",
            "OPTIONS request",
            "aiohttp.hdrs.AUTHORIZATION",
            "homeassistant.components.http.cors",
            "HTTP_HEADER_HA_AUTH",
            "cross-origin requests",
            "browser auth token",
            "Bearer token",
            "HTTP component",
            "header whitelist",
            "CORS bug",
            "frontend cannot send Authorization header",
            "API authentication",
            "X-HA-access",
            "trusted origin"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, the HTTP component of Home Assistant had incomplete CORS configuration. The CORS middleware allowed certain headers (Origin, Accept, X-Requested-With, Content-Type, X-HA-access), but it did not include the standard Authorization header. As a result, browser-based clients making cross-origin requests with an Authorization: Bearer <token> header could not properly negotiate CORS, because the preflight response (Access-Control-Allow-Headers) did not permit the Authorization header. This would manifest as the browser blocking cross-origin API calls even though the server supported token-based authentication.\n\nThe fix updated homeassistant/components/http/cors.py to include the Authorization header in the ALLOWED_CORS_HEADERS list. Initially, a custom constant HTTP_HEADER_AUTHORIZATION was added to homeassistant/const.py and used in the CORS module and tests. In a follow-up patch, this was refactored to use aiohttp's built-in AUTHORIZATION header constant from aiohttp.hdrs, removing the custom constant from const.py. The ALLOWED_CORS_HEADERS list now includes AUTHORIZATION alongside ORIGIN, ACCEPT, HTTP_HEADER_X_REQUESTED_WITH, CONTENT_TYPE, and HTTP_HEADER_HA_AUTH.\n\nTests in tests/components/http/test_cors.py were extended to cover the Authorization header scenario. The CORS tests now make a request with an Authorization: Bearer some-token header and a trusted Origin, asserting that the response is 200 and that the Access-Control-Allow-Origin header is correctly set. The imports were updated to use AUTHORIZATION from aiohttp.hdrs instead of the removed HTTP_HEADER_AUTHORIZATION constant. This verifies that CORS allows Authorization in both normal and preflight contexts and that browser clients can use Authorization headers without CORS errors.\n\nThere was a brief confusion during code review about CORS and credentials, but it was clarified that the change affects which headers are allowed via Access-Control-Allow-Headers, not the inclusion of credentials in preflight requests. After this clarification, the change was accepted as the correct way to solve the issue.",
        "semantic_memory": "This fix illustrates a common class of web API problems: CORS configuration that omits necessary headers, causing browser-based clients to fail even though the backend logic for authentication is correct. Modern web applications often send tokens in the Authorization header (e.g., Bearer tokens). For such requests to work across origins, the server must explicitly list Authorization in Access-Control-Allow-Headers; otherwise, the browser's preflight (OPTIONS) check will reject the request and the client sees a CORS error rather than an authentication error.\n\nThe bug also highlights the distinction between CORS preflight behavior and credentials: while preflight requests themselves do not include credentials, they do negotiate which headers may be used in subsequent actual requests. Forgetting to expose authentication-related headers (Authorization, custom auth headers, X-Requested-With, etc.) in the Access-Control-Allow-Headers list commonly breaks cross-origin authentication flows.\n\nAnother generalizable lesson is to leverage framework- or library-provided header constants (such as aiohttp.hdrs.AUTHORIZATION) instead of redefining them as custom strings. This reduces duplication, avoids typos and inconsistencies, and makes code more idiomatic and maintainable.\n\nFrom a testing perspective, robust CORS implementations should be validated with unit/integration tests that:\n- Exercise both preflight (OPTIONS) and actual (GET/POST) requests.\n- Include all headers expected from real clients (Authorization, custom auth headers, etc.).\n- Assert that the appropriate Access-Control-* headers are present and correct, particularly Access-Control-Allow-Origin and Access-Control-Allow-Headers.\n\nOverall, when adding or changing authentication mechanisms in an HTTP API that is accessed from browsers, always cross-check CORS configuration to ensure required headers and methods are allowed and properly tested.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce the client-side error\n- Use a browser-based client (web app, devtools, or a minimal HTML+JS page) to call the API endpoint from a different origin.\n- Set the Authorization header (e.g., 'Authorization: Bearer some-token') or any other custom auth header used by your app.\n- Observe the browser console or network tab: if there is a CORS issue, you will typically see an error like 'Request header field Authorization is not allowed by Access-Control-Allow-Headers in preflight response' or a generic CORS failure.",
            "Step 2: Inspect the preflight (OPTIONS) request/response\n- In the browser devtools Network tab, find the OPTIONS request that precedes your failing GET/POST/PUT request.\n- Check the request headers: look at Access-Control-Request-Headers to see which headers the browser wants to send (e.g., 'authorization', 'content-type').\n- Check the server's response headers: specifically Access-Control-Allow-Headers and Access-Control-Allow-Origin. Confirm whether Authorization (or your required header) is present in Access-Control-Allow-Headers.",
            "Step 3: Locate CORS configuration on the server\n- Identify the middleware or module responsible for CORS (in this case, homeassistant.components.http.cors and its ALLOWED_CORS_HEADERS list).\n- Look for any hardcoded list or configuration that defines allowed headers, methods, and origins.",
            "Step 4: Add the missing header(s) to the allowed list\n- Add Authorization (and any other needed headers) to the server's allowed CORS headers configuration.\n- Prefer using framework-provided header constants (e.g., from aiohttp.hdrs: AUTHORIZATION, ORIGIN, ACCEPT) instead of raw string literals to avoid typos and maintain consistency.\n- Ensure that this change affects the logic that sets Access-Control-Allow-Headers in the response to preflight requests.",
            "Step 5: Update or add automated tests\n- Create or extend tests that simulate both:\n  - A regular request with the Authorization header and a trusted Origin.\n  - A preflight (OPTIONS) request indicating Authorization in Access-Control-Request-Headers.\n- Assert that:\n  - The server responds with status 200 (or the expected status) for the actual request.\n  - Access-Control-Allow-Origin is set correctly for trusted origins.\n  - Access-Control-Allow-Headers includes Authorization for preflight responses.\n- Use the same header constants in tests as in production code (e.g., AUTHORIZATION) to keep them in sync.",
            "Step 6: Verify behavior end-to-end\n- Restart or reload the server with the new configuration.\n- Repeat the browser-based test from Step 1.\n- Confirm that the preflight request now includes Authorization in Access-Control-Allow-Headers and that the main request no longer fails due to CORS.\n- Confirm that authentication itself still behaves as expected (e.g., valid tokens are accepted, invalid ones are rejected).",
            "Step 7: Document and standardize CORS/auth practices\n- Document which headers are required for your authentication scheme (Authorization, custom auth headers, CSRF tokens, etc.).\n- Standardize server CORS configuration to always expose these headers for allowed origins.\n- When introducing new auth-related headers in the future, update both CORS configuration and tests as part of the same change."
        ]
    }
}