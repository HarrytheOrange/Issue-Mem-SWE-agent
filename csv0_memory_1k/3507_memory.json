{
    "search_index": {
        "description_for_embedding": "Home Assistant tests were updated to use the centralized bootstrap.setup_component() API instead of calling each component's setup() function directly. Several test configurations for statsd, splunk, and logentries were also fixed to use the correct option names and match the components' current configuration schemas.",
        "keywords": [
            "Home Assistant",
            "setup_component",
            "bootstrap",
            "component setup",
            "unit tests",
            "statsd config",
            "splunk config",
            "logentries config",
            "mqtt_eventstream",
            "device_sun_light_trigger",
            "introduction component",
            "persistent_notification",
            "test failure",
            "configuration schema change"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this pull request, multiple Home Assistant component tests were failing or becoming brittle because they were directly invoking each component's setup() function instead of the framework-level homeassistant.bootstrap.setup_component() helper. This bypassed the standardized bootstrapping process (including dependency handling and consistent behavior) that the core now expects. To align tests with production behavior, the tests were refactored to import setup_component from homeassistant.bootstrap and call setup_component(hass, DOMAIN, config) instead of component.setup(hass, config).\n\nSpecifically:\n- Demo components (hvac.demo, light.demo, demo, device_tracker/light/sun for device_sun_light_trigger, conversation, history, graphite, introduction, persistent_notification, mqtt_eventstream, logentries, statsd, splunk, mfi sensors/switches, rollershutter command_line) were all updated to use setup_component.\n- In tests for splunk, the configuration key 'use_ssl' was corrected to 'ssl' to match the component's current CONF_SSL setting.\n- In tests for statsd, the configuration key 'sample_rate' was corrected to 'rate' to match the component's CONF_RATE and the current schema.\n- In logentries tests, a now-invalid 'host' setting was removed from the test configurations, leaving only the required 'token' to reflect the actual schema. The tests that construct handlers via hass.bus.listen were left intact, but the setup is now done via setup_component.\n\nAfter these changes, the tests correctly use the framework's standard setup path and provide configuration data that matches the live components' expected schemas, making tests more accurate and resilient to internal changes.",
        "semantic_memory": "Generalizable lessons from this fix:\n\n1. **Use the framework's official setup/bootstrapping API in tests**: When a framework exposes a central setup helper (e.g., homeassistant.bootstrap.setup_component) that encapsulates dependency resolution, lifecycle events, and consistent patterns, tests should use this entry point instead of calling internal or per-component setup() methods. This keeps tests aligned with real runtime behavior and avoids subtle bugs where code paths differ between tests and production.\n\n2. **Keep test configuration in sync with the component's schema**: Components often evolve their configuration schemas (e.g., renaming keys like 'use_ssl' to 'ssl' or 'sample_rate' to 'rate'). If tests use outdated or ad hoc config structures, they may quietly drift from reality or start failing after internal changes. Tests should use the same constants (e.g., DOMAIN, CONF_* constants) and config layout as the actual components.\n\n3. **Avoid relying on deprecated or unused config options**: Tests that include configuration keys no longer used (like a removed 'host' option in logentries) will break once validation is tightened or may give a false picture of behavior. Test configs should be minimal and valid according to the current API, focusing only on documented options.\n\n4. **Use domain constants, not literal strings where possible**: Using component.DOMAIN instead of hardcoded strings ('graphite', 'statsd', etc.) reduces the risk of typos and makes refactors safer. This is especially important when calling generic helpers like setup_component(hass, domain, config).\n\n5. **Mocking remains the same, but initialization changes**: Even when using mocks (MagicMock hass, patched sockets or HTTP clients), the entry point for wiring event listeners and side effects should still be the official setup function. This ensures you're testing the actual integration between the component and the event bus, not an artificial code path.\n\nOverall, the pattern is: centralize setup logic, respect the public API, and ensure tests reflect the real configuration and lifecycle of components.",
        "procedural_memory": [
            "When component tests fail or diverge after framework setup refactors, migrate them to use the canonical setup helper and update their configs to match the current schema.",
            "Step 1: Identify failing or fragile tests that call component.setup(hass, config) directly or otherwise bypass the framework's bootstrap logic.",
            "Step 2: Import the framework's setup helper where appropriate, e.g.: `from homeassistant.bootstrap import setup_component`.",
            "Step 3: Replace direct component setup calls with the standardized helper, using the component's DOMAIN constant:",
            "  - Before: `assert component.setup(hass, config)` or `component.setup(hass, { 'domain': {...} })`",
            "  - After: `assert setup_component(hass, component.DOMAIN, config)`.",
            "Step 4: Ensure the configuration structure matches the component's current schema:",
            "  - Use the component's documented CONF_* constants where available (e.g., CONF_SSL, CONF_RATE).",
            "  - Rename outdated keys to the current ones (e.g., 'use_ssl' -> 'ssl', 'sample_rate' -> 'rate').",
            "  - Remove config options that no longer exist (e.g., obsolete 'host' fields) unless the component explicitly requires them.",
            "Step 5: Use DOMAIN constants instead of hard-coded strings when passing domain names to setup_component, e.g. `setup_component(hass, graphite.DOMAIN, {'graphite': {}})`.",
            "Step 6: For tests that rely on side effects (event bus listeners, services, state changes), confirm that the behavior is still exercised through setup_component by asserting that listeners are registered or services are available, rather than relying on internal calls.",
            "Step 7: Re-run the test suite and address any remaining failures by comparing the test configs to the current component config validation logic (e.g., voluptuous schemas).",
            "Step 8: When a component's config schema changes in the future, update both the component's docs and all related tests simultaneously to keep them consistent."
        ]
    }
}