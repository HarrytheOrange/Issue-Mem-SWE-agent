{
    "search_index": {
        "description_for_embedding": "Home Assistant HTTP component: add support for configuring an explicit API base URL. Previously the API base URL host was derived from the server_host binding or the machine's local IP, which is wrong or inconvenient when binding to 0.0.0.0, using reverse proxies, or needing a stable external URL. The fix introduces a new `base_url` config option with precedence over `server_host` and local IP, updates hass.config.api initialization, and adds tests verifying correct `base_url` selection.",
        "keywords": [
            "home-assistant",
            "http component",
            "base_url",
            "api base url",
            "remote API",
            "network configuration",
            "server_host",
            "get_local_ip",
            "binding 0.0.0.0",
            "reverse proxy",
            "hass.config.api",
            "rem.API"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this change set, the Home Assistant HTTP component gained the ability to explicitly configure the base URL used by the internal API client (`hass.config.api`). Before this change, the code in `homeassistant/components/http/__init__.py` determined the API host as `server_host` unless it was `0.0.0.0`, in which case it used `get_local_ip()` from `homeassistant.util`. This meant the derived API base URL could be incorrect or undesirable in several situations: when binding to `0.0.0.0`, when Home Assistant is behind a reverse proxy, or when an external, stable URL is needed for webhooks and integrations. \n\nThe fix introduces a new configuration option `base_url` (constant `CONF_BASE_URL`) into the HTTP component's config schema. The logic for selecting the host for `hass.config.api` is updated as follows:\n- Read `host = conf.get(CONF_BASE_URL)`.\n- If `base_url` is set, use it directly as the host.\n- Else, if `server_host` is not the default `0.0.0.0`, use `server_host`.\n- Else, fall back to `hass_util.get_local_ip()`.\n\nThe module import was changed from `from homeassistant.util import get_local_ip` to `import homeassistant.util as hass_util`, and the code now calls `hass_util.get_local_ip()`.\n\n`hass.config.api` is then initialized with `rem.API(host, api_password, server_port, ssl_certificate is not None)`, and `rem.API` is responsible for composing `base_url` (e.g., `http://<host>:<port>`).\n\nNew tests were added in `tests/components/http/test_init.py` using a `MagicMock` Home Assistant instance and the event loop. The `test_api_base_url` test verifies several scenarios:\n- When `http: { base_url: 'example.com' }` is configured, `hass.config.api.base_url` becomes `http://example.com:8123`.\n- When only `server_host: '1.1.1.1'` is configured, `hass.config.api.base_url` is `http://1.1.1.1:8123`.\n- Reconfiguring with the same `server_host` yields the same base URL, showing consistent behavior.\n- When neither `base_url` nor `server_host` is set, `hass.config.api.base_url` falls back to `http://127.0.0.1:8123` (the value from `get_local_ip()` in the test environment).\n\nThis change resolves the limitation that the API base URL could not be explicitly set and could default to unsuitable values.",
        "semantic_memory": "This fix illustrates a common pattern in networked applications: the address you bind to (e.g., `0.0.0.0`) is often not the address that should be advertised or used as the public base URL for clients. To handle cases like reverse proxies, NAT, or multiple interfaces, systems should allow an explicit configuration for the externally visible base URL and implement clear precedence rules.\n\nKey generalizable lessons:\n- **Separate bind address from public base URL:** The address and port that a server socket listens on are often implementation details. Clients usually need a stable, externally accessible URL, which may differ from the bind address. Provide configuration options that allow overriding the derived URL.\n- **Configuration precedence:** When deriving a base URL, use a prioritized chain of sources: an explicit configuration (like `base_url`), then a more general host option (`server_host`), and finally an auto-detected value (like local IP). This avoids surprising behavior while still working out-of-the-box.\n- **Avoid advertising wildcard addresses:** Values like `0.0.0.0` or `::` are valid bind addresses but invalid or meaningless as client-facing URLs. Logic that derives URLs must guard against using these directly.\n- **Use configuration validation schemas:** Adding new options (like `base_url`) to a component should go through a validation layer (e.g., voluptuous schemas) to keep configuration consistent and to surface invalid values early.\n- **Unit-test configuration-driven behavior:** When the behavior of a component depends on configuration inputs, add explicit tests to confirm the selection logic and precedence. This is especially important for network addresses and URLs, which are prone to environment-specific bugs.\n- **Encapsulate URL construction:** Central API objects (like `rem.API`) that expose a `base_url` help centralize URL construction and make it easier to change how the base URL is derived without touching all callers.",
        "procedural_memory": [
            "When facing issues with incorrect or inconvenient API base URLs in a service, implement a configurable base URL with a clear precedence over auto-detected values.",
            "Step 1: Identify how the base URL is currently derived.",
            "Inspect the code path where the API client or configuration object constructs or stores its `base_url`. Determine whether it uses the server bind address, local IP discovery, or hard-coded defaults.",
            "Step 2: Determine required behavior and precedence.",
            "Decide on a clear precedence order for base URL selection, for example: (1) explicit base_url config, (2) configured host/server_host, (3) auto-detected local IP, (4) fallback default. Make sure wildcard bind addresses like `0.0.0.0` are never used directly as public URLs.",
            "Step 3: Add a configuration option for the base URL.",
            "Introduce a new configuration key (e.g., `base_url`) into the component's schema or configuration system. Ensure it is validated as a string or URL, and document it. For Python/voluptuous setups, add `vol.Optional(CONF_BASE_URL): cv.string` or a more strict URL validator.",
            "Step 4: Implement the host/base URL selection logic.",
            "Replace any simplistic host selection logic with the precedence rules. For example: `host = conf.get('base_url') or (server_host if server_host != '0.0.0.0' else get_local_ip())`. Ensure that you import or reference utility functions consistently (e.g., import the module and call `hass_util.get_local_ip()` rather than importing the function directly if that matches project conventions).",
            "Step 5: Wire the selected host into your API client object.",
            "Pass the chosen host (or full base URL, depending on your API object) into the API client initialization. If your API client builds `base_url` internally from host and port, ensure you pass the correct parameters and that TLS/SSL flags are handled (for example, toggling between `http` and `https`).",
            "Step 6: Write tests to cover configuration combinations.",
            "Create tests that initialize the component with different configurations and assert on the resulting `base_url`. Cover cases: explicit `base_url` set, only `server_host` set, both omitted, and edge cases like `server_host` set to `0.0.0.0` or `::`. Use mocks or test helpers to simulate the app context if needed.",
            "Step 7: Validate behavior in real environments.",
            "Run the service with various configurations: behind a reverse proxy, with `server_host` bound to `0.0.0.0`, and with/without `base_url`. Confirm that generated links, callbacks, and external integrations use the desired public URL.",
            "Step 8: Document the new option and migration path.",
            "Update user-facing documentation to explain when and why to use `base_url` (e.g., when the automatically detected URL is wrong, or when running behind a proxy). If there was a previous behavior that users relied on, note any changes and how to replicate old behavior with the new configuration."
        ]
    }
}