{
    "search_index": {
        "description_for_embedding": "Home Assistant Glances sensor was failing setup if the Glances endpoint was unreachable at Home Assistant startup, treating connection issues as fatal errors. The fix changes these to warnings so the platform can still be set up and will update once the endpoint is available. Additionally, CPU temperature monitoring support was added by introducing a new 'cpu_temp' resource that reads from the Glances sensors list.",
        "keywords": [
            "home-assistant",
            "glances",
            "sensor",
            "cpu_temp",
            "CPU temperature",
            "REST endpoint",
            "connection error",
            "startup dependency",
            "integration initialization",
            "graceful degradation"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this Home Assistant PR, the Glances sensor integration had two main issues/needs. First, the platform setup (`setup_platform`) would return `False` and abort initialization if the Glances REST endpoint either returned a non-OK HTTP status or was unreachable (raised `requests.exceptions.ConnectionError`). That meant Home Assistant required the monitored system (running Glances) to be up and reachable at HA startup, which is undesirable for external systems that may be off or booting slowly. The code logged these conditions as errors and refused to create the sensors. Second, there was a feature request to expose CPU temperature via the Glances integration.\n\nThe fix made the Glances integration more tolerant of temporary endpoint failures by changing error handling during setup and update:\n- In `setup_platform`, after issuing a `requests.get(url, timeout=10)`, if `response.ok` was false, the code now logs a warning (`_LOGGER.warning(\"Response status is '%s'\", response.status_code)`) instead of an error and does **not** return `False`. Similarly, if a `ConnectionError` occurs, it logs a warning (`\"No route to resource/endpoint\"`) instead of an error and again does not abort platform setup. This allows Home Assistant to start and the Glances sensors to be created even when the remote endpoint is not yet available; the sensors will be populated when the endpoint becomes reachable on subsequent updates.\n- In `GlancesData.update`, where the integration periodically fetches data, a `ConnectionError` is now logged as a warning (`\"Error connecting to resource\"`) instead of an error, and `self.data` is set to `None`. This indicates a transient connectivity problem without treating it as a fatal failure.\n\nFor the new functionality, CPU temperature monitoring was added by extending the `SENSOR_TYPES` mapping with a new entry `'cpu_temp': ['CPU Temp', '°']`. In the `state` property of `GlancesSensor`, a new branch for `self.type == 'cpu_temp'` iterates over `value['sensors']` and returns the `sensor['value']` for the first item whose `label` is `'CPU'`. If no such sensor is found, it returns `None`. This exposes CPU temperature as a selectable Glances resource in Home Assistant.\n\nOverall, the change both enhanced the integration with CPU temperature monitoring and improved robustness by ensuring that an unavailable Glances endpoint at startup does not block Home Assistant from coming up.",
        "semantic_memory": "This change illustrates two generalizable patterns for integrations with external services:\n\n1. **Don’t hard-fail platform setup on transient connectivity issues.** When an integration depends on an external service or device (e.g., a REST API, remote host, or hardware that may be powered off), treating initial connection problems as fatal errors can prevent the host application from starting or make the integration unusable until manual intervention. Instead, the integration should:\n   - Log connectivity or non-2xx HTTP responses as warnings (or info), not as errors that abort setup.\n   - Proceed with platform/entity setup so that the system can start, and entities can become available once connectivity is restored.\n   - Handle subsequent update failures gracefully by logging and leaving the entity in an unavailable or `None` state, rather than crashing or tearing down the integration.\n\n2. **Extending integrations by mapping new resource types and parsing structured payloads.** To add new metrics like CPU temperature, it’s effective to:\n   - Extend a centralized resource/type mapping (e.g., `SENSOR_TYPES`) to declare new sensor types, human-readable names, and units.\n   - Implement corresponding logic in the state resolution function (`state` property) that understands the shape of the backend’s JSON and extracts the relevant value.\n   - Safely handle missing or unexpected fields by returning `None` rather than throwing exceptions, ensuring robustness against changes in the external service.\n\nMore broadly, integrations should be designed for **graceful degradation**: the core app should not be tightly coupled to external resource availability, and log severity should reflect whether an issue is transient/expected (warning) versus a programming/configuration error (error).",
        "procedural_memory": [
            "When working on an integration that depends on an external REST endpoint or device, ensure that startup does not hard-require immediate connectivity. Treat connection issues as expected transient failures rather than fatal errors.",
            "Step 1: Identify where the integration validates external connectivity during setup (e.g., in a `setup` or `setup_platform`/`async_setup_entry` function). Look for code that performs immediate HTTP requests or device discovery.",
            "Step 2: Check if non-OK responses or exceptions (e.g., `requests.exceptions.ConnectionError`, timeouts) trigger a hard failure (e.g., `return False`, raising exceptions, or preventing entity creation). If so, this likely causes the platform to fail when the external endpoint is temporarily unavailable.",
            "Step 3: Change the behavior for transient connectivity issues so that the integration logs a warning but does not abort setup. For example:\n- Log with `_LOGGER.warning(...)` instead of `_LOGGER.error(...)`.\n- Remove or avoid early `return False` / exceptions in response to HTTP non-2xx or connection errors.\n- Allow the integration/platform to complete setup even if the first connectivity check fails.",
            "Step 4: Ensure the update loop handles connectivity failures gracefully. In the periodic update method (e.g., `update()` or `async_update()`):\n- Catch connection-related exceptions.\n- Log them as warnings indicating temporary unavailability.\n- Set internal data to `None` or otherwise mark entities as unavailable, rather than raising errors or crashing.",
            "Step 5: If adding a new metric (such as CPU temperature) from an external API:\n- Extend the type/resource mapping (e.g., `SENSOR_TYPES` or similar) with a new key for the metric, including a friendly name and appropriate unit.\n- In the entity’s `state` (or equivalent) method, implement extraction logic for the new type based on the structure of the response data (e.g., iterate over a list of sensors, filter by label, and return the value).",
            "Step 6: Make the extraction logic robust:\n- Guard against missing keys (e.g., missing `sensors` list, missing `label` or `value` fields).\n- Return `None` when the metric is not found rather than raising an exception, so the entity simply shows no data instead of breaking.",
            "Step 7: Test the integration under different conditions:\n- Start the host application with the external endpoint offline and verify that the integration initializes and the application fully boots.\n- Bring the external endpoint online and verify that subsequent updates populate sensor states correctly.\n- Test non-2xx HTTP responses and connection drops to confirm they result in warnings, not crashes or permanent failure.",
            "Step 8: Update documentation and examples to show how to configure and use any new metrics (e.g., adding `cpu_temp` to the list of supported `resources` in configuration examples)."
        ]
    }
}