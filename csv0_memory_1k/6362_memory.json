{
    "search_index": {
        "description_for_embedding": "Home Assistant media_player platforms (Apple TV and Kodi) were using the old async_add_entities pattern and incorrectly awaiting the add callback. The fix renames the callback parameter to async_add_devices and calls it directly (no yield from), aligning with the new async_add_devices convention and avoiding misuse of a non-coroutine callback.",
        "keywords": [
            "Home Assistant",
            "media_player",
            "apple_tv",
            "kodi",
            "async_add_devices",
            "async_add_entities",
            "async_setup_platform",
            "coroutine misuse",
            "yield from non-coroutine",
            "callback signature",
            "entity_component",
            "update_before_add"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this pull request, two Home Assistant media_player platforms (Apple TV and Kodi) were updated to match a newer async API pattern. Previously, their async_setup_platform functions accepted a parameter named async_add_entities and invoked it with 'yield from', implying it was a coroutine. However, the framework had standardized on a callback named async_add_devices for platform setup, and this callback is not meant to be awaited—it schedules entity addition rather than being an awaitable coroutine. This mismatch risked confusion and potential runtime issues if the helper was not a coroutine. The fix was to (1) rename the async_setup_platform parameter from async_add_entities to async_add_devices, and (2) stop yielding from the callback, instead calling async_add_devices([...]) directly. For the Kodi platform, the fix preserved the update_before_add=True argument while removing 'yield from'. This aligned these integrations with the rest of the codebase and the expected async API semantics.",
        "semantic_memory": "When designing async integration APIs, naming and usage of callbacks must remain consistent across the ecosystem. In Home Assistant’s async platform setup, the framework passes a callback (e.g., async_add_devices) that schedules entities to be added. Even though this callback participates in an asynchronous flow, it is not necessarily a coroutine and typically should not be awaited with 'await' or 'yield from'. Treating such a callback as a coroutine can lead to subtle bugs (e.g., attempting to await a regular function, or misinterpreting its return value). Consistency in callback naming (async_add_devices vs async_schedule_add_entities) greatly affects discoverability for new developers: they need to be able to search for the function by name to understand its parameters (like update_before_add). Renaming parameters in integrations to match the shared API and removing incorrect 'yield from' usage are important refactors that prevent misuse and improve developer experience. More generally, an async framework often uses callbacks that are called synchronously but have asynchronous effects; developers must understand which functions are actual coroutines and which are just scheduling or registration hooks.",
        "procedural_memory": [
            "When you see async setup functions using framework-provided callbacks (like entity-add callbacks), verify whether those callbacks are true coroutines or synchronous scheduling functions.",
            "Step 1: Identify the framework contract. Find the definition of the callback being passed in (e.g., in Home Assistant, look up helpers/entity_component.py for async_add_* or async_schedule_add_* functions). Confirm its name, intended usage, and whether it is awaitable.",
            "Step 2: Search for inconsistent usage. Grep the codebase for older names (e.g., async_add_entities) or for patterns like 'yield from async_add_*' or 'await async_add_*'. Flag any locations where the usage does not match the current API contract.",
            "Step 3: Align parameter names with the framework. In integration setup functions (async_setup_platform or equivalents), rename the callback parameter to match the standard name used by the framework (e.g., async_add_devices). This improves searchability and documentation alignment.",
            "Step 4: Fix incorrect awaiting of callbacks. If the callback is documented as a regular function that schedules work (not a coroutine), remove 'yield from' or 'await' when calling it. Call it directly: async_add_devices(entities, update_before_add=True) instead of 'yield from async_add_devices(...)'.",
            "Step 5: Preserve functional arguments. When changing the call site, ensure all behavioral flags (e.g., update_before_add=True) are preserved so behavior (like initial state refresh) does not regress.",
            "Step 6: Run tests and validate at runtime. For Home Assistant, load the affected integrations, verify they set up correctly without runtime warnings or TypeErrors, and confirm entities are created and updated as expected.",
            "Step 7: Consider bulk refactoring. If many integrations are using legacy names or patterns, plan a global sed/refactoring pass to standardize naming and usage across the codebase, with deprecation or migration notes as needed."
        ]
    }
}