{
    "search_index": {
        "description_for_embedding": "Home Assistant Genius Hub (geniushub) integration enhancement: add hvac_action support for climate entities when using the v3 API. Uses zone _state flags (bIsActive, bOutRequestHeat) to expose CURRENT_HVAC_OFF, CURRENT_HVAC_IDLE, or CURRENT_HVAC_HEAT. Falls back to None for older v1 API zones.",
        "keywords": [
            "Home Assistant",
            "geniushub",
            "Genius Hub",
            "climate",
            "hvac_action",
            "CURRENT_HVAC_HEAT",
            "CURRENT_HVAC_IDLE",
            "CURRENT_HVAC_OFF",
            "v3 API",
            "zone _state",
            "bIsActive",
            "bOutRequestHeat",
            "integration enhancement",
            "feature addition"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In the Home Assistant Genius Hub integration, climate entities did not expose the hvac_action attribute, even though the v3 Genius Hub API provides enough state to know whether a zone is actually requesting heat. The maintainer added hvac_action support specifically for v3 API zones.\n\nThe initial attempt added hvac_action and debug logging inside homeassistant/components/geniushub/__init__.py and merged _state into the device_state_attributes. This was then rolled back as 'unwanted changes'. The final solution confined the hvac_action implementation to the climate platform only.\n\nSpecifically, in homeassistant/components/geniushub/climate.py, the ClimateDevice subclass now imports CURRENT_HVAC_HEAT, CURRENT_HVAC_IDLE, and CURRENT_HVAC_OFF. A new hvac_action property checks if \"_state\" exists in self._zone.data (indicating v3 API). For v3 zones:\n- If bIsActive is false, hvac_action returns CURRENT_HVAC_OFF.\n- Else, if bOutRequestHeat is true, hvac_action returns CURRENT_HVAC_HEAT.\n- Otherwise, it returns CURRENT_HVAC_IDLE.\n\nIf the \"_state\" key is absent (e.g., v1 API), hvac_action returns None to indicate that this information is not available. Any debug logging and the injection of _state into the status attributes were removed in the final patch to keep the change minimal and focused.",
        "semantic_memory": "This fix illustrates how to properly expose richer device state in a Home Assistant integration when the backend API supports it.\n\nKey concepts and patterns:\n1. **Feature-gated behavior based on API version/capability**: The integration checks for the presence of a specific field (\"_state\") to determine whether an advanced feature (hvac_action) is supported. Instead of relying on explicit version numbers, it uses a capability-style check: if a given key exists and has expected structure, the feature is enabled.\n\n2. **Mapping backend-specific flags to standard Home Assistant constants**: Internal API flags (bIsActive, bOutRequestHeat) are mapped to HA-standard constants (CURRENT_HVAC_OFF, CURRENT_HVAC_IDLE, CURRENT_HVAC_HEAT). This decouples the frontend (HA UI, automations) from vendor-specific semantics and ensures consistency across integrations.\n\n3. **Graceful degradation for older or less capable APIs**: When the backing API or data structure doesn’t expose the needed information (absence of \"_state\"), the property returns None instead of guessing or throwing an error. This pattern is important for maintaining compatibility and avoiding noisy logs or crashes.\n\n4. **Scoping changes to the correct platform layer**: The initial approach modified core integration code (__init__.py) and added debug logging plus extra attributes. The final design kept the enhancement local to the climate entity (climate.py), where hvac_action conceptually belongs. This reduces unintended side effects and keeps responsibilities clear.\n\n5. **Avoiding debug/test artifacts in production code**: Early development added _LOGGER.warn calls and extra attributes to inspect state. These were removed before finalizing the change, showing the best practice of stripping debug instrumentation from the merged code unless it provides long-term diagnostic value.",
        "procedural_memory": [
            "When enhancing a Home Assistant integration to expose new state (like hvac_action), start by understanding what the backend API provides and which entities should surface that state.",
            "Step 1: Inspect the backend API and integration data model.\n- Review the vendor API documentation (e.g., Genius Hub v3) and identify fields that indicate device activity, e.g., bIsActive, bOutRequestHeat.\n- Inspect how these fields are exposed in the integration’s data structures (e.g., self._zone.data[\"_state\"]).\n- Verify which API versions provide these fields so you can conditionally support them.",
            "Step 2: Determine the appropriate Home Assistant abstraction.\n- Map vendor-specific flags to Home Assistant’s standardized constants (e.g., CURRENT_HVAC_HEAT, CURRENT_HVAC_IDLE, CURRENT_HVAC_OFF from homeassistant.components.climate.const).\n- Decide which entity type is responsible for the new attribute (for hvac_action, this is the Climate entity).",
            "Step 3: Implement a capability-aware property.\n- In the relevant entity class (e.g., a ClimateDevice subclass), add a @property def hvac_action(self) method.\n- Guard the logic with a capability check: for example, if \"_state\" in self._zone.data.\n- Inside the guard, translate raw state into HA constants. For example:\n  - if not state.get(\"bIsActive\"): return CURRENT_HVAC_OFF\n  - elif state.get(\"bOutRequestHeat\"): return CURRENT_HVAC_HEAT\n  - else: return CURRENT_HVAC_IDLE\n- If the capability is not present, return None to indicate that hvac_action is unsupported for that entity.",
            "Step 4: Keep changes localized and avoid polluting other layers.\n- Do not modify integration-wide attributes or __init__.py unless strictly necessary.\n- Avoid injecting low-level state (like the entire _state dict) into generic device_state_attributes unless there is a clear, documented use case.\n- Ensure that any new logs are appropriate; remove temporary debug logging (e.g., _LOGGER.warn) before merging.",
            "Step 5: Test across different API versions or configurations.\n- Test with a system using the newer API (e.g., v3) to confirm hvac_action reports OFF/IDLE/HEAT correctly.\n- Test with a system using the older API (e.g., v1) to ensure hvac_action cleanly returns None and no exceptions occur due to missing keys.\n- Run the integration’s tests (e.g., tox, pytest) and add/adjust tests to cover the new attribute behavior if possible.",
            "Step 6: Validate backward compatibility and UI behavior.\n- Confirm that existing automations and dashboards function unchanged when hvac_action is None.\n- Optionally, update documentation to explain under which conditions hvac_action is available and what each state means.",
            "Step 7: Code review and cleanup before merge.\n- Remove leftover debug or experimental code (extra logs, commented-out code, unnecessary attribute exposure).\n- Ensure imports are minimal and only include the constants needed (e.g., CURRENT_HVAC_*)."
        ]
    }
}