{
    "search_index": {
        "description_for_embedding": "Fix for napari on macOS Big Sur with Python 3.9 where the Qt GUI failed to start unless QT_MAC_WANTS_LAYER was set. The PR adds explicit macOS version guards (_MACOS_AT_LEAST_CATALINA and _MACOS_AT_LEAST_BIG_SUR) and sets the QT_MAC_WANTS_LAYER environment variable on Big Sur, while still using pythonw on Catalina+ when running under conda without PYTHONEXECUTABLE.",
        "keywords": [
            "macOS Big Sur",
            "Catalina",
            "Python 3.9",
            "QT_MAC_WANTS_LAYER",
            "Qt",
            "GUI startup",
            "pythonw",
            "conda",
            "napari __main__",
            "platform.release",
            "StrictVersion",
            "environment variable",
            "macOS version detection",
            "Darwin 20",
            "Big Sur rendering bug"
        ]
    },
    "agent_memory": {
        "episodic_memory": "In this incident, napari had a startup bug on macOS Big Sur (Darwin 20.x) when running with Python 3.9, particularly in conda environments. The GUI (Qt) either failed to start correctly or behaved incorrectly unless the environment variable QT_MAC_WANTS_LAYER was set. The existing code had a single flag, _MACOS_LATEST, defined as `sys.platform == 'darwin' and StrictVersion(platform.release()) > StrictVersion('19.0.0')`. This condition is true not only for Big Sur but also for macOS Catalina and newer, so it was too coarse-grained.\n\nThe PR introduces two separate flags: `_MACOS_AT_LEAST_CATALINA` for Darwin > 19.0.0 and `_MACOS_AT_LEAST_BIG_SUR` for Darwin > 20.0.0. The Big Surâ€“specific workaround (setting `os.environ['QT_MAC_WANTS_LAYER'] = '1'`) is guarded by `_MACOS_AT_LEAST_BIG_SUR`, ensuring the Qt-specific fix is only applied on Big Sur and above. Meanwhile, the existing conda + pythonw logic (finding and using `pythonw` when running under conda without PYTHONEXECUTABLE) is guarded by `_MACOS_AT_LEAST_CATALINA` so that it still applies to Catalina and later versions.\n\nConcretely, in `napari/__main__.py` the code now:\n- Detects `_MACOS_AT_LEAST_CATALINA` and `_MACOS_AT_LEAST_BIG_SUR` using `platform.release()` and `StrictVersion`.\n- Defines `_RUNNING_CONDA` (presence of CONDA_PREFIX) and `_RUNNING_PYTHONW` (presence of PYTHONEXECUTABLE).\n- For Big Sur and later, sets `QT_MAC_WANTS_LAYER` before any Qt usage or pythonw handoff.\n- For Catalina and later, under conda and when not already running under pythonw, looks up `<sys.exec_prefix>/bin/pythonw` and uses it to re-launch the process.\n\nThis change resolves the Big Sur + Python 3.9 Qt startup issue while keeping the existing Catalina+ conda/pythonw workaround intact and better naming/version scoping of macOS flags.",
        "semantic_memory": "This fix illustrates several generalizable patterns for cross-platform GUI applications, especially on macOS:\n\n1. **Version-specific behavior on macOS:** GUI toolkits like Qt sometimes require special environment variables or flags on specific macOS versions (e.g., QT_MAC_WANTS_LAYER on Big Sur) to work around OS-level changes. It is safer to gate such workarounds on explicit OS version checks instead of a generic 'latest macOS' flag.\n\n2. **Fine-grained OS version flags:** A single boolean like `_MACOS_LATEST` can easily become ambiguous as OS versions evolve. Using descriptive and version-specific flags (`_MACOS_AT_LEAST_CATALINA`, `_MACOS_AT_LEAST_BIG_SUR`) improves clarity and allows different workarounds to be targeted appropriately.\n\n3. **Environment variables must be set early:** For GUI frameworks, environment variables that influence rendering or platform integration (like QT_MAC_WANTS_LAYER) must be set before the GUI toolkit is initialized or before a re-launch via an alternative executable (like pythonw). Setting them as early as possible in `__main__` avoids subtle issues.\n\n4. **Conda and pythonw on macOS:** On macOS, especially in conda environments, launching GUI apps via `pythonw` rather than `python` can be necessary to get a functioning GUI. Detecting conda (via CONDA_PREFIX) and whether the app is already under `pythonw` (via PYTHONEXECUTABLE) allows the app to re-launch itself under the appropriate interpreter only when needed.\n\n5. **Using Darwin version for macOS detection:** `platform.release()` returns the Darwin kernel version, which can be mapped to macOS versions (e.g., 19.x for Catalina, 20.x for Big Sur). Comparing these via `StrictVersion` enables programmatic version-based branching when the higher-level `platform.mac_ver()` is not used.\n\nOverall, the lesson is to manage OS- and environment-specific workarounds explicitly, with well-named flags and well-placed environment configuration, rather than relying on generic or loosely defined checks.",
        "procedural_memory": [
            "Step-by-step instructions on how to diagnose and fix similar issues.",
            "Step 1: Reproduce and characterize the problem\n- Run the GUI application on the target macOS version (e.g., Big Sur) and Python version (e.g., 3.9), preferably inside the same environment type (conda/venv) as users.\n- Observe startup behavior: does the GUI fail to appear, crash, or display rendering issues?\n- Check logs and console output for Qt or OS-specific warnings, especially about layers, displays, or window systems.",
            "Step 2: Identify OS version and environment characteristics\n- Use `import platform, sys, os` and log:\n  - `platform.system()` and `sys.platform` (confirm 'Darwin' / 'darwin').\n  - `platform.release()` to get the Darwin kernel version.\n  - Presence of environment variables like `CONDA_PREFIX` (for conda), `PYTHONEXECUTABLE` (for pythonw), and GUI-related vars like `QT_MAC_WANTS_LAYER`.\n- Map the Darwin version to a macOS version (e.g., 19.x = Catalina, 20.x = Big Sur).",
            "Step 3: Check toolkit documentation and known issues\n- Consult the GUI toolkit documentation (e.g., Qt for Python / PyQt / PySide) and issue trackers for macOS version-specific bugs and required environment variables (e.g., QT_MAC_WANTS_LAYER on Big Sur).\n- Search for your macOS version + toolkit + 'layer', 'render', or 'crash' to discover documented workarounds.",
            "Step 4: Implement explicit version flags\n- In a central startup module (like `__main__.py`), define clear version-based flags using `platform.release()`:\n  - Example:\n    - `_MACOS_AT_LEAST_CATALINA = sys.platform == 'darwin' and StrictVersion(platform.release()) > StrictVersion('19.0.0')`\n    - `_MACOS_AT_LEAST_BIG_SUR = sys.platform == 'darwin' and StrictVersion(platform.release()) > StrictVersion('20.0.0')`\n- Use descriptive names tied to concrete OS versions instead of generic names like `_MACOS_LATEST`.",
            "Step 5: Set environment variables early\n- Immediately after computing the OS flags and before any GUI initialization, apply version-specific environment settings:\n  - For example, on Big Sur:\n    - `if _MACOS_AT_LEAST_BIG_SUR: os.environ['QT_MAC_WANTS_LAYER'] = '1'`\n- Ensure this happens before importing or instantiating Qt widgets or QApplication so the toolkit sees the variable at startup.",
            "Step 6: Handle interpreter quirks (e.g., pythonw) by environment detection\n- Determine if you are running under conda or another environment that may require an alternate interpreter:\n  - `_RUNNING_CONDA = 'CONDA_PREFIX' in os.environ`\n  - `_RUNNING_PYTHONW = 'PYTHONEXECUTABLE' in os.environ`\n- For affected macOS versions (e.g., Catalina+), and when under conda but not already under pythonw, locate and re-launch via pythonw:\n  - `python_path = Path(sys.exec_prefix) / 'bin' / 'pythonw'`\n  - If `python_path.exists()`, re-exec the process using that executable with the same arguments.",
            "Step 7: Guard workarounds to the minimal scope\n- Only apply each workaround for the OS versions where it is known to be needed to avoid unintended side effects on older or newer versions.\n- Example: apply QT_MAC_WANTS_LAYER only on `_MACOS_AT_LEAST_BIG_SUR`, but keep pythonw logic on `_MACOS_AT_LEAST_CATALINA` and above.\n- This keeps behavior correct as new macOS versions are released.",
            "Step 8: Test across OS and configuration matrix\n- Test the application on:\n  - macOS versions just below and above your thresholds (e.g., Mojave, Catalina, Big Sur).\n  - Different environments: conda, system Python, virtualenv, with/without pythonw, and with different Python versions.\n- Confirm that:\n  - The GUI starts and renders correctly.\n  - The environment variable (e.g., QT_MAC_WANTS_LAYER) is set when expected.\n  - The app does not unnecessarily relaunch under pythonw when already in a correct context.",
            "Step 9: Document the behavior and rationale\n- Add comments near the version flags and environment setup explaining why they exist and linking to issues or external references.\n- Include references to relevant issues (e.g., GitHub issues, Qt bug reports) so future maintainers know when and why to revisit or remove the workaround.",
            "Step 10: Monitor for upstream fixes and OS changes\n- Periodically check if the GUI toolkit or OS updates obviate the workaround.\n- Once confirmed, consider narrowing or removing the version-specific code, but only after re-testing on the affected macOS versions."
        ]
    }
}